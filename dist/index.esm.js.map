{"version":3,"file":"index.esm.js","sources":["../lib/schemas/config.js","../lib/envs.js","../lib/logger.js","../lib/utils.js","../lib/config.js","../lib/fetch.js","../lib/errors/ExportError.js","../lib/cache.js","../lib/highcharts.js","../lib/browser.js","../lib/export.js","../templates/svg_export/svg_export.js","../lib/pool.js","../lib/chart.js","../lib/sanitize.js","../lib/intervals.js","../lib/server/error.js","../lib/server/rate_limit.js","../lib/errors/HttpError.js","../lib/server/routes/change_hc_version.js","../lib/server/routes/export.js","../lib/server/routes/health.js","../lib/server/server.js","../lib/server/routes/ui.js","../lib/resource_release.js","../lib/index.js"],"sourcesContent":["/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n// Possible names for Highcharts scripts\r\nexport const scriptsNames = {\r\n  core: ['highcharts', 'highcharts-more', 'highcharts-3d'],\r\n  modules: [\r\n    'stock',\r\n    'map',\r\n    'gantt',\r\n    'exporting',\r\n    'parallel-coordinates',\r\n    'accessibility',\r\n    // 'annotations-advanced',\r\n    'boost-canvas',\r\n    'boost',\r\n    'data',\r\n    'data-tools',\r\n    'draggable-points',\r\n    'static-scale',\r\n    'broken-axis',\r\n    'heatmap',\r\n    'tilemap',\r\n    'tiledwebmap',\r\n    'timeline',\r\n    'treemap',\r\n    'treegraph',\r\n    'item-series',\r\n    'drilldown',\r\n    'histogram-bellcurve',\r\n    'bullet',\r\n    'funnel',\r\n    'funnel3d',\r\n    'geoheatmap',\r\n    'pyramid3d',\r\n    'networkgraph',\r\n    'overlapping-datalabels',\r\n    'pareto',\r\n    'pattern-fill',\r\n    'pictorial',\r\n    'price-indicator',\r\n    'sankey',\r\n    'arc-diagram',\r\n    'dependency-wheel',\r\n    'series-label',\r\n    'series-on-point',\r\n    'solid-gauge',\r\n    'sonification',\r\n    // 'stock-tools',\r\n    'streamgraph',\r\n    'sunburst',\r\n    'variable-pie',\r\n    'variwide',\r\n    'vector',\r\n    'venn',\r\n    'windbarb',\r\n    'wordcloud',\r\n    'xrange',\r\n    'no-data-to-display',\r\n    'drag-panes',\r\n    'debugger',\r\n    'dumbbell',\r\n    'lollipop',\r\n    'cylinder',\r\n    'organization',\r\n    'dotplot',\r\n    'marker-clusters',\r\n    'hollowcandlestick',\r\n    'heikinashi',\r\n    'flowmap',\r\n    'export-data',\r\n    'navigator',\r\n    'textpath'\r\n  ],\r\n  indicators: ['indicators-all'],\r\n  custom: [\r\n    'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js',\r\n    'https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js'\r\n  ]\r\n};\r\n\r\n// This is the configuration object with all options and their default values,\r\n// also from the .env file if one exists\r\nexport const defaultConfig = {\r\n  puppeteer: {\r\n    args: {\r\n      value: [\r\n        '--allow-running-insecure-content',\r\n        '--ash-no-nudges',\r\n        '--autoplay-policy=user-gesture-required',\r\n        '--block-new-web-contents',\r\n        '--disable-accelerated-2d-canvas',\r\n        '--disable-background-networking',\r\n        '--disable-background-timer-throttling',\r\n        '--disable-backgrounding-occluded-windows',\r\n        '--disable-breakpad',\r\n        '--disable-checker-imaging',\r\n        '--disable-client-side-phishing-detection',\r\n        '--disable-component-extensions-with-background-pages',\r\n        '--disable-component-update',\r\n        '--disable-default-apps',\r\n        '--disable-dev-shm-usage',\r\n        '--disable-domain-reliability',\r\n        '--disable-extensions',\r\n        '--disable-features=CalculateNativeWinOcclusion,InterestFeedContentSuggestions,WebOTP',\r\n        '--disable-hang-monitor',\r\n        '--disable-ipc-flooding-protection',\r\n        '--disable-logging',\r\n        '--disable-notifications',\r\n        '--disable-offer-store-unmasked-wallet-cards',\r\n        '--disable-popup-blocking',\r\n        '--disable-print-preview',\r\n        '--disable-prompt-on-repost',\r\n        '--disable-renderer-backgrounding',\r\n        '--disable-search-engine-choice-screen',\r\n        '--disable-session-crashed-bubble',\r\n        '--disable-setuid-sandbox',\r\n        '--disable-site-isolation-trials',\r\n        '--disable-speech-api',\r\n        '--disable-sync',\r\n        '--enable-unsafe-webgpu',\r\n        '--hide-crash-restore-bubble',\r\n        '--hide-scrollbars',\r\n        '--metrics-recording-only',\r\n        '--mute-audio',\r\n        '--no-default-browser-check',\r\n        '--no-first-run',\r\n        '--no-pings',\r\n        '--no-sandbox',\r\n        '--no-startup-window',\r\n        '--no-zygote',\r\n        '--password-store=basic',\r\n        '--process-per-tab',\r\n        '--use-mock-keychain'\r\n      ],\r\n      type: 'string[]',\r\n      description: 'Arguments array to send to Puppeteer.'\r\n    },\r\n    tempDir: {\r\n      value: './tmp/',\r\n      type: 'string',\r\n      envLink: 'PUPPETEER_TEMP_DIR',\r\n      description: 'The directory for Puppeteer to store temporary files.'\r\n    }\r\n  },\r\n  highcharts: {\r\n    version: {\r\n      value: 'latest',\r\n      type: 'string',\r\n      envLink: 'HIGHCHARTS_VERSION',\r\n      description: 'The Highcharts version to be used.'\r\n    },\r\n    cdnURL: {\r\n      value: 'https://code.highcharts.com/',\r\n      type: 'string',\r\n      envLink: 'HIGHCHARTS_CDN_URL',\r\n      description: 'The CDN URL for Highcharts scripts to be used.'\r\n    },\r\n    coreScripts: {\r\n      value: scriptsNames.core,\r\n      type: 'string[]',\r\n      envLink: 'HIGHCHARTS_CORE_SCRIPTS',\r\n      description: 'The core Highcharts scripts to fetch.'\r\n    },\r\n    moduleScripts: {\r\n      value: scriptsNames.modules,\r\n      type: 'string[]',\r\n      envLink: 'HIGHCHARTS_MODULE_SCRIPTS',\r\n      description: 'The modules of Highcharts to fetch.'\r\n    },\r\n    indicatorScripts: {\r\n      value: scriptsNames.indicators,\r\n      type: 'string[]',\r\n      envLink: 'HIGHCHARTS_INDICATOR_SCRIPTS',\r\n      description: 'The indicators of Highcharts to fetch.'\r\n    },\r\n    customScripts: {\r\n      value: scriptsNames.custom,\r\n      type: 'string[]',\r\n      description: 'Additional custom scripts or dependencies to fetch.'\r\n    },\r\n    forceFetch: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'HIGHCHARTS_FORCE_FETCH',\r\n      description:\r\n        'The flag to determine whether to refetch all scripts after each server rerun.'\r\n    },\r\n    cachePath: {\r\n      value: '.cache',\r\n      type: 'string',\r\n      envLink: 'HIGHCHARTS_CACHE_PATH',\r\n      description:\r\n        'The path to the cache directory. It is used to store the Highcharts scripts and custom scripts.'\r\n    }\r\n  },\r\n  export: {\r\n    infile: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'The input file should include a name and a type (json or svg). It must be correctly formatted as a JSON or SVG file.'\r\n    },\r\n    instr: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Input, provided in the form of a stringified JSON or SVG file, will override the --infile option.'\r\n    },\r\n    options: {\r\n      value: false,\r\n      type: 'string',\r\n      description: 'An alias for the --instr option.'\r\n    },\r\n    outfile: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'The output filename along with a type (jpeg, png, pdf, or svg). This will ignore the --type flag.'\r\n    },\r\n    type: {\r\n      value: 'png',\r\n      type: 'string',\r\n      envLink: 'EXPORT_TYPE',\r\n      description: 'The file export format. It can be jpeg, png, pdf, or svg.'\r\n    },\r\n    constr: {\r\n      value: 'chart',\r\n      type: 'string',\r\n      envLink: 'EXPORT_CONSTR',\r\n      description:\r\n        'The constructor to use. Can be chart, stockChart, mapChart, or ganttChart.'\r\n    },\r\n    defaultHeight: {\r\n      value: 400,\r\n      type: 'number',\r\n      envLink: 'EXPORT_DEFAULT_HEIGHT',\r\n      description:\r\n        'the default height of the exported chart. Used when no value is set.'\r\n    },\r\n    defaultWidth: {\r\n      value: 600,\r\n      type: 'number',\r\n      envLink: 'EXPORT_DEFAULT_WIDTH',\r\n      description:\r\n        'The default width of the exported chart. Used when no value is set.'\r\n    },\r\n    defaultScale: {\r\n      value: 1,\r\n      type: 'number',\r\n      envLink: 'EXPORT_DEFAULT_SCALE',\r\n      description:\r\n        'The default scale of the exported chart. Used when no value is set.'\r\n    },\r\n    height: {\r\n      value: false,\r\n      type: 'number',\r\n      description:\r\n        'The height of the exported chart, overriding the option in the chart settings.'\r\n    },\r\n    width: {\r\n      value: false,\r\n      type: 'number',\r\n      description:\r\n        'The width of the exported chart, overriding the option in the chart settings.'\r\n    },\r\n    scale: {\r\n      value: false,\r\n      type: 'number',\r\n      description:\r\n        'The scale of the exported chart, overriding the option in the chart settings. Ranges between 0.1 and 5.0.'\r\n    },\r\n    globalOptions: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Either a stringified JSON or a filename containing options to be passed into the Highcharts.setOptions.'\r\n    },\r\n    themeOptions: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Either a stringified JSON or a filename containing theme options to be passed into the Highcharts.setOptions.'\r\n    },\r\n    batch: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Initiates a batch job with a string containing input/output pairs: \"in=out;in=out;...\".'\r\n    },\r\n    rasterizationTimeout: {\r\n      value: 1500,\r\n      type: 'number',\r\n      envLink: 'EXPORT_RASTERIZATION_TIMEOUT',\r\n      description:\r\n        'The duration in milliseconds to wait for rendering a webpage.'\r\n    }\r\n  },\r\n  customLogic: {\r\n    allowCodeExecution: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'CUSTOM_LOGIC_ALLOW_CODE_EXECUTION',\r\n      description:\r\n        'Controls whether the execution of arbitrary code is allowed during the exporting process.'\r\n    },\r\n    allowFileResources: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'CUSTOM_LOGIC_ALLOW_FILE_RESOURCES',\r\n      description:\r\n        'Controls the ability to inject resources from the filesystem. This setting has no effect when running as a server.'\r\n    },\r\n    customCode: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Custom code to execute before chart initialization. It can be a function, code wrapped within a function, or a filename with the .js extension.'\r\n    },\r\n    callback: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'JavaScript code to run during construction. It can be a function or a filename with the .js extension.'\r\n    },\r\n    resources: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Additional resource in the form of a stringified JSON, which may contain files, js, and css sections.'\r\n    },\r\n    loadConfig: {\r\n      value: false,\r\n      type: 'string',\r\n      legacyName: 'fromFile',\r\n      description: 'A file containing a pre-defined configuration to use.'\r\n    },\r\n    createConfig: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Enables setting options through a prompt and saving them in a provided config file.'\r\n    }\r\n  },\r\n  server: {\r\n    maxUploadSize: {\r\n      value: 3,\r\n      type: 'number',\r\n      envLink: 'SERVER_MAX_UPLOAD_SIZE',\r\n      description: 'The maximum upload size, in MB, for the server.'\r\n    },\r\n    enable: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'SERVER_ENABLE',\r\n      cliName: 'enableServer',\r\n      description:\r\n        'When set to true, the server starts on the local IP address 0.0.0.0.'\r\n    },\r\n    host: {\r\n      value: '0.0.0.0',\r\n      type: 'string',\r\n      envLink: 'SERVER_HOST',\r\n      description:\r\n        'The hostname of the server. Additionally, it starts a server on the provided hostname.'\r\n    },\r\n    port: {\r\n      value: 7801,\r\n      type: 'number',\r\n      envLink: 'SERVER_PORT',\r\n      description: 'The server port when enabled.'\r\n    },\r\n    benchmarking: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'SERVER_BENCHMARKING',\r\n      cliName: 'serverBenchmarking',\r\n      description:\r\n        'Indicates whether to display the duration, in milliseconds, of specific actions that occur on the server while serving a request.'\r\n    },\r\n    proxy: {\r\n      host: {\r\n        value: false,\r\n        type: 'string',\r\n        envLink: 'SERVER_PROXY_HOST',\r\n        cliName: 'proxyHost',\r\n        description: 'The host of the proxy server to use, if it exists.'\r\n      },\r\n      port: {\r\n        value: 8080,\r\n        type: 'number',\r\n        envLink: 'SERVER_PROXY_PORT',\r\n        cliName: 'proxyPort',\r\n        description: 'The port of the proxy server to use, if it exists.'\r\n      },\r\n      username: {\r\n        value: false,\r\n        type: 'string',\r\n        envLink: 'SERVER_PROXY_USERNAME',\r\n        cliName: 'proxyUsername',\r\n        description: 'The username for the proxy server, if it exists.'\r\n      },\r\n      password: {\r\n        value: false,\r\n        type: 'string',\r\n        envLink: 'SERVER_PROXY_PASSWORD',\r\n        cliName: 'proxyPassword',\r\n        description: 'The password for the proxy server, if it exists.'\r\n      },\r\n      timeout: {\r\n        value: 5000,\r\n        type: 'number',\r\n        envLink: 'SERVER_PROXY_TIMEOUT',\r\n        cliName: 'proxyTimeout',\r\n        description: 'The timeout for the proxy server to use, if it exists.'\r\n      }\r\n    },\r\n    rateLimiting: {\r\n      enable: {\r\n        value: false,\r\n        type: 'boolean',\r\n        envLink: 'SERVER_RATE_LIMITING_ENABLE',\r\n        cliName: 'enableRateLimiting',\r\n        description: 'Enables rate limiting for the server.'\r\n      },\r\n      maxRequests: {\r\n        value: 10,\r\n        type: 'number',\r\n        envLink: 'SERVER_RATE_LIMITING_MAX_REQUESTS',\r\n        legacyName: 'rateLimit',\r\n        description: 'The maximum number of requests allowed in one minute.'\r\n      },\r\n      window: {\r\n        value: 1,\r\n        type: 'number',\r\n        envLink: 'SERVER_RATE_LIMITING_WINDOW',\r\n        description: 'The time window, in minutes, for the rate limiting.'\r\n      },\r\n      delay: {\r\n        value: 0,\r\n        type: 'number',\r\n        envLink: 'SERVER_RATE_LIMITING_DELAY',\r\n        description:\r\n          'The delay duration for each successive request before reaching the maximum limit.'\r\n      },\r\n      trustProxy: {\r\n        value: false,\r\n        type: 'boolean',\r\n        envLink: 'SERVER_RATE_LIMITING_TRUST_PROXY',\r\n        description: 'Set this to true if the server is behind a load balancer.'\r\n      },\r\n      skipKey: {\r\n        value: false,\r\n        type: 'string',\r\n        envLink: 'SERVER_RATE_LIMITING_SKIP_KEY',\r\n        description:\r\n          'Allows bypassing the rate limiter and should be provided with the skipToken argument.'\r\n      },\r\n      skipToken: {\r\n        value: false,\r\n        type: 'string',\r\n        envLink: 'SERVER_RATE_LIMITING_SKIP_TOKEN',\r\n        description:\r\n          'Allows bypassing the rate limiter and should be provided with the skipKey argument.'\r\n      }\r\n    },\r\n    ssl: {\r\n      enable: {\r\n        value: false,\r\n        type: 'boolean',\r\n        envLink: 'SERVER_SSL_ENABLE',\r\n        cliName: 'enableSsl',\r\n        description: 'Enables or disables the SSL protocol.'\r\n      },\r\n      force: {\r\n        value: false,\r\n        type: 'boolean',\r\n        envLink: 'SERVER_SSL_FORCE',\r\n        cliName: 'sslForce',\r\n        legacyName: 'sslOnly',\r\n        description:\r\n          'When set to true, the server is forced to serve only over HTTPS.'\r\n      },\r\n      port: {\r\n        value: 443,\r\n        type: 'number',\r\n        envLink: 'SERVER_SSL_PORT',\r\n        cliName: 'sslPort',\r\n        description: 'The port on which to run the SSL server.'\r\n      },\r\n      certPath: {\r\n        value: false,\r\n        type: 'string',\r\n        envLink: 'SERVER_SSL_CERT_PATH',\r\n        legacyName: 'sslPath',\r\n        description: 'The path to the SSL certificate/key file.'\r\n      }\r\n    }\r\n  },\r\n  pool: {\r\n    minWorkers: {\r\n      value: 4,\r\n      type: 'number',\r\n      envLink: 'POOL_MIN_WORKERS',\r\n      description: 'The number of minimum and initial pool workers to spawn.'\r\n    },\r\n    maxWorkers: {\r\n      value: 8,\r\n      type: 'number',\r\n      envLink: 'POOL_MAX_WORKERS',\r\n      legacyName: 'workers',\r\n      description: 'The number of maximum pool workers to spawn.'\r\n    },\r\n    workLimit: {\r\n      value: 40,\r\n      type: 'number',\r\n      envLink: 'POOL_WORK_LIMIT',\r\n      description:\r\n        'The number of work pieces that can be performed before restarting the worker process.'\r\n    },\r\n    acquireTimeout: {\r\n      value: 5000,\r\n      type: 'number',\r\n      envLink: 'POOL_ACQUIRE_TIMEOUT',\r\n      description:\r\n        'The duration, in milliseconds, to wait for acquiring a resource.'\r\n    },\r\n    createTimeout: {\r\n      value: 5000,\r\n      type: 'number',\r\n      envLink: 'POOL_CREATE_TIMEOUT',\r\n      description:\r\n        'The duration, in milliseconds, to wait for creating a resource.'\r\n    },\r\n    destroyTimeout: {\r\n      value: 5000,\r\n      type: 'number',\r\n      envLink: 'POOL_DESTROY_TIMEOUT',\r\n      description:\r\n        'The duration, in milliseconds, to wait for destroying a resource.'\r\n    },\r\n    idleTimeout: {\r\n      value: 30000,\r\n      type: 'number',\r\n      envLink: 'POOL_IDLE_TIMEOUT',\r\n      description:\r\n        'The duration, in milliseconds, after which an idle resource is destroyed.'\r\n    },\r\n    createRetryInterval: {\r\n      value: 200,\r\n      type: 'number',\r\n      envLink: 'POOL_CREATE_RETRY_INTERVAL',\r\n      description:\r\n        'The duration, in milliseconds, to wait before retrying the create process in case of a failure.'\r\n    },\r\n    reaperInterval: {\r\n      value: 1000,\r\n      type: 'number',\r\n      envLink: 'POOL_REAPER_INTERVAL',\r\n      description:\r\n        'The duration, in milliseconds, after which the check for idle resources to destroy is triggered.'\r\n    },\r\n    benchmarking: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'POOL_BENCHMARKING',\r\n      cliName: 'poolBenchmarking',\r\n      description:\r\n        'Indicate whether to show statistics for the pool of resources or not.'\r\n    }\r\n  },\r\n  logging: {\r\n    level: {\r\n      value: 4,\r\n      type: 'number',\r\n      envLink: 'LOGGING_LEVEL',\r\n      cliName: 'logLevel',\r\n      description: 'The logging level to be used.'\r\n    },\r\n    file: {\r\n      value: 'highcharts-export-server.log',\r\n      type: 'string',\r\n      envLink: 'LOGGING_FILE',\r\n      cliName: 'logFile',\r\n      description:\r\n        'The name of a log file. The `logToFile` and `logDest` options also need to be set to enable file logging.'\r\n    },\r\n    dest: {\r\n      value: 'log/',\r\n      type: 'string',\r\n      envLink: 'LOGGING_DEST',\r\n      cliName: 'logDest',\r\n      description:\r\n        'The path to store log files. The `logToFile` option also needs to be set to enable file logging.'\r\n    },\r\n    toConsole: {\r\n      value: true,\r\n      type: 'boolean',\r\n      envLink: 'LOGGING_TO_CONSOLE',\r\n      cliName: 'logToConsole',\r\n      description: 'Enables or disables showing logs in the console.'\r\n    },\r\n    toFile: {\r\n      value: true,\r\n      type: 'boolean',\r\n      envLink: 'LOGGING_TO_FILE',\r\n      cliName: 'logToFile',\r\n      description:\r\n        'Enables or disables creation of the log directory and saving the log into a .log file.'\r\n    }\r\n  },\r\n  ui: {\r\n    enable: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'UI_ENABLE',\r\n      cliName: 'enableUi',\r\n      description:\r\n        'Enables or disables the user interface (UI) for the export server.'\r\n    },\r\n    route: {\r\n      value: '/',\r\n      type: 'string',\r\n      envLink: 'UI_ROUTE',\r\n      cliName: 'uiRoute',\r\n      description:\r\n        'The endpoint route to which the user interface (UI) should be attached.'\r\n    }\r\n  },\r\n  other: {\r\n    nodeEnv: {\r\n      value: 'production',\r\n      type: 'string',\r\n      envLink: 'OTHER_NODE_ENV',\r\n      description: 'The type of Node.js environment.'\r\n    },\r\n    listenToProcessExits: {\r\n      value: true,\r\n      type: 'boolean',\r\n      envLink: 'OTHER_LISTEN_TO_PROCESS_EXITS',\r\n      description: 'Decides whether or not to attach process.exit handlers.'\r\n    },\r\n    noLogo: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'OTHER_NO_LOGO',\r\n      description:\r\n        'Skip printing the logo on a startup. Will be replaced by a simple text.'\r\n    },\r\n    hardResetPage: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'OTHER_HARD_RESET_PAGE',\r\n      description: 'Decides if the page content should be reset entirely.'\r\n    },\r\n    browserShellMode: {\r\n      value: true,\r\n      type: 'boolean',\r\n      envLink: 'OTHER_BROWSER_SHELL_MODE',\r\n      description: 'Decides if the browser runs in the shell mode.'\r\n    }\r\n  },\r\n  debug: {\r\n    enable: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'DEBUG_ENABLE',\r\n      cliName: 'enableDebug',\r\n      description: 'Enables or disables debug mode for the underlying browser.'\r\n    },\r\n    headless: {\r\n      value: true,\r\n      type: 'boolean',\r\n      envLink: 'DEBUG_HEADLESS',\r\n      description:\r\n        'Controls the mode in which the browser is launched when in the debug mode.'\r\n    },\r\n    devtools: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'DEBUG_DEVTOOLS',\r\n      description:\r\n        'Decides whether to enable DevTools when the browser is in a headful state.'\r\n    },\r\n    listenToConsole: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'DEBUG_LISTEN_TO_CONSOLE',\r\n      description:\r\n        'Decides whether to enable a listener for console messages sent from the browser.'\r\n    },\r\n    dumpio: {\r\n      value: false,\r\n      type: 'boolean',\r\n      envLink: 'DEBUG_DUMPIO',\r\n      description:\r\n        'Redirects browser process stdout and stderr to process.stdout and process.stderr.'\r\n    },\r\n    slowMo: {\r\n      value: 0,\r\n      type: 'number',\r\n      envLink: 'DEBUG_SLOW_MO',\r\n      description:\r\n        'Slows down Puppeteer operations by the specified number of milliseconds.'\r\n    },\r\n    debuggingPort: {\r\n      value: 9222,\r\n      type: 'number',\r\n      envLink: 'DEBUG_DEBUGGING_PORT',\r\n      description: 'Specifies the debugging port.'\r\n    }\r\n  }\r\n};\r\n\r\n// The config descriptions object for the prompts functionality. It contains\r\n// information like:\r\n// * Type of a prompt\r\n// * Name of an option\r\n// * Short description of a chosen option\r\n// * Initial value\r\nexport const promptsConfig = {\r\n  puppeteer: [\r\n    {\r\n      type: 'list',\r\n      name: 'args',\r\n      message: 'Puppeteer arguments',\r\n      initial: defaultConfig.puppeteer.args.value.join(','),\r\n      separator: ','\r\n    }\r\n  ],\r\n  highcharts: [\r\n    {\r\n      type: 'text',\r\n      name: 'version',\r\n      message: 'Highcharts version',\r\n      initial: defaultConfig.highcharts.version.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'cdnURL',\r\n      message: 'The URL of CDN',\r\n      initial: defaultConfig.highcharts.cdnURL.value\r\n    },\r\n    {\r\n      type: 'multiselect',\r\n      name: 'coreScripts',\r\n      message: 'Available core scripts',\r\n      instructions: 'Space: Select specific, A: Select all, Enter: Confirm.',\r\n      choices: defaultConfig.highcharts.coreScripts.value\r\n    },\r\n    {\r\n      type: 'multiselect',\r\n      name: 'moduleScripts',\r\n      message: 'Available module scripts',\r\n      instructions: 'Space: Select specific, A: Select all, Enter: Confirm.',\r\n      choices: defaultConfig.highcharts.moduleScripts.value\r\n    },\r\n    {\r\n      type: 'multiselect',\r\n      name: 'indicatorScripts',\r\n      message: 'Available indicator scripts',\r\n      instructions: 'Space: Select specific, A: Select all, Enter: Confirm.',\r\n      choices: defaultConfig.highcharts.indicatorScripts.value\r\n    },\r\n    {\r\n      type: 'list',\r\n      name: 'customScripts',\r\n      message: 'Custom scripts',\r\n      initial: defaultConfig.highcharts.customScripts.value.join(','),\r\n      separator: ','\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'forceFetch',\r\n      message: 'Force re-fetch the scripts',\r\n      initial: defaultConfig.highcharts.forceFetch.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'cachePath',\r\n      message: 'The path to the cache directory',\r\n      initial: defaultConfig.highcharts.cachePath.value\r\n    }\r\n  ],\r\n  export: [\r\n    {\r\n      type: 'select',\r\n      name: 'type',\r\n      message: 'The default export file type',\r\n      hint: `Default: ${defaultConfig.export.type.value}`,\r\n      initial: 0,\r\n      choices: ['png', 'jpeg', 'pdf', 'svg']\r\n    },\r\n    {\r\n      type: 'select',\r\n      name: 'constr',\r\n      message: 'The default constructor for Highcharts',\r\n      hint: `Default: ${defaultConfig.export.constr.value}`,\r\n      initial: 0,\r\n      choices: ['chart', 'stockChart', 'mapChart', 'ganttChart']\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'defaultHeight',\r\n      message: 'The default fallback height of the exported chart',\r\n      initial: defaultConfig.export.defaultHeight.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'defaultWidth',\r\n      message: 'The default fallback width of the exported chart',\r\n      initial: defaultConfig.export.defaultWidth.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'defaultScale',\r\n      message: 'The default fallback scale of the exported chart',\r\n      initial: defaultConfig.export.defaultScale.value,\r\n      min: 0.1,\r\n      max: 5\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'rasterizationTimeout',\r\n      message: 'The rendering webpage timeout in milliseconds',\r\n      initial: defaultConfig.export.rasterizationTimeout.value\r\n    }\r\n  ],\r\n  customLogic: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'allowCodeExecution',\r\n      message: 'Enable execution of custom code',\r\n      initial: defaultConfig.customLogic.allowCodeExecution.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'allowFileResources',\r\n      message: 'Enable file resources',\r\n      initial: defaultConfig.customLogic.allowFileResources.value\r\n    }\r\n  ],\r\n  server: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'enable',\r\n      message: 'Starts the server on 0.0.0.0',\r\n      initial: defaultConfig.server.enable.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'host',\r\n      message: 'Server hostname',\r\n      initial: defaultConfig.server.host.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'port',\r\n      message: 'Server port',\r\n      initial: defaultConfig.server.port.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'benchmarking',\r\n      message: 'Enable server benchmarking',\r\n      initial: defaultConfig.server.benchmarking.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'proxy.host',\r\n      message: 'The host of the proxy server to use',\r\n      initial: defaultConfig.server.proxy.host.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'proxy.port',\r\n      message: 'The port of the proxy server to use',\r\n      initial: defaultConfig.server.proxy.port.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'proxy.timeout',\r\n      message: 'The timeout for the proxy server to use',\r\n      initial: defaultConfig.server.proxy.timeout.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'rateLimiting.enable',\r\n      message: 'Enable rate limiting',\r\n      initial: defaultConfig.server.rateLimiting.enable.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'rateLimiting.maxRequests',\r\n      message: 'The maximum requests allowed per minute',\r\n      initial: defaultConfig.server.rateLimiting.maxRequests.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'rateLimiting.window',\r\n      message: 'The rate-limiting time window in minutes',\r\n      initial: defaultConfig.server.rateLimiting.window.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'rateLimiting.delay',\r\n      message:\r\n        'The delay for each successive request before reaching the maximum',\r\n      initial: defaultConfig.server.rateLimiting.delay.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'rateLimiting.trustProxy',\r\n      message: 'Set to true if behind a load balancer',\r\n      initial: defaultConfig.server.rateLimiting.trustProxy.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'rateLimiting.skipKey',\r\n      message:\r\n        'Allows bypassing the rate limiter when provided with the skipToken argument',\r\n      initial: defaultConfig.server.rateLimiting.skipKey.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'rateLimiting.skipToken',\r\n      message:\r\n        'Allows bypassing the rate limiter when provided with the skipKey argument',\r\n      initial: defaultConfig.server.rateLimiting.skipToken.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'ssl.enable',\r\n      message: 'Enable SSL protocol',\r\n      initial: defaultConfig.server.ssl.enable.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'ssl.force',\r\n      message: 'Force serving only over HTTPS',\r\n      initial: defaultConfig.server.ssl.force.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'ssl.port',\r\n      message: 'SSL server port',\r\n      initial: defaultConfig.server.ssl.port.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'ssl.certPath',\r\n      message: 'The path to find the SSL certificate/key',\r\n      initial: defaultConfig.server.ssl.certPath.value\r\n    }\r\n  ],\r\n  pool: [\r\n    {\r\n      type: 'number',\r\n      name: 'minWorkers',\r\n      message: 'The initial number of workers to spawn',\r\n      initial: defaultConfig.pool.minWorkers.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'maxWorkers',\r\n      message: 'The maximum number of workers to spawn',\r\n      initial: defaultConfig.pool.maxWorkers.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'workLimit',\r\n      message:\r\n        'The pieces of work that can be performed before restarting a Puppeteer process',\r\n      initial: defaultConfig.pool.workLimit.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'acquireTimeout',\r\n      message: 'The number of milliseconds to wait for acquiring a resource',\r\n      initial: defaultConfig.pool.acquireTimeout.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'createTimeout',\r\n      message: 'The number of milliseconds to wait for creating a resource',\r\n      initial: defaultConfig.pool.createTimeout.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'destroyTimeout',\r\n      message: 'The number of milliseconds to wait for destroying a resource',\r\n      initial: defaultConfig.pool.destroyTimeout.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'idleTimeout',\r\n      message: 'The number of milliseconds after an idle resource is destroyed',\r\n      initial: defaultConfig.pool.idleTimeout.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'createRetryInterval',\r\n      message:\r\n        'The retry interval in milliseconds after a create process fails',\r\n      initial: defaultConfig.pool.createRetryInterval.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'reaperInterval',\r\n      message:\r\n        'The reaper interval in milliseconds after triggering the check for idle resources to destroy',\r\n      initial: defaultConfig.pool.reaperInterval.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'benchmarking',\r\n      message: 'Enable benchmarking for a resource pool',\r\n      initial: defaultConfig.pool.benchmarking.value\r\n    }\r\n  ],\r\n  logging: [\r\n    {\r\n      type: 'number',\r\n      name: 'level',\r\n      message:\r\n        'The log level (0: silent, 1: error, 2: warning, 3: notice, 4: verbose, 5: benchmark)',\r\n      initial: defaultConfig.logging.level.value,\r\n      round: 0,\r\n      min: 0,\r\n      max: 5\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'file',\r\n      message:\r\n        'A log file name. Set with --toFile and --logDest to enable file logging',\r\n      initial: defaultConfig.logging.file.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'dest',\r\n      message: 'The path to a log file when the file logging is enabled',\r\n      initial: defaultConfig.logging.dest.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'toConsole',\r\n      message: 'Enable logging to the console',\r\n      initial: defaultConfig.logging.toConsole.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'toFile',\r\n      message: 'Enables logging to a file',\r\n      initial: defaultConfig.logging.toFile.value\r\n    }\r\n  ],\r\n  ui: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'enable',\r\n      message: 'Enable UI for the export server',\r\n      initial: defaultConfig.ui.enable.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'route',\r\n      message: 'A route to attach the UI',\r\n      initial: defaultConfig.ui.route.value\r\n    }\r\n  ],\r\n  other: [\r\n    {\r\n      type: 'text',\r\n      name: 'nodeEnv',\r\n      message: 'The type of Node.js environment',\r\n      initial: defaultConfig.other.nodeEnv.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'listenToProcessExits',\r\n      message: 'Set to false to skip attaching process.exit handlers',\r\n      initial: defaultConfig.other.listenToProcessExits.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'noLogo',\r\n      message: 'Skip printing the logo on startup. Replaced by simple text',\r\n      initial: defaultConfig.other.noLogo.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'hardResetPage',\r\n      message: 'Decides if the page content should be reset entirely',\r\n      initial: defaultConfig.other.hardResetPage.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'browserShellMode',\r\n      message: 'Decides if the browser runs in the shell mode',\r\n      initial: defaultConfig.other.browserShellMode.value\r\n    }\r\n  ],\r\n  debug: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'enable',\r\n      message: 'Enables debug mode for the browser instance',\r\n      initial: defaultConfig.debug.enable.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'headless',\r\n      message: 'The mode setting for the browser',\r\n      initial: defaultConfig.debug.headless.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'devtools',\r\n      message: 'The DevTools for the headful browser',\r\n      initial: defaultConfig.debug.devtools.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'listenToConsole',\r\n      message: 'The event listener for console messages from the browser',\r\n      initial: defaultConfig.debug.listenToConsole.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'dumpio',\r\n      message: 'Redirects the browser stdout and stderr to NodeJS process',\r\n      initial: defaultConfig.debug.dumpio.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'slowMo',\r\n      message: 'Puppeteer operations slow down in milliseconds',\r\n      initial: defaultConfig.debug.slowMo.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'debuggingPort',\r\n      message: 'The port number for debugging',\r\n      initial: defaultConfig.debug.debuggingPort.value\r\n    }\r\n  ]\r\n};\r\n\r\n// Absolute props that, in case of merging recursively, need to be force merged\r\nexport const absoluteProps = [\r\n  'options',\r\n  'globalOptions',\r\n  'themeOptions',\r\n  'resources',\r\n  'payload'\r\n];\r\n\r\n// Argument nesting level of all export server options\r\nexport const nestedArgs = {};\r\n\r\n/**\r\n * Recursively creates a chain of nested arguments from an object.\r\n *\r\n * @param {Object} obj - The object containing nested arguments.\r\n * @param {string} propChain - The current chain of nested properties\r\n * (used internally during recursion).\r\n */\r\nconst createNestedArgs = (obj, propChain = '') => {\r\n  Object.keys(obj).forEach((k) => {\r\n    if (!['puppeteer', 'highcharts'].includes(k)) {\r\n      const entry = obj[k];\r\n      if (typeof entry.value === 'undefined') {\r\n        // Go deeper in the nested arguments\r\n        createNestedArgs(entry, `${propChain}.${k}`);\r\n      } else {\r\n        // Create the chain of nested arguments\r\n        nestedArgs[entry.cliName || k] = `${propChain}.${k}`.substring(1);\r\n\r\n        // Support for the legacy, PhantomJS properties names\r\n        if (entry.legacyName !== undefined) {\r\n          nestedArgs[entry.legacyName] = `${propChain}.${k}`.substring(1);\r\n        }\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\ncreateNestedArgs(defaultConfig);\r\n","/**\r\n * @fileoverview\r\n * This file is responsible for parsing the environment variables with the 'zod'\r\n * library. The parsed environment variables are then exported to be used\r\n * in the application as \"envs\". We should not use process.env directly\r\n * in the application as these would not be parsed properly.\r\n *\r\n * The environment variables are parsed and validated only once when\r\n * the application starts. We should write a custom validator or a transformer\r\n * for each of the options.\r\n */\r\n\r\nimport dotenv from 'dotenv';\r\nimport { z } from 'zod';\r\n\r\nimport { scriptsNames } from './schemas/config.js';\r\n\r\n// Load .env into environment variables\r\ndotenv.config();\r\n\r\n// Object with custom validators and transformers, to avoid repetition\r\n// in the Config object\r\nconst v = {\r\n  // Splits string value into elements in an array, trims every element, checks\r\n  // if an array is correct, if it is empty, and if it is, returns undefined\r\n  array: (filterArray) =>\r\n    z\r\n      .string()\r\n      .transform((value) =>\r\n        value\r\n          .split(',')\r\n          .map((value) => value.trim())\r\n          .filter((value) => filterArray.includes(value))\r\n      )\r\n      .transform((value) => (value.length ? value : undefined)),\r\n\r\n  // Allows only true, false and correctly parse the value to boolean\r\n  // or no value in which case the returned value will be undefined\r\n  boolean: () =>\r\n    z\r\n      .enum(['true', 'false', ''])\r\n      .transform((value) => (value !== '' ? value === 'true' : undefined)),\r\n\r\n  // Allows passed values or no value in which case the returned value will\r\n  // be undefined\r\n  enum: (values) =>\r\n    z\r\n      .enum([...values, ''])\r\n      .transform((value) => (value !== '' ? value : undefined)),\r\n\r\n  // Trims the string value and checks if it is empty or contains stringified\r\n  // values such as false, undefined, null, NaN, if it does, returns undefined\r\n  string: () =>\r\n    z\r\n      .string()\r\n      .trim()\r\n      .refine(\r\n        (value) =>\r\n          !['false', 'undefined', 'null', 'NaN'].includes(value) ||\r\n          value === '',\r\n        (value) => ({\r\n          message: `The string contains forbidden values, received '${value}'`\r\n        })\r\n      )\r\n      .transform((value) => (value !== '' ? value : undefined)),\r\n\r\n  // Checks if the string is a valid path directory (path format)\r\n  path: () =>\r\n    z\r\n      .string()\r\n      .trim()\r\n      .refine(\r\n        (value) => {\r\n          // Simplified regex to match both absolute and relative paths\r\n          return /^(\\.\\/|\\.\\.\\/|\\/|[a-zA-Z]:\\\\|[a-zA-Z]:\\/)?((?:[\\w-]+)[\\\\/]?)+$/.test(\r\n            value\r\n          );\r\n        },\r\n        {},\r\n        {\r\n          message: 'The string is an invalid path directory string.'\r\n        }\r\n      ),\r\n\r\n  // Allows positive numbers or no value in which case the returned value will\r\n  // be undefined\r\n  positiveNum: () =>\r\n    z\r\n      .string()\r\n      .trim()\r\n      .refine(\r\n        (value) =>\r\n          value === '' || (!isNaN(parseFloat(value)) && parseFloat(value) > 0),\r\n        (value) => ({\r\n          message: `The value must be numeric and positive, received '${value}'`\r\n        })\r\n      )\r\n      .transform((value) => (value !== '' ? parseFloat(value) : undefined)),\r\n\r\n  // Allows non-negative numbers or no value in which case the returned value\r\n  // will be undefined\r\n  nonNegativeNum: () =>\r\n    z\r\n      .string()\r\n      .trim()\r\n      .refine(\r\n        (value) =>\r\n          value === '' || (!isNaN(parseFloat(value)) && parseFloat(value) >= 0),\r\n        (value) => ({\r\n          message: `The value must be numeric and non-negative, received '${value}'`\r\n        })\r\n      )\r\n      .transform((value) => (value !== '' ? parseFloat(value) : undefined))\r\n};\r\n\r\nexport const Config = z.object({\r\n  // puppeteer\r\n  PUPPETEER_TEMP_DIR: v.path(),\r\n\r\n  // highcharts\r\n  HIGHCHARTS_VERSION: z\r\n    .string()\r\n    .trim()\r\n    .refine(\r\n      (value) => /^(latest|\\d+(\\.\\d+){0,2})$/.test(value) || value === '',\r\n      (value) => ({\r\n        message: `HIGHCHARTS_VERSION must be 'latest', a major version, or in the form XX.YY.ZZ, received '${value}'`\r\n      })\r\n    )\r\n    .transform((value) => (value !== '' ? value : undefined)),\r\n  HIGHCHARTS_CDN_URL: z\r\n    .string()\r\n    .trim()\r\n    .refine(\r\n      (value) =>\r\n        value.startsWith('https://') ||\r\n        value.startsWith('http://') ||\r\n        value === '',\r\n      (value) => ({\r\n        message: `Invalid value for HIGHCHARTS_CDN_URL. It should start with http:// or https://, received '${value}'`\r\n      })\r\n    )\r\n    .transform((value) => (value !== '' ? value : undefined)),\r\n  HIGHCHARTS_CORE_SCRIPTS: v.array(scriptsNames.core),\r\n  HIGHCHARTS_MODULE_SCRIPTS: v.array(scriptsNames.modules),\r\n  HIGHCHARTS_INDICATOR_SCRIPTS: v.array(scriptsNames.indicators),\r\n  HIGHCHARTS_FORCE_FETCH: v.boolean(),\r\n  HIGHCHARTS_CACHE_PATH: v.string(),\r\n  HIGHCHARTS_ADMIN_TOKEN: v.string(),\r\n\r\n  // export\r\n  EXPORT_TYPE: v.enum(['jpeg', 'png', 'pdf', 'svg']),\r\n  EXPORT_CONSTR: v.enum(['chart', 'stockChart', 'mapChart', 'ganttChart']),\r\n  EXPORT_DEFAULT_HEIGHT: v.positiveNum(),\r\n  EXPORT_DEFAULT_WIDTH: v.positiveNum(),\r\n  EXPORT_DEFAULT_SCALE: v.positiveNum(),\r\n  EXPORT_RASTERIZATION_TIMEOUT: v.nonNegativeNum(),\r\n\r\n  // custom\r\n  CUSTOM_LOGIC_ALLOW_CODE_EXECUTION: v.boolean(),\r\n  CUSTOM_LOGIC_ALLOW_FILE_RESOURCES: v.boolean(),\r\n\r\n  // server\r\n  SERVER_ENABLE: v.boolean(),\r\n  SERVER_HOST: v.string(),\r\n  SERVER_PORT: v.positiveNum(),\r\n  SERVER_MAX_UPLOAD_SIZE: v.positiveNum(),\r\n  SERVER_BENCHMARKING: v.boolean(),\r\n\r\n  // server proxy\r\n  SERVER_PROXY_HOST: v.string(),\r\n  SERVER_PROXY_PORT: v.positiveNum(),\r\n  SERVER_PROXY_USERNAME: v.string(),\r\n  SERVER_PROXY_PASSWORD: v.string(),\r\n  SERVER_PROXY_TIMEOUT: v.nonNegativeNum(),\r\n\r\n  // server rate limiting\r\n  SERVER_RATE_LIMITING_ENABLE: v.boolean(),\r\n  SERVER_RATE_LIMITING_MAX_REQUESTS: v.nonNegativeNum(),\r\n  SERVER_RATE_LIMITING_WINDOW: v.nonNegativeNum(),\r\n  SERVER_RATE_LIMITING_DELAY: v.nonNegativeNum(),\r\n  SERVER_RATE_LIMITING_TRUST_PROXY: v.boolean(),\r\n  SERVER_RATE_LIMITING_SKIP_KEY: v.string(),\r\n  SERVER_RATE_LIMITING_SKIP_TOKEN: v.string(),\r\n\r\n  // server ssl\r\n  SERVER_SSL_ENABLE: v.boolean(),\r\n  SERVER_SSL_FORCE: v.boolean(),\r\n  SERVER_SSL_PORT: v.positiveNum(),\r\n  SERVER_SSL_CERT_PATH: v.string(),\r\n\r\n  // pool\r\n  POOL_MIN_WORKERS: v.nonNegativeNum(),\r\n  POOL_MAX_WORKERS: v.nonNegativeNum(),\r\n  POOL_WORK_LIMIT: v.positiveNum(),\r\n  POOL_ACQUIRE_TIMEOUT: v.nonNegativeNum(),\r\n  POOL_CREATE_TIMEOUT: v.nonNegativeNum(),\r\n  POOL_DESTROY_TIMEOUT: v.nonNegativeNum(),\r\n  POOL_IDLE_TIMEOUT: v.nonNegativeNum(),\r\n  POOL_CREATE_RETRY_INTERVAL: v.nonNegativeNum(),\r\n  POOL_REAPER_INTERVAL: v.nonNegativeNum(),\r\n  POOL_BENCHMARKING: v.boolean(),\r\n\r\n  // logger\r\n  LOGGING_LEVEL: z\r\n    .string()\r\n    .trim()\r\n    .refine(\r\n      (value) =>\r\n        value === '' ||\r\n        (!isNaN(parseFloat(value)) &&\r\n          parseFloat(value) >= 0 &&\r\n          parseFloat(value) <= 5),\r\n      (value) => ({\r\n        message: `Invalid value for LOGGING_LEVEL. We only accept values from 0 to 5 as logging levels, received '${value}'`\r\n      })\r\n    )\r\n    .transform((value) => (value !== '' ? parseFloat(value) : undefined)),\r\n  LOGGING_FILE: v.string(),\r\n  LOGGING_DEST: v.string(),\r\n  LOGGING_TO_CONSOLE: v.boolean(),\r\n  LOGGING_TO_FILE: v.boolean(),\r\n\r\n  // ui\r\n  UI_ENABLE: v.boolean(),\r\n  UI_ROUTE: v.string(),\r\n\r\n  // other\r\n  OTHER_NODE_ENV: v.enum(['development', 'production', 'test']),\r\n  OTHER_LISTEN_TO_PROCESS_EXITS: v.boolean(),\r\n  OTHER_NO_LOGO: v.boolean(),\r\n  OTHER_HARD_RESET_PAGE: v.boolean(),\r\n  OTHER_BROWSER_SHELL_MODE: v.boolean(),\r\n\r\n  // debugger\r\n  DEBUG_ENABLE: v.boolean(),\r\n  DEBUG_HEADLESS: v.boolean(),\r\n  DEBUG_DEVTOOLS: v.boolean(),\r\n  DEBUG_LISTEN_TO_CONSOLE: v.boolean(),\r\n  DEBUG_DUMPIO: v.boolean(),\r\n  DEBUG_SLOW_MO: v.nonNegativeNum(),\r\n  DEBUG_DEBUGGING_PORT: v.positiveNum()\r\n});\r\n\r\nexport const envs = Config.partial().parse(process.env);\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { appendFile, existsSync, mkdirSync } from 'fs';\r\n\r\n// The available colors\r\nconst colors = ['red', 'yellow', 'blue', 'gray', 'green'];\r\n\r\n// The default logging config\r\nlet logging = {\r\n  // Flags for logging status\r\n  toConsole: true,\r\n  toFile: false,\r\n  pathCreated: false,\r\n  // Log levels\r\n  levelsDesc: [\r\n    {\r\n      title: 'error',\r\n      color: colors[0]\r\n    },\r\n    {\r\n      title: 'warning',\r\n      color: colors[1]\r\n    },\r\n    {\r\n      title: 'notice',\r\n      color: colors[2]\r\n    },\r\n    {\r\n      title: 'verbose',\r\n      color: colors[3]\r\n    },\r\n    {\r\n      title: 'benchmark',\r\n      color: colors[4]\r\n    }\r\n  ],\r\n  // Log listeners\r\n  listeners: []\r\n};\r\n\r\n/**\r\n * Logs the provided texts to a file, if file logging is enabled. It creates\r\n * the necessary directory structure if not already created and appends the\r\n * content, including an optional prefix, to the specified log file.\r\n *\r\n * @param {string[]} texts - An array of texts to be logged.\r\n * @param {string} prefix - An optional prefix to be added to each log entry.\r\n */\r\nconst logToFile = (texts, prefix) => {\r\n  if (!logging.pathCreated) {\r\n    // Create if does not exist\r\n    !existsSync(logging.dest) && mkdirSync(logging.dest);\r\n\r\n    // We now assume the path is available, e.g. it's the responsibility\r\n    // of the user to create the path with the correct access rights.\r\n    logging.pathCreated = true;\r\n  }\r\n\r\n  // Add the content to a file\r\n  appendFile(\r\n    `${logging.dest}${logging.file}`,\r\n    [prefix].concat(texts).join(' ') + '\\n',\r\n    (error) => {\r\n      if (error) {\r\n        console.log(`[logger] Unable to write to log file: ${error}`);\r\n        logging.toFile = false;\r\n      }\r\n    }\r\n  );\r\n};\r\n\r\n/**\r\n * Logs a message. Accepts a variable amount of arguments. Arguments after\r\n * `level` will be passed directly to console.log, and/or will be joined\r\n * and appended to the log file.\r\n *\r\n * @param {any} args - An array of arguments where the first is the log level\r\n * and the rest are strings to build a message with.\r\n */\r\nexport const log = (...args) => {\r\n  const [newLevel, ...texts] = args;\r\n\r\n  // Current logging options\r\n  const { levelsDesc, level } = logging;\r\n\r\n  // Check if log level is within a correct range or is a benchmark log\r\n  if (\r\n    newLevel !== 5 &&\r\n    (newLevel === 0 || newLevel > level || level > levelsDesc.length)\r\n  ) {\r\n    return;\r\n  }\r\n\r\n  // Get rid of the GMT text information\r\n  const newDate = new Date().toString().split('(')[0].trim();\r\n\r\n  // Create a message's prefix\r\n  const prefix = `${newDate} [${levelsDesc[newLevel - 1].title}] -`;\r\n\r\n  // Call available log listeners\r\n  logging.listeners.forEach((fn) => {\r\n    fn(prefix, texts.join(' '));\r\n  });\r\n\r\n  // Log to console\r\n  if (logging.toConsole) {\r\n    console.log.apply(\r\n      undefined,\r\n      [prefix.toString()[logging.levelsDesc[newLevel - 1].color]].concat(texts)\r\n    );\r\n  }\r\n\r\n  // Log to file\r\n  if (logging.toFile) {\r\n    logToFile(texts, prefix);\r\n  }\r\n};\r\n\r\n/**\r\n * Logs an error message with its stack trace. Optionally, a custom message\r\n * can be provided.\r\n *\r\n * @param {number} level - The log level.\r\n * @param {Error} error - The error object.\r\n * @param {string} customMessage - An optional custom message to be logged along\r\n * with the error.\r\n */\r\nexport const logWithStack = (newLevel, error, customMessage) => {\r\n  // Get the main message\r\n  const mainMessage = customMessage || error.message;\r\n\r\n  // Current logging options\r\n  const { level, levelsDesc } = logging;\r\n\r\n  // Check if log level is within a correct range\r\n  if (newLevel === 0 || newLevel > level || level > levelsDesc.length) {\r\n    return;\r\n  }\r\n\r\n  // Get rid of the GMT text information\r\n  const newDate = new Date().toString().split('(')[0].trim();\r\n\r\n  // Create a message's prefix\r\n  const prefix = `${newDate} [${levelsDesc[newLevel - 1].title}] -`;\r\n\r\n  // If the customMessage exists, we want to display the whole stack message\r\n  const stackMessage =\r\n    error.message !== error.stackMessage || error.stackMessage === undefined\r\n      ? error.stack\r\n      : error.stack.split('\\n').slice(1).join('\\n');\r\n\r\n  // Combine custom message or error message with error stack message\r\n  const texts = [mainMessage, '\\n', stackMessage];\r\n\r\n  // Log to console\r\n  if (logging.toConsole) {\r\n    console.log.apply(\r\n      undefined,\r\n      [prefix.toString()[logging.levelsDesc[newLevel - 1].color]].concat([\r\n        mainMessage[colors[newLevel - 1]],\r\n        '\\n',\r\n        stackMessage\r\n      ])\r\n    );\r\n  }\r\n\r\n  // Call available log listeners\r\n  logging.listeners.forEach((fn) => {\r\n    fn(prefix, texts.join(' '));\r\n  });\r\n\r\n  // Log to file\r\n  if (logging.toFile) {\r\n    logToFile(texts, prefix);\r\n  }\r\n};\r\n\r\n/**\r\n * Sets the log level to the specified value. Log levels are (0 = no logging,\r\n * 1 = error, 2 = warning, 3 = notice, 4 = verbose or 5 = benchmark)\r\n *\r\n * @param {number} newLevel - The new log level to be set.\r\n */\r\nexport const setLogLevel = (newLevel) => {\r\n  if (newLevel >= 0 && newLevel <= logging.levelsDesc.length) {\r\n    logging.level = newLevel;\r\n  }\r\n};\r\n\r\n/**\r\n * Enables file logging with the specified destination and log file.\r\n *\r\n * @param {string} logDest - The destination path for log files.\r\n * @param {string} logFile - The log file name.\r\n */\r\nexport const enableFileLogging = (logDest, logFile) => {\r\n  // Update logging options\r\n  logging = {\r\n    ...logging,\r\n    dest: logDest || logging.dest,\r\n    file: logFile || logging.file,\r\n    toFile: true\r\n  };\r\n\r\n  if (logging.dest.length === 0) {\r\n    return log(1, '[logger] File logging initialization: no path supplied.');\r\n  }\r\n\r\n  if (!logging.dest.endsWith('/')) {\r\n    logging.dest += '/';\r\n  }\r\n};\r\n\r\n/**\r\n * Initializes logging with the specified logging configuration.\r\n *\r\n * @param {Object} loggingOptions - The logging configuration object.\r\n */\r\nexport const initLogging = (loggingOptions) => {\r\n  // Set all the logging options on our logging module object\r\n  for (const [key, value] of Object.entries(loggingOptions)) {\r\n    logging[key] = value;\r\n  }\r\n\r\n  // Set the log level\r\n  setLogLevel(loggingOptions && parseInt(loggingOptions.level));\r\n\r\n  // Set the log file path and name\r\n  if (loggingOptions && loggingOptions.dest && loggingOptions.toFile) {\r\n    enableFileLogging(\r\n      loggingOptions.dest,\r\n      loggingOptions.file || 'highcharts-export-server.log'\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Adds a listener function to the logging system.\r\n *\r\n * @param {function} fn - The listener function to be added.\r\n */\r\nexport const listen = (fn) => {\r\n  logging.listeners.push(fn);\r\n};\r\n\r\nexport default {\r\n  log,\r\n  logWithStack,\r\n  setLogLevel,\r\n  enableFileLogging,\r\n  initLogging,\r\n  listen\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { readFileSync } from 'fs';\r\nimport { join } from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\nimport { defaultConfig } from '../lib/schemas/config.js';\r\nimport { log, logWithStack } from './logger.js';\r\n\r\nconst MAX_BACKOFF_ATTEMPTS = 6;\r\n\r\nexport const __dirname = fileURLToPath(new URL('../.', import.meta.url));\r\n\r\n/**\r\n * Clears and standardizes text by replacing multiple consecutive whitespace\r\n * characters with a single space and trimming any leading or trailing\r\n * whitespace.\r\n *\r\n * @param {string} text - The input text to be cleared.\r\n * @param {RegExp} [rule=/\\s\\s+/g] - The regular expression rule to match\r\n * multiple consecutive whitespace characters.\r\n * @param {string} [replacer=' '] - The string used to replace multiple\r\n * consecutive whitespace characters.\r\n *\r\n * @returns {string} - The cleared and standardized text.\r\n */\r\nexport const clearText = (text, rule = /\\s\\s+/g, replacer = ' ') =>\r\n  text.replaceAll(rule, replacer).trim();\r\n\r\n/**\r\n * Implements an exponential backoff strategy for retrying a function until\r\n * a certain number of attempts are reached.\r\n *\r\n * @param {Function} fn - The function to be retried.\r\n * @param {number} [attempt=0] - The current attempt number.\r\n * @param {...any} args - Arguments to be passed to the function.\r\n *\r\n * @returns {Promise} - A promise that resolves to the result of the function\r\n * if successful.\r\n *\r\n * @throws {Error} - Throws an error if the maximum number of attempts\r\n * is reached.\r\n */\r\nexport const expBackoff = async (fn, attempt = 0, ...args) => {\r\n  try {\r\n    // Try to call the function\r\n    return await fn(...args);\r\n  } catch (error) {\r\n    // Calculate delay in ms\r\n    const delayInMs = 2 ** attempt * 1000;\r\n\r\n    // If the attempt exceeds the maximum attempts of reapeat, throw an error\r\n    if (++attempt >= MAX_BACKOFF_ATTEMPTS) {\r\n      throw error;\r\n    }\r\n\r\n    // Wait given amount of time\r\n    await new Promise((response) => setTimeout(response, delayInMs));\r\n    log(\r\n      3,\r\n      `[pool] Waited ${delayInMs}ms until next call for the resource id: ${args[0]}.`\r\n    );\r\n\r\n    // Try again\r\n    return expBackoff(fn, attempt, ...args);\r\n  }\r\n};\r\n\r\n/**\r\n * Fixes the export type based on MIME types and file extensions.\r\n *\r\n * @param {string} type - The original export type.\r\n * @param {string} outfile - The file path or name.\r\n *\r\n * @returns {string} - The corrected export type.\r\n */\r\nexport const fixType = (type, outfile) => {\r\n  // MIME types\r\n  const mimeTypes = {\r\n    'image/png': 'png',\r\n    'image/jpeg': 'jpeg',\r\n    'application/pdf': 'pdf',\r\n    'image/svg+xml': 'svg'\r\n  };\r\n\r\n  // Formats\r\n  const formats = ['png', 'jpeg', 'pdf', 'svg'];\r\n\r\n  // Check if type and outfile's extensions are the same\r\n  if (outfile) {\r\n    const outType = outfile.split('.').pop();\r\n\r\n    if (outType === 'jpg') {\r\n      type = 'jpeg';\r\n    } else if (formats.includes(outType) && type !== outType) {\r\n      type = outType;\r\n    }\r\n  }\r\n\r\n  // Return a correct type\r\n  return mimeTypes[type] || formats.find((t) => t === type) || 'png';\r\n};\r\n\r\n/**\r\n * Handles and validates resources for export.\r\n *\r\n * @param {Object|string} resources - The resources to be handled. Can be either\r\n * a JSON object, stringified JSON or a path to a JSON file.\r\n * @param {boolean} allowFileResources - Whether to allow loading resources from\r\n * files.\r\n *\r\n * @returns {Object|undefined} - The handled resources or undefined if no valid\r\n * resources are found.\r\n */\r\nexport const handleResources = (resources = false, allowFileResources) => {\r\n  const allowedProps = ['js', 'css', 'files'];\r\n\r\n  let handledResources = resources;\r\n  let correctResources = false;\r\n\r\n  // Try to load resources from a file\r\n  if (allowFileResources && resources.endsWith('.json')) {\r\n    try {\r\n      handledResources = isCorrectJSON(readFileSync(resources, 'utf8'));\r\n    } catch (error) {\r\n      return logWithStack(2, error, `[cli] No resources found.`);\r\n    }\r\n  } else {\r\n    // Try to get JSON\r\n    handledResources = isCorrectJSON(resources);\r\n\r\n    // Get rid of the files section\r\n    if (handledResources && !allowFileResources) {\r\n      delete handledResources.files;\r\n    }\r\n  }\r\n\r\n  // Filter from unnecessary properties\r\n  for (const propName in handledResources) {\r\n    if (!allowedProps.includes(propName)) {\r\n      delete handledResources[propName];\r\n    } else if (!correctResources) {\r\n      correctResources = true;\r\n    }\r\n  }\r\n\r\n  // Check if at least one of allowed properties is present\r\n  if (!correctResources) {\r\n    return log(3, `[cli] No resources found.`);\r\n  }\r\n\r\n  // Handle files section\r\n  if (handledResources.files) {\r\n    handledResources.files = handledResources.files.map((item) => item.trim());\r\n    if (!handledResources.files || handledResources.files.length <= 0) {\r\n      delete handledResources.files;\r\n    }\r\n  }\r\n\r\n  // Return resources\r\n  return handledResources;\r\n};\r\n\r\n/**\r\n * Validates and parses JSON data. Checks if provided data is or can\r\n * be a correct JSON. If a primitive is provided, it is stringified and returned.\r\n *\r\n * @param {Object|string} data - The JSON data to be validated and parsed.\r\n * @param {boolean} toString - Whether to return a stringified representation\r\n * of the parsed JSON.\r\n *\r\n * @returns {Object|string|boolean} - The parsed JSON object, stringified JSON,\r\n * or false if validation fails.\r\n */\r\nexport function isCorrectJSON(data, toString) {\r\n  try {\r\n    // Get the string representation if not already before parsing\r\n    const parsedData = JSON.parse(\r\n      typeof data !== 'string' ? JSON.stringify(data) : data\r\n    );\r\n\r\n    // Return a stringified representation of a JSON if required\r\n    if (typeof parsedData !== 'string' && toString) {\r\n      return JSON.stringify(parsedData);\r\n    }\r\n\r\n    // Return a JSON\r\n    return parsedData;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if the given item is an object.\r\n *\r\n * @param {any} item - The item to be checked.\r\n *\r\n * @returns {boolean} - True if the item is an object, false otherwise.\r\n */\r\nexport const isObject = (item) =>\r\n  typeof item === 'object' && !Array.isArray(item) && item !== null;\r\n\r\n/**\r\n * Checks if the given object is empty.\r\n *\r\n * @param {Object} item - The object to be checked.\r\n *\r\n * @returns {boolean} - True if the object is empty, false otherwise.\r\n */\r\nexport const isObjectEmpty = (item) =>\r\n  typeof item === 'object' &&\r\n  !Array.isArray(item) &&\r\n  item !== null &&\r\n  Object.keys(item).length === 0;\r\n\r\n/**\r\n * Checks if a private IP range URL is found in the given string.\r\n *\r\n * @param {string} item - The string to be checked for a private IP range URL.\r\n *\r\n * @returns {boolean} - True if a private IP range URL is found, false\r\n * otherwise.\r\n */\r\nexport const isPrivateRangeUrlFound = (item) => {\r\n  const regexPatterns = [\r\n    /xlink:href=\"(?:http:\\/\\/|https:\\/\\/)?localhost\\b/,\r\n    /xlink:href=\"(?:http:\\/\\/|https:\\/\\/)?10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b/,\r\n    /xlink:href=\"(?:http:\\/\\/|https:\\/\\/)?127\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b/,\r\n    /xlink:href=\"(?:http:\\/\\/|https:\\/\\/)?172\\.(1[6-9]|2[0-9]|3[0-1])\\.\\d{1,3}\\.\\d{1,3}\\b/,\r\n    /xlink:href=\"(?:http:\\/\\/|https:\\/\\/)?192\\.168\\.\\d{1,3}\\.\\d{1,3}\\b/\r\n  ];\r\n\r\n  return regexPatterns.some((pattern) => pattern.test(item));\r\n};\r\n\r\n/**\r\n * Creates a deep copy of the given object or array.\r\n *\r\n * @param {Object|Array} obj - The object or array to be deeply copied.\r\n *\r\n * @returns {Object|Array} - The deep copy of the provided object or array.\r\n */\r\nexport const deepCopy = (obj) => {\r\n  if (obj === null || typeof obj !== 'object') {\r\n    return obj;\r\n  }\r\n\r\n  const copy = Array.isArray(obj) ? [] : {};\r\n\r\n  for (const key in obj) {\r\n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\r\n      copy[key] = deepCopy(obj[key]);\r\n    }\r\n  }\r\n\r\n  return copy;\r\n};\r\n\r\n/**\r\n * Converts the provided options object to a JSON-formatted string with the\r\n * option to preserve functions.\r\n *\r\n * @param {Object} options - The options object to be converted to a string.\r\n * @param {boolean} allowFunctions - If set to true, functions are preserved\r\n * in the output.\r\n *\r\n * @returns {string} - The JSON-formatted string representing the options.\r\n */\r\nexport const optionsStringify = (options, allowFunctions) => {\r\n  const replacerCallback = (name, value) => {\r\n    if (typeof value === 'string') {\r\n      value = value.trim();\r\n\r\n      // If allowFunctions is set to true, preserve functions\r\n      if (\r\n        (value.startsWith('function(') || value.startsWith('function (')) &&\r\n        value.endsWith('}')\r\n      ) {\r\n        value = allowFunctions\r\n          ? `EXP_FUN${(value + '').replaceAll(/\\n|\\t|\\r/g, ' ')}EXP_FUN`\r\n          : undefined;\r\n      }\r\n    }\r\n\r\n    return typeof value === 'function'\r\n      ? `EXP_FUN${(value + '').replaceAll(/\\n|\\t|\\r/g, ' ')}EXP_FUN`\r\n      : value;\r\n  };\r\n\r\n  // Stringify options and if required, replace special functions marks\r\n  return JSON.stringify(options, replacerCallback).replaceAll(\r\n    /\"EXP_FUN|EXP_FUN\"/g,\r\n    ''\r\n  );\r\n};\r\n\r\n/**\r\n * Prints the Highcharts Export Server logo and version information.\r\n *\r\n * @param {boolean} noLogo - If true, only prints version information without\r\n * the logo.\r\n */\r\nexport const printLogo = (noLogo) => {\r\n  // Get package version either from env or from package.json\r\n  const packageVersion = JSON.parse(\r\n    readFileSync(join(__dirname, 'package.json'))\r\n  ).version;\r\n\r\n  // Print text only\r\n  if (noLogo) {\r\n    console.log(`Starting Highcharts Export Server v${packageVersion}...`);\r\n    return;\r\n  }\r\n\r\n  // Print the logo\r\n  console.log(\r\n    readFileSync(__dirname + '/msg/startup.msg').toString().bold.yellow,\r\n    `v${packageVersion}\\n`.bold\r\n  );\r\n};\r\n\r\n/**\r\n * Prints the usage information for CLI arguments. If required, it can list\r\n * properties recursively\r\n */\r\nexport function printUsage() {\r\n  const pad = 48;\r\n  const readme = 'https://github.com/highcharts/node-export-server#readme';\r\n\r\n  // Display readme information\r\n  console.log(\r\n    '\\nUsage of CLI arguments:'.bold,\r\n    '\\n------',\r\n    `\\nFor more detailed information, visit the readme at: ${readme.bold.yellow}.`\r\n  );\r\n\r\n  const cycleCategories = (options) => {\r\n    for (const [name, option] of Object.entries(options)) {\r\n      // If category has more levels, go further\r\n      if (!Object.prototype.hasOwnProperty.call(option, 'value')) {\r\n        cycleCategories(option);\r\n      } else {\r\n        let descName = `  --${option.cliName || name} ${\r\n          ('<' + option.type + '>').green\r\n        } `;\r\n        if (descName.length < pad) {\r\n          for (let i = descName.length; i < pad; i++) {\r\n            descName += '.';\r\n          }\r\n        }\r\n\r\n        // Display correctly aligned messages\r\n        console.log(\r\n          descName,\r\n          option.description,\r\n          `[Default: ${option.value.toString().bold}]`.blue\r\n        );\r\n      }\r\n    }\r\n  };\r\n\r\n  // Cycle through options of each categories and display the usage info\r\n  Object.keys(defaultConfig).forEach((category) => {\r\n    // Only puppeteer and highcharts categories cannot be configured through CLI\r\n    if (!['puppeteer', 'highcharts'].includes(category)) {\r\n      console.log(`\\n${category.toUpperCase()}`.red);\r\n      cycleCategories(defaultConfig[category]);\r\n    }\r\n  });\r\n  console.log('\\n');\r\n}\r\n\r\n/**\r\n * Rounds a number to the specified precision.\r\n *\r\n * @param {number} value - The number to be rounded.\r\n * @param {number} precision - The number of decimal places to round to.\r\n *\r\n * @returns {number} - The rounded number.\r\n */\r\nexport const roundNumber = (value, precision = 1) => {\r\n  const multiplier = Math.pow(10, precision || 0);\r\n  return Math.round(+value * multiplier) / multiplier;\r\n};\r\n\r\n/**\r\n * Converts a value to a boolean.\r\n *\r\n * @param {any} item - The value to be converted to a boolean.\r\n *\r\n * @returns {boolean} - The boolean representation of the input value.\r\n */\r\nexport const toBoolean = (item) =>\r\n  ['false', 'undefined', 'null', 'NaN', '0', ''].includes(item)\r\n    ? false\r\n    : !!item;\r\n\r\n/**\r\n * Wraps custom code to execute it safely.\r\n *\r\n * @param {string} customCode - The custom code to be wrapped.\r\n * @param {boolean} allowFileResources - Flag to allow loading code from a file.\r\n *\r\n * @returns {string|boolean} - The wrapped custom code or false if wrapping\r\n * fails.\r\n */\r\nexport const wrapAround = (customCode, allowFileResources) => {\r\n  if (customCode && typeof customCode === 'string') {\r\n    customCode = customCode.trim();\r\n\r\n    if (customCode.endsWith('.js')) {\r\n      return allowFileResources\r\n        ? wrapAround(readFileSync(customCode, 'utf8'))\r\n        : false;\r\n    } else if (\r\n      customCode.startsWith('function()') ||\r\n      customCode.startsWith('function ()') ||\r\n      customCode.startsWith('()=>') ||\r\n      customCode.startsWith('() =>')\r\n    ) {\r\n      return `(${customCode})()`;\r\n    }\r\n    return customCode.replace(/;$/, '');\r\n  }\r\n};\r\n\r\n/**\r\n * Utility to measure elapsed time using the Node.js process.hrtime() method.\r\n *\r\n * @returns {function(): number} - A function to calculate the elapsed time\r\n * in milliseconds.\r\n */\r\nexport const measureTime = () => {\r\n  const start = process.hrtime.bigint();\r\n  return () => Number(process.hrtime.bigint() - start) / 1000000;\r\n};\r\n\r\nexport default {\r\n  __dirname,\r\n  clearText,\r\n  expBackoff,\r\n  fixType,\r\n  handleResources,\r\n  isCorrectJSON,\r\n  isObject,\r\n  isObjectEmpty,\r\n  isPrivateRangeUrlFound,\r\n  optionsStringify,\r\n  printLogo,\r\n  printUsage,\r\n  roundNumber,\r\n  toBoolean,\r\n  wrapAround,\r\n  measureTime\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { existsSync, readFileSync, promises as fsPromises } from 'fs';\r\n\r\nimport prompts from 'prompts';\r\n\r\nimport {\r\n  absoluteProps,\r\n  defaultConfig,\r\n  nestedArgs,\r\n  promptsConfig\r\n} from './schemas/config.js';\r\nimport { envs } from './envs.js';\r\nimport { log, logWithStack } from './logger.js';\r\nimport { deepCopy, isObject, printUsage, toBoolean } from './utils.js';\r\n\r\nlet generalOptions = {};\r\n\r\n/**\r\n * Retrieves and returns the general options for the export process.\r\n *\r\n * @returns {Object} The general options object.\r\n */\r\nexport const getOptions = () => generalOptions;\r\n\r\n/**\r\n * Initializes and sets the general options for the server instace, keeping\r\n * the principle of the options load priority. It accepts optional userOptions\r\n * and args from the CLI.\r\n *\r\n * @param {Object} userOptions - User-provided options for customization.\r\n * @param {Array} args - Command-line arguments for additional configuration\r\n * (CLI usage).\r\n *\r\n * @returns {Object} The updated general options object.\r\n */\r\nexport const setOptions = (userOptions, args) => {\r\n  // Only for the CLI usage\r\n  if (args?.length) {\r\n    // Get the additional options from the custom JSON file\r\n    generalOptions = loadConfigFile(args);\r\n  }\r\n\r\n  // Update the default config with a correct option values\r\n  updateDefaultConfig(defaultConfig, generalOptions);\r\n\r\n  // Set values for server's options and returns them\r\n  generalOptions = initOptions(defaultConfig);\r\n\r\n  // Apply user options if there are any\r\n  if (userOptions) {\r\n    // Merge user options\r\n    generalOptions = mergeConfigOptions(\r\n      generalOptions,\r\n      userOptions,\r\n      absoluteProps\r\n    );\r\n  }\r\n\r\n  // Only for the CLI usage\r\n  if (args?.length) {\r\n    // Pair provided arguments\r\n    generalOptions = pairArgumentValue(generalOptions, args, defaultConfig);\r\n  }\r\n\r\n  // Return final general options\r\n  return generalOptions;\r\n};\r\n\r\n/**\r\n * Allows manual configuration based on specified prompts and saves\r\n * the configuration to a file.\r\n *\r\n * @param {string} configFileName - The name of the configuration file.\r\n *\r\n * @returns {Promise<boolean>} A Promise that resolves to true once the manual\r\n * configuration is completed and saved.\r\n */\r\nexport const manualConfig = async (configFileName) => {\r\n  // Prepare a config object\r\n  let configFile = {};\r\n\r\n  // Check if provided config file exists\r\n  if (existsSync(configFileName)) {\r\n    configFile = JSON.parse(readFileSync(configFileName, 'utf8'));\r\n  }\r\n\r\n  // Question about a configuration category\r\n  const onSubmit = async (p, categories) => {\r\n    let questionsCounter = 0;\r\n    let allQuestions = [];\r\n\r\n    // Create a corresponding property in the manualConfig object\r\n    for (const section of categories) {\r\n      // Mark each option with a section\r\n      promptsConfig[section] = promptsConfig[section].map((option) => ({\r\n        ...option,\r\n        section\r\n      }));\r\n\r\n      // Collect the questions\r\n      allQuestions = [...allQuestions, ...promptsConfig[section]];\r\n    }\r\n\r\n    await prompts(allQuestions, {\r\n      onSubmit: async (prompt, answer) => {\r\n        // Get the default module scripts\r\n        if (prompt.name === 'moduleScripts') {\r\n          answer = answer.length\r\n            ? answer.map((module) => prompt.choices[module])\r\n            : prompt.choices;\r\n\r\n          configFile[prompt.section][prompt.name] = answer;\r\n        } else {\r\n          configFile[prompt.section] = recursiveProps(\r\n            Object.assign({}, configFile[prompt.section] || {}),\r\n            prompt.name.split('.'),\r\n            prompt.choices ? prompt.choices[answer] : answer\r\n          );\r\n        }\r\n\r\n        if (++questionsCounter === allQuestions.length) {\r\n          try {\r\n            await fsPromises.writeFile(\r\n              configFileName,\r\n              JSON.stringify(configFile, null, 2),\r\n              'utf8'\r\n            );\r\n          } catch (error) {\r\n            logWithStack(\r\n              1,\r\n              error,\r\n              `[config] An error occurred while creating the ${configFileName} file.`\r\n            );\r\n          }\r\n          return true;\r\n        }\r\n      }\r\n    });\r\n\r\n    return true;\r\n  };\r\n\r\n  // Find the categories\r\n  const choices = Object.keys(promptsConfig).map((choice) => ({\r\n    title: `${choice} options`,\r\n    value: choice\r\n  }));\r\n\r\n  // Category prompt\r\n  return prompts(\r\n    {\r\n      type: 'multiselect',\r\n      name: 'category',\r\n      message: 'Which category do you want to configure?',\r\n      hint: 'Space: Select specific, A: Select all, Enter: Confirm.',\r\n      instructions: '',\r\n      choices\r\n    },\r\n    { onSubmit }\r\n  );\r\n};\r\n\r\n/**\r\n * Maps old-structured (PhantomJS) options to a new configuration format\r\n * (Puppeteer).\r\n *\r\n * @param {Object} oldOptions - Old-structured options to be mapped.\r\n *\r\n * @returns {Object} New options structured based on the defined nestedArgs\r\n * mapping.\r\n */\r\nexport const mapToNewConfig = (oldOptions) => {\r\n  const newOptions = {};\r\n  // Cycle through old-structured options\r\n  for (const [key, value] of Object.entries(oldOptions)) {\r\n    const propertiesChain = nestedArgs[key] ? nestedArgs[key].split('.') : [];\r\n\r\n    // Populate object in correct properties levels\r\n    propertiesChain.reduce(\r\n      (obj, prop, index) =>\r\n        (obj[prop] =\r\n          propertiesChain.length - 1 === index ? value : obj[prop] || {}),\r\n      newOptions\r\n    );\r\n  }\r\n  return newOptions;\r\n};\r\n\r\n/**\r\n * Merges two sets of configuration options, considering absolute properties.\r\n *\r\n * @param {Object} options - Original configuration options.\r\n * @param {Object} newOptions - New configuration options to be merged.\r\n * @param {Array} absoluteProps - List of properties that should\r\n * not be recursively merged.\r\n *\r\n * @returns {Object} Merged configuration options.\r\n */\r\nexport const mergeConfigOptions = (options, newOptions, absoluteProps = []) => {\r\n  const mergedOptions = deepCopy(options);\r\n\r\n  for (const [key, value] of Object.entries(newOptions)) {\r\n    mergedOptions[key] =\r\n      isObject(value) &&\r\n      !absoluteProps.includes(key) &&\r\n      mergedOptions[key] !== undefined\r\n        ? mergeConfigOptions(mergedOptions[key], value, absoluteProps)\r\n        : value !== undefined\r\n          ? value\r\n          : mergedOptions[key];\r\n  }\r\n\r\n  return mergedOptions;\r\n};\r\n\r\n/**\r\n * Initializes export settings based on provided exportOptions\r\n * and generalOptions.\r\n *\r\n * @param {Object} exportOptions - Options specific to the export process.\r\n * @param {Object} generalOptions - General configuration options.\r\n *\r\n * @returns {Object} Initialized export settings.\r\n */\r\nexport const initExportSettings = (exportOptions, generalOptions = {}) => {\r\n  let options = {};\r\n\r\n  if (exportOptions.svg) {\r\n    options = deepCopy(generalOptions);\r\n    options.export.type = exportOptions.type || exportOptions.export.type;\r\n    options.export.scale = exportOptions.scale || exportOptions.export.scale;\r\n    options.export.outfile =\r\n      exportOptions.outfile || exportOptions.export.outfile;\r\n    options.payload = {\r\n      svg: exportOptions.svg\r\n    };\r\n  } else {\r\n    options = mergeConfigOptions(\r\n      generalOptions,\r\n      exportOptions,\r\n      // Omit going down recursively with the belows\r\n      absoluteProps\r\n    );\r\n  }\r\n\r\n  options.export.outfile =\r\n    options.export?.outfile || `chart.${options.export?.type || 'png'}`;\r\n  return options;\r\n};\r\n\r\n/**\r\n * Loads additional configuration from a specified file using\r\n * the --loadConfig option.\r\n *\r\n * @param {Array} args - Command-line arguments to check for\r\n * the --loadConfig option.\r\n *\r\n * @returns {Object} Additional configuration loaded from the specified file,\r\n * or an empty object if not found or invalid.\r\n */\r\nfunction loadConfigFile(args) {\r\n  // Check if the --loadConfig option was used\r\n  const configIndex = args.findIndex(\r\n    (arg) => arg.replace(/-/g, '') === 'loadConfig'\r\n  );\r\n\r\n  // Check if the --loadConfig has a value\r\n  if (configIndex > -1 && args[configIndex + 1]) {\r\n    const fileName = args[configIndex + 1];\r\n    try {\r\n      // Check if an additional config file is a correct JSON file\r\n      if (fileName && fileName.endsWith('.json')) {\r\n        // Load an optional custom JSON config file\r\n        return JSON.parse(readFileSync(fileName));\r\n      }\r\n    } catch (error) {\r\n      logWithStack(\r\n        2,\r\n        error,\r\n        `[config] Unable to load the configuration from the ${fileName} file.`\r\n      );\r\n    }\r\n  }\r\n\r\n  // No additional options to return\r\n  return {};\r\n}\r\n\r\n/**\r\n * Updates the default configuration object with values from a custom object\r\n * and environment variables.\r\n *\r\n * @param {Object} configObj - The default configuration object.\r\n * @param {Object} customObj - Custom configuration object to override defaults.\r\n * @param {string} propChain - Property chain for tracking nested properties\r\n * during recursion.\r\n */\r\nfunction updateDefaultConfig(configObj, customObj = {}, propChain = '') {\r\n  Object.keys(configObj).forEach((key) => {\r\n    const entry = configObj[key];\r\n    const customValue = customObj && customObj[key];\r\n\r\n    if (typeof entry.value === 'undefined') {\r\n      updateDefaultConfig(entry, customValue, `${propChain}.${key}`);\r\n    } else {\r\n      // If a value from a custom JSON exists, it take precedence\r\n      if (customValue !== undefined) {\r\n        entry.value = customValue;\r\n      }\r\n\r\n      // If a value from an env variable exists, it take precedence\r\n      if (entry.envLink in envs && envs[entry.envLink] !== undefined) {\r\n        entry.value = envs[entry.envLink];\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Initializes options object based on provided items, setting values from\r\n * nested properties recursively.\r\n *\r\n * @param {Object} items - Configuration items to be used for initializing\r\n * options.\r\n *\r\n * @returns {Object} Initialized options object.\r\n */\r\nfunction initOptions(items) {\r\n  let options = {};\r\n  for (const [name, item] of Object.entries(items)) {\r\n    options[name] = Object.prototype.hasOwnProperty.call(item, 'value')\r\n      ? item.value\r\n      : initOptions(item);\r\n  }\r\n  return options;\r\n}\r\n\r\n/**\r\n * Pairs argument values with corresponding options in the configuration,\r\n * updating the options object.\r\n *\r\n * @param {Object} options - Configuration options object to be updated.\r\n * @param {Array} args - Command-line arguments containing values for specific\r\n * options.\r\n * @param {Object} defaultConfig - Default configuration object for reference.\r\n *\r\n * @returns {Object} Updated options object.\r\n */\r\nfunction pairArgumentValue(options, args, defaultConfig) {\r\n  let showUsage = false;\r\n  for (let i = 0; i < args.length; i++) {\r\n    const option = args[i].replace(/-/g, '');\r\n\r\n    // Find the right place for property's value\r\n    const propertiesChain = nestedArgs[option]\r\n      ? nestedArgs[option].split('.')\r\n      : [];\r\n\r\n    // Get the correct type for CLI args which are passed as strings\r\n    let argumentType;\r\n    propertiesChain.reduce((obj, prop, index) => {\r\n      if (propertiesChain.length - 1 === index) {\r\n        argumentType = obj[prop].type;\r\n      }\r\n      return obj[prop];\r\n    }, defaultConfig);\r\n\r\n    propertiesChain.reduce((obj, prop, index) => {\r\n      if (propertiesChain.length - 1 === index) {\r\n        // Finds an option and set a corresponding value\r\n        if (typeof obj[prop] !== 'undefined') {\r\n          if (args[++i]) {\r\n            if (argumentType === 'boolean') {\r\n              obj[prop] = toBoolean(args[i]);\r\n            } else if (argumentType === 'number') {\r\n              obj[prop] = +args[i];\r\n            } else if (argumentType.indexOf(']') >= 0) {\r\n              obj[prop] = args[i].split(',');\r\n            } else {\r\n              obj[prop] = args[i];\r\n            }\r\n          } else {\r\n            log(\r\n              2,\r\n              `[config] Missing value for the '${option}' argument. Using the default value.`\r\n            );\r\n            showUsage = true;\r\n          }\r\n        }\r\n      }\r\n      return obj[prop];\r\n    }, options);\r\n  }\r\n\r\n  // Display the usage for the reference if needed\r\n  if (showUsage) {\r\n    printUsage(defaultConfig);\r\n  }\r\n\r\n  return options;\r\n}\r\n\r\n/**\r\n * Recursively updates properties in an object based on nested names and assigns\r\n * the final value.\r\n *\r\n * @param {Object} objectToUpdate - The object to be updated.\r\n * @param {Array} nestedNames - Array of nested property names.\r\n * @param {any} value - The final value to be assigned.\r\n *\r\n * @returns {Object} Updated object with assigned values.\r\n */\r\nfunction recursiveProps(objectToUpdate, nestedNames, value) {\r\n  while (nestedNames.length > 1) {\r\n    const propName = nestedNames.shift();\r\n\r\n    // Create a property in object if it doesn't exist\r\n    if (!Object.prototype.hasOwnProperty.call(objectToUpdate, propName)) {\r\n      objectToUpdate[propName] = {};\r\n    }\r\n\r\n    // Call function again if there still names to go\r\n    objectToUpdate[propName] = recursiveProps(\r\n      Object.assign({}, objectToUpdate[propName]),\r\n      nestedNames,\r\n      value\r\n    );\r\n\r\n    return objectToUpdate;\r\n  }\r\n\r\n  // Assign the final value\r\n  objectToUpdate[nestedNames[0]] = value;\r\n  return objectToUpdate;\r\n}\r\n\r\nexport default {\r\n  getOptions,\r\n  setOptions,\r\n  manualConfig,\r\n  mapToNewConfig,\r\n  mergeConfigOptions,\r\n  initExportSettings\r\n};\r\n","/**\r\n * This module exports two functions: fetch (for GET requests) and post (for POST requests).\r\n */\r\n\r\nimport http from 'http';\r\nimport https from 'https';\r\n\r\n/**\r\n * Returns the HTTP or HTTPS protocol module based on the provided URL.\r\n *\r\n * @param {string} url - The URL to determine the protocol.\r\n *\r\n * @returns {Object} The HTTP or HTTPS protocol module (http or https).\r\n */\r\nconst getProtocol = (url) => (url.startsWith('https') ? https : http);\r\n\r\n/**\r\n * Fetches data from the specified URL using either HTTP or HTTPS protocol.\r\n *\r\n * @param {string} url - The URL to fetch data from.\r\n * @param {Object} requestOptions - Options for the HTTP request (optional).\r\n *\r\n * @returns {Promise<Object>} Promise resolving to the HTTP response object\r\n * with added 'text' property or rejecting with an error.\r\n */\r\nasync function fetch(url, requestOptions = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    const protocol = getProtocol(url);\r\n\r\n    protocol\r\n      .get(\r\n        url,\r\n        Object.assign(\r\n          {\r\n            headers: {\r\n              'User-Agent': 'highcharts/export',\r\n              Referer: 'highcharts/export'\r\n            }\r\n          },\r\n          requestOptions || {}\r\n        ),\r\n        (res) => {\r\n          let data = '';\r\n\r\n          // A chunk of data has been received.\r\n          res.on('data', (chunk) => {\r\n            data += chunk;\r\n          });\r\n\r\n          // The whole response has been received.\r\n          res.on('end', () => {\r\n            if (!data) {\r\n              reject('Nothing was fetched from the URL.');\r\n            }\r\n\r\n            res.text = data;\r\n            resolve(res);\r\n          });\r\n        }\r\n      )\r\n      .on('error', (error) => {\r\n        reject(error);\r\n      });\r\n  });\r\n}\r\n\r\n/**\r\n * Sends a POST request to the specified URL with the provided JSON body using\r\n * either HTTP or HTTPS protocol.\r\n *\r\n * @param {string} url - The URL to send the POST request to.\r\n * @param {Object} body - The JSON body to include in the POST request\r\n * (optional, default is an empty object).\r\n * @param {Object} requestOptions - Options for the HTTP request (optional).\r\n *\r\n * @returns {Promise<Object>} Promise resolving to the HTTP response object with\r\n * added 'text' property or rejecting with an error.\r\n */\r\nasync function post(url, body = {}, requestOptions = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    const protocol = getProtocol(url);\r\n    const data = JSON.stringify(body);\r\n\r\n    // Set default headers and merge with requestOptions\r\n    const options = Object.assign(\r\n      {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Content-Length': data.length\r\n        }\r\n      },\r\n      requestOptions\r\n    );\r\n\r\n    const req = protocol\r\n      .request(url, options, (res) => {\r\n        let responseData = '';\r\n\r\n        // A chunk of data has been received.\r\n        res.on('data', (chunk) => {\r\n          responseData += chunk;\r\n        });\r\n\r\n        // The whole response has been received.\r\n        res.on('end', () => {\r\n          try {\r\n            res.text = responseData;\r\n            resolve(res);\r\n          } catch (error) {\r\n            reject(error);\r\n          }\r\n        });\r\n      })\r\n      .on('error', (error) => {\r\n        reject(error);\r\n      });\r\n\r\n    // Write the request body and end the request.\r\n    req.write(data);\r\n    req.end();\r\n  });\r\n}\r\n\r\nexport default fetch;\r\nexport { fetch, post };\r\n","class ExportError extends Error {\r\n  constructor(message) {\r\n    super();\r\n    this.message = message;\r\n    this.stackMessage = message;\r\n  }\r\n\r\n  setError(error) {\r\n    this.error = error;\r\n    if (error.name) {\r\n      this.name = error.name;\r\n    }\r\n    if (error.statusCode) {\r\n      this.statusCode = error.statusCode;\r\n    }\r\n    if (error.stack) {\r\n      this.stackMessage = error.message;\r\n      this.stack = error.stack;\r\n    }\r\n    return this;\r\n  }\r\n}\r\n\r\nexport default ExportError;\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n// The cache manager manages the Highcharts library and its dependencies.\r\n// The cache itself is stored in .cache, and is checked by the config system\r\n// before starting the service\r\n\r\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from 'fs';\r\nimport { join } from 'path';\r\n\r\nimport { HttpsProxyAgent } from 'https-proxy-agent';\r\n\r\nimport { getOptions } from './config.js';\r\nimport { envs } from './envs.js';\r\nimport { fetch } from './fetch.js';\r\nimport { log } from './logger.js';\r\nimport { __dirname } from './utils.js';\r\n\r\nimport ExportError from './errors/ExportError.js';\r\n\r\nconst cache = {\r\n  cdnURL: 'https://code.highcharts.com/',\r\n  activeManifest: {},\r\n  sources: '',\r\n  hcVersion: ''\r\n};\r\n\r\n/**\r\n * Extracts and caches the Highcharts version from the sources string.\r\n *\r\n * @returns {string} The extracted Highcharts version.\r\n */\r\nexport const extractVersion = (cache) => {\r\n  return cache.sources\r\n    .substring(0, cache.sources.indexOf('*/'))\r\n    .replace('/*', '')\r\n    .replace('*/', '')\r\n    .replace(/\\n/g, '')\r\n    .trim();\r\n};\r\n\r\n/**\r\n * Extracts the Highcharts module name based on the scriptPath.\r\n */\r\nexport const extractModuleName = (scriptPath) => {\r\n  return scriptPath.replace(\r\n    /(.*)\\/|(.*)modules\\/|stock\\/(.*)indicators\\/|maps\\/(.*)modules\\//gi,\r\n    ''\r\n  );\r\n};\r\n\r\n/**\r\n * Saves the provided configuration and fetched modules to the cache manifest\r\n * file.\r\n *\r\n * @param {object} config - Highcharts-related configuration object.\r\n * @param {object} fetchedModules - An object that contains mapped names of\r\n * fetched Highcharts modules to use.\r\n *\r\n * @throws {ExportError} Throws an ExportError if an error occurs while writing\r\n * the cache manifest.\r\n */\r\nexport const saveConfigToManifest = async (config, fetchedModules) => {\r\n  const newManifest = {\r\n    version: config.version,\r\n    modules: fetchedModules || {}\r\n  };\r\n\r\n  // Update cache object with the current modules\r\n  cache.activeManifest = newManifest;\r\n\r\n  log(3, '[cache] Writing a new manifest.');\r\n  try {\r\n    writeFileSync(\r\n      join(__dirname, config.cachePath, 'manifest.json'),\r\n      JSON.stringify(newManifest),\r\n      'utf8'\r\n    );\r\n  } catch (error) {\r\n    throw new ExportError('[cache] Error writing the cache manifest.').setError(\r\n      error\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Fetches a single script and updates the fetchedModules accordingly.\r\n *\r\n * @param {string} script - A path to script to get.\r\n * @param {Object} requestOptions - Additional options for the proxy agent\r\n * to use for a request.\r\n * @param {Object} fetchedModules - An object which tracks which Highcharts\r\n * modules have been fetched.\r\n * @param {boolean} shouldThrowError - A flag to indicate if the error should be\r\n * thrown. This should be used only for the core scripts.\r\n *\r\n * @returns {Promise<string>} A Promise resolving to the text representation\r\n * of the fetched script.\r\n *\r\n * @throws {ExportError} Throws an ExportError if there is a problem with\r\n * fetching the script.\r\n */\r\nexport const fetchAndProcessScript = async (\r\n  script,\r\n  requestOptions,\r\n  fetchedModules,\r\n  shouldThrowError = false\r\n) => {\r\n  // Get rid of the .js from the custom strings\r\n  if (script.endsWith('.js')) {\r\n    script = script.substring(0, script.length - 3);\r\n  }\r\n\r\n  log(4, `[cache] Fetching script - ${script}.js`);\r\n\r\n  // Fetch the script\r\n  const response = await fetch(`${script}.js`, requestOptions);\r\n\r\n  // If OK, return its text representation\r\n  if (response.statusCode === 200 && typeof response.text == 'string') {\r\n    if (fetchedModules) {\r\n      const moduleName = extractModuleName(script);\r\n      fetchedModules[moduleName] = 1;\r\n    }\r\n\r\n    return response.text;\r\n  }\r\n\r\n  if (shouldThrowError) {\r\n    throw new ExportError(\r\n      `Could not fetch the ${script}.js. The script might not exist in the requested version (status code: ${response.statusCode}).`\r\n    ).setError(response);\r\n  } else {\r\n    log(\r\n      2,\r\n      `[cache] Could not fetch the ${script}.js. The script might not exist in the requested version.`\r\n    );\r\n  }\r\n\r\n  return '';\r\n};\r\n\r\n/**\r\n * Fetches Highcharts scripts and customScripts from the given CDNs.\r\n *\r\n * @param {string} coreScripts - Array of Highcharts core scripts to fetch.\r\n * @param {string} moduleScripts - Array of Highcharts modules to fetch.\r\n * @param {string} customScripts - Array of custom script paths to fetch\r\n * (full URLs).\r\n * @param {object} proxyOptions - Options for the proxy agent to use for\r\n * a request.\r\n * @param {object} fetchedModules - An object which tracks which Highcharts\r\n * modules have been fetched.\r\n *\r\n * @returns {Promise<string>} The fetched scripts content joined.\r\n */\r\nexport const fetchScripts = async (\r\n  coreScripts,\r\n  moduleScripts,\r\n  customScripts,\r\n  proxyOptions,\r\n  fetchedModules\r\n) => {\r\n  // Configure proxy if exists\r\n  let proxyAgent;\r\n  const { host, port, username, password } = proxyOptions;\r\n\r\n  // Try to create a Proxy Agent\r\n  if (host && port) {\r\n    try {\r\n      proxyAgent = new HttpsProxyAgent({\r\n        host,\r\n        port,\r\n        ...(username && password ? { username, password } : {})\r\n      });\r\n    } catch (error) {\r\n      throw new ExportError('[cache] Could not create a Proxy Agent.').setError(\r\n        error\r\n      );\r\n    }\r\n  }\r\n\r\n  // If exists, add proxy agent to request options\r\n  const requestOptions = proxyAgent\r\n    ? {\r\n        agent: proxyAgent,\r\n        timeout: envs.SERVER_PROXY_TIMEOUT\r\n      }\r\n    : {};\r\n\r\n  const allFetchPromises = [\r\n    ...coreScripts.map((script) =>\r\n      fetchAndProcessScript(`${script}`, requestOptions, fetchedModules, true)\r\n    ),\r\n    ...moduleScripts.map((script) =>\r\n      fetchAndProcessScript(`${script}`, requestOptions, fetchedModules)\r\n    ),\r\n    ...customScripts.map((script) =>\r\n      fetchAndProcessScript(`${script}`, requestOptions)\r\n    )\r\n  ];\r\n\r\n  const fetchedScripts = await Promise.all(allFetchPromises);\r\n  return fetchedScripts.join(';\\n');\r\n};\r\n\r\n/**\r\n * Updates the local cache with Highcharts scripts and their versions.\r\n *\r\n * @param {Object} options - Object containing all options.\r\n * @param {string} sourcePath - The path to the source file in the cache.\r\n *\r\n * @returns {Promise<object>} A Promise resolving to an object representing\r\n * the fetched modules.\r\n *\r\n * @throws {ExportError} Throws an ExportError if there is an issue updating\r\n * the local Highcharts cache.\r\n */\r\nexport const updateCache = async (\r\n  highchartsOptions,\r\n  proxyOptions,\r\n  sourcePath\r\n) => {\r\n  const version = highchartsOptions.version;\r\n  const hcVersion = version === 'latest' || !version ? '' : `${version}/`;\r\n  const cdnURL = highchartsOptions.cdnURL || cache.cdnURL;\r\n\r\n  log(\r\n    3,\r\n    `[cache] Updating cache version to Highcharts: ${hcVersion || 'latest'}.`\r\n  );\r\n\r\n  const fetchedModules = {};\r\n  try {\r\n    cache.sources = await fetchScripts(\r\n      [\r\n        ...highchartsOptions.coreScripts.map((c) => `${cdnURL}${hcVersion}${c}`)\r\n      ],\r\n      [\r\n        ...highchartsOptions.moduleScripts.map((m) =>\r\n          m === 'map'\r\n            ? `${cdnURL}maps/${hcVersion}modules/${m}`\r\n            : `${cdnURL}${hcVersion}modules/${m}`\r\n        ),\r\n        ...highchartsOptions.indicatorScripts.map(\r\n          (i) => `${cdnURL}stock/${hcVersion}indicators/${i}`\r\n        )\r\n      ],\r\n      highchartsOptions.customScripts,\r\n      proxyOptions,\r\n      fetchedModules\r\n    );\r\n\r\n    cache.hcVersion = extractVersion(cache);\r\n\r\n    // Save the fetched modules into caches' source JSON\r\n    writeFileSync(sourcePath, cache.sources);\r\n    return fetchedModules;\r\n  } catch (error) {\r\n    throw new ExportError(\r\n      '[cache] Unable to update the local Highcharts cache.'\r\n    ).setError(error);\r\n  }\r\n};\r\n\r\n/**\r\n * Updates the Highcharts version in the applied configuration and checks\r\n * the cache for the new version.\r\n *\r\n * @param {string} newVersion - The new Highcharts version to be applied.\r\n *\r\n * @returns {Promise<(object|boolean)>} A Promise resolving to the updated\r\n * configuration with the new version, or false if no applied configuration\r\n * exists.\r\n */\r\nexport const updateVersion = async (newVersion) => {\r\n  const options = getOptions();\r\n  if (options?.highcharts) {\r\n    options.highcharts.version = newVersion;\r\n  }\r\n  await checkAndUpdateCache(options);\r\n};\r\n\r\n/**\r\n * Checks the cache for Highcharts dependencies, updates the cache if needed,\r\n * and loads the sources.\r\n *\r\n * @param {Object} options - Object containing all options.\r\n *\r\n * @returns {Promise<void>} A Promise that resolves once the cache is checked\r\n * and updated.\r\n *\r\n * @throws {ExportError} Throws an ExportError if there is an issue updating\r\n * or reading the cache.\r\n */\r\nexport const checkAndUpdateCache = async (options) => {\r\n  const { highcharts, server } = options;\r\n  const cachePath = join(__dirname, highcharts.cachePath);\r\n\r\n  let fetchedModules;\r\n  // Prepare paths to manifest and sources from the .cache folder\r\n  const manifestPath = join(cachePath, 'manifest.json');\r\n  const sourcePath = join(cachePath, 'sources.js');\r\n\r\n  // Create the cache destination if it doesn't exist already\r\n  !existsSync(cachePath) && mkdirSync(cachePath);\r\n\r\n  // Fetch all the scripts either if manifest.json does not exist\r\n  // or if the forceFetch option is enabled\r\n  if (!existsSync(manifestPath) || highcharts.forceFetch) {\r\n    log(3, '[cache] Fetching and caching Highcharts dependencies.');\r\n    fetchedModules = await updateCache(highcharts, server.proxy, sourcePath);\r\n  } else {\r\n    let requestUpdate = false;\r\n\r\n    // Read the manifest JSON\r\n    const manifest = JSON.parse(readFileSync(manifestPath));\r\n\r\n    // Check if the modules is an array, if so, we rewrite it to a map to make\r\n    // it easier to resolve modules.\r\n    if (manifest.modules && Array.isArray(manifest.modules)) {\r\n      const moduleMap = {};\r\n      manifest.modules.forEach((m) => (moduleMap[m] = 1));\r\n      manifest.modules = moduleMap;\r\n    }\r\n\r\n    const { coreScripts, moduleScripts, indicatorScripts } = highcharts;\r\n    const numberOfModules =\r\n      coreScripts.length + moduleScripts.length + indicatorScripts.length;\r\n\r\n    // Compare the loaded highcharts config with the contents in cache.\r\n    // If there are changes, fetch requested modules and products,\r\n    // and bake them into a giant blob. Save the blob.\r\n    if (manifest.version !== highcharts.version) {\r\n      log(\r\n        2,\r\n        '[cache] A Highcharts version mismatch in the cache, need to re-fetch.'\r\n      );\r\n      requestUpdate = true;\r\n    } else if (Object.keys(manifest.modules || {}).length !== numberOfModules) {\r\n      log(\r\n        2,\r\n        '[cache] The cache and the requested modules do not match, need to re-fetch.'\r\n      );\r\n      requestUpdate = true;\r\n    } else {\r\n      // Check each module, if anything is missing refetch everything\r\n      requestUpdate = (moduleScripts || []).some((moduleName) => {\r\n        if (!manifest.modules[moduleName]) {\r\n          log(\r\n            2,\r\n            `[cache] The ${moduleName} is missing in the cache, need to re-fetch.`\r\n          );\r\n          return true;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (requestUpdate) {\r\n      fetchedModules = await updateCache(highcharts, server.proxy, sourcePath);\r\n    } else {\r\n      log(3, '[cache] Dependency cache is up to date, proceeding.');\r\n\r\n      // Load the sources\r\n      cache.sources = readFileSync(sourcePath, 'utf8');\r\n\r\n      // Get current modules map\r\n      fetchedModules = manifest.modules;\r\n\r\n      cache.hcVersion = extractVersion(cache);\r\n    }\r\n  }\r\n\r\n  // Finally, save the new manifest, which is basically our current config\r\n  // in a slightly different format\r\n  await saveConfigToManifest(highcharts, fetchedModules);\r\n};\r\n\r\nexport const getCachePath = () =>\r\n  join(__dirname, getOptions().highcharts.cachePath);\r\n\r\nexport const getCache = () => cache;\r\n\r\nexport const highcharts = () => cache.sources;\r\n\r\nexport const version = () => cache.hcVersion;\r\n\r\nexport default {\r\n  checkAndUpdateCache,\r\n  getCachePath,\r\n  updateVersion,\r\n  getCache,\r\n  highcharts,\r\n  version\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n/* eslint-disable no-undef */\r\n\r\n/**\r\n * Setting the animObject. Called when initing the page.\r\n */\r\nexport function setupHighcharts() {\r\n  Highcharts.animObject = function () {\r\n    return { duration: 0 };\r\n  };\r\n}\r\n\r\n/**\r\n * Creates the actual chart.\r\n *\r\n * @param {object} chartOptions - The options for the Highcharts chart.\r\n * @param {object} options - The export options.\r\n * @param {boolean} displayErrors - A flag indicating whether to display errors.\r\n */\r\nexport async function triggerExport(chartOptions, options, displayErrors) {\r\n  // Display errors flag taken from chart options nad debugger module\r\n  window._displayErrors = displayErrors;\r\n\r\n  // Get required functions\r\n  const { getOptions, merge, setOptions, wrap } = Highcharts;\r\n\r\n  // Create a separate object for a potential setOptions usages in order to\r\n  // prevent from polluting other exports that can happen on the same page\r\n  Highcharts.setOptionsObj = merge(false, {}, getOptions());\r\n\r\n  // By default animation is disabled\r\n  const chart = {\r\n    animation: false\r\n  };\r\n\r\n  // When straight inject, the size is set through CSS only\r\n  if (options.export.strInj) {\r\n    chart.height = chartOptions.chart.height;\r\n    chart.width = chartOptions.chart.width;\r\n  }\r\n\r\n  // NOTE: Is this used for anything useful?\r\n  window.isRenderComplete = false;\r\n  wrap(Highcharts.Chart.prototype, 'init', function (proceed, userOptions, cb) {\r\n    // Override userOptions with image friendly options\r\n    userOptions = merge(userOptions, {\r\n      exporting: {\r\n        enabled: false\r\n      },\r\n      plotOptions: {\r\n        series: {\r\n          label: {\r\n            enabled: false\r\n          }\r\n        }\r\n      },\r\n      /* Expects tooltip in userOptions when forExport is true.\r\n        https://github.com/highcharts/highcharts/blob/3ad430a353b8056b9e764aa4e5cd6828aa479db2/js/parts/Chart.js#L241\r\n        */\r\n      tooltip: {}\r\n    });\r\n\r\n    (userOptions.series || []).forEach(function (series) {\r\n      series.animation = false;\r\n    });\r\n\r\n    // Add flag to know if chart render has been called.\r\n    if (!window.onHighchartsRender) {\r\n      window.onHighchartsRender = Highcharts.addEvent(this, 'render', () => {\r\n        window.isRenderComplete = true;\r\n      });\r\n    }\r\n\r\n    proceed.apply(this, [userOptions, cb]);\r\n  });\r\n\r\n  wrap(Highcharts.Series.prototype, 'init', function (proceed, chart, options) {\r\n    proceed.apply(this, [chart, options]);\r\n  });\r\n\r\n  // Get the user options\r\n  const userOptions = options.export.strInj\r\n    ? new Function(`return ${options.export.strInj}`)()\r\n    : chartOptions;\r\n\r\n  // Trigger custom code\r\n  if (options.customLogic.customCode) {\r\n    new Function('options', options.customLogic.customCode)(userOptions);\r\n  }\r\n\r\n  // Merge the globalOptions, themeOptions, options from the wrapped\r\n  // setOptions function and user options to create the final options object\r\n  const finalOptions = merge(\r\n    false,\r\n    JSON.parse(options.export.themeOptions),\r\n    userOptions,\r\n    // Placed it here instead in the init because of the size issues\r\n    { chart }\r\n  );\r\n\r\n  const finalCallback = options.customLogic.callback\r\n    ? new Function(`return ${options.customLogic.callback}`)()\r\n    : undefined;\r\n\r\n  // Set the global options if exist\r\n  const globalOptions = JSON.parse(options.export.globalOptions);\r\n  if (globalOptions) {\r\n    setOptions(globalOptions);\r\n  }\r\n\r\n  let constr = options.export.constr || 'chart';\r\n  constr = typeof Highcharts[constr] !== 'undefined' ? constr : 'chart';\r\n\r\n  Highcharts[constr]('container', finalOptions, finalCallback);\r\n\r\n  // Get the current global options\r\n  const defaultOptions = getOptions();\r\n\r\n  // Clear it just in case (e.g. the setOptions was used in the customCode)\r\n  for (const prop in defaultOptions) {\r\n    if (typeof defaultOptions[prop] !== 'function') {\r\n      delete defaultOptions[prop];\r\n    }\r\n  }\r\n\r\n  // Set the default options back\r\n  setOptions(Highcharts.setOptionsObj);\r\n\r\n  // Empty the custom global options object\r\n  Highcharts.setOptionsObj = {};\r\n}\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { readFileSync } from 'fs';\r\nimport path from 'path';\r\n\r\nimport puppeteer from 'puppeteer';\r\n\r\nimport { getCachePath } from './cache.js';\r\nimport { getOptions } from './config.js';\r\nimport { setupHighcharts } from './highcharts.js';\r\nimport { log, logWithStack } from './logger.js';\r\nimport { __dirname } from './utils.js';\r\n\r\nimport ExportError from './errors/ExportError.js';\r\n\r\n// Get the template for the page\r\nconst template = readFileSync(__dirname + '/templates/template.html', 'utf8');\r\n\r\nlet browser;\r\n\r\n/**\r\n * Retrieves the existing Puppeteer browser instance.\r\n *\r\n * @returns {Promise<object>} A Promise resolving to the Puppeteer browser\r\n * instance.\r\n *\r\n * @throws {ExportError} Throws an ExportError if no valid browser has been\r\n * created.\r\n */\r\nexport function get() {\r\n  if (!browser) {\r\n    throw new ExportError('[browser] No valid browser has been created.');\r\n  }\r\n  return browser;\r\n}\r\n\r\n/**\r\n * Creates a Puppeteer browser instance with the specified arguments.\r\n *\r\n * @param {Array} puppeteerArgs - Additional arguments for Puppeteer launch.\r\n *\r\n * @returns {Promise<object>} A Promise resolving to the Puppeteer browser\r\n * instance.\r\n *\r\n * @throws {ExportError} Throws an ExportError if max retries to open a browser\r\n * instance are reached, or if no browser instance is found after retries.\r\n */\r\nexport async function create(puppeteerArgs) {\r\n  // Get debug and other options\r\n  const { puppeteer: puppeteerOptions, debug, other } = getOptions();\r\n\r\n  // Get the debug options\r\n  const { enable: enabledDebug, ...debugOptions } = debug;\r\n\r\n  const launchOptions = {\r\n    headless: other.browserShellMode ? 'shell' : true,\r\n    userDataDir: puppeteerOptions.tempDir || './tmp/',\r\n    args: puppeteerArgs,\r\n    handleSIGINT: false,\r\n    handleSIGTERM: false,\r\n    handleSIGHUP: false,\r\n    waitForInitialPage: false,\r\n    defaultViewport: null,\r\n    ...(enabledDebug && debugOptions)\r\n  };\r\n\r\n  // Create a browser\r\n  if (!browser) {\r\n    let tryCount = 0;\r\n\r\n    const open = async () => {\r\n      try {\r\n        log(\r\n          3,\r\n          `[browser] Attempting to get a browser instance (try ${++tryCount}).`\r\n        );\r\n        browser = await puppeteer.launch(launchOptions);\r\n      } catch (error) {\r\n        logWithStack(\r\n          1,\r\n          error,\r\n          '[browser] Failed to launch a browser instance.'\r\n        );\r\n\r\n        // Retry to launch browser until reaching max attempts\r\n        if (tryCount < 25) {\r\n          log(3, `[browser] Retry to open a browser (${tryCount} out of 25).`);\r\n          await new Promise((response) => setTimeout(response, 4000));\r\n          await open();\r\n        } else {\r\n          throw error;\r\n        }\r\n      }\r\n    };\r\n\r\n    try {\r\n      await open();\r\n\r\n      // Shell mode inform\r\n      if (launchOptions.headless === 'shell') {\r\n        log(3, `[browser] Launched browser in shell mode.`);\r\n      }\r\n\r\n      // Debug mode inform\r\n      if (enabledDebug) {\r\n        log(3, `[browser] Launched browser in debug mode.`);\r\n      }\r\n    } catch (error) {\r\n      throw new ExportError(\r\n        '[browser] Maximum retries to open a browser instance reached.'\r\n      ).setError(error);\r\n    }\r\n\r\n    if (!browser) {\r\n      throw new ExportError('[browser] Cannot find a browser to open.');\r\n    }\r\n  }\r\n\r\n  // Return a browser promise\r\n  return browser;\r\n}\r\n\r\n/**\r\n * Closes the Puppeteer browser instance if it is connected.\r\n *\r\n * @returns {Promise<boolean>} A Promise resolving to true after the browser\r\n * is closed.\r\n */\r\nexport async function close() {\r\n  // Close the browser when connnected\r\n  if (browser?.connected) {\r\n    await browser.close();\r\n  }\r\n  log(4, '[browser] Closed the browser.');\r\n}\r\n\r\n/**\r\n * Creates a new Puppeteer Page within an existing browser instance.\r\n *\r\n * If the browser instance is not available, returns false.\r\n *\r\n * The function creates a new page, disables caching, sets content using\r\n * setPageContent(), and returns the created Puppeteer Page.\r\n *\r\n * @returns {(boolean|object)} Returns false if the browser instance is not\r\n * available, or a Puppeteer Page object representing the newly created page.\r\n */\r\nexport async function newPage() {\r\n  if (!browser) {\r\n    return false;\r\n  }\r\n\r\n  // Create a page\r\n  const page = await browser.newPage();\r\n\r\n  // Disable cache\r\n  await page.setCacheEnabled(false);\r\n\r\n  // Set the content\r\n  await setPageContent(page);\r\n\r\n  // Set page events\r\n  setPageEvents(page);\r\n\r\n  return page;\r\n}\r\n\r\n/**\r\n * Clears the content of a Puppeteer Page based on the specified mode.\r\n *\r\n * @param {Object} page - The Puppeteer Page object to be cleared.\r\n * @param {boolean} hardReset - A flag indicating the type of clearing\r\n * to be performed. If true, navigates to 'about:blank' and resets content\r\n * and scripts. If false, clears the body content by setting a predefined HTML\r\n * structure.\r\n *\r\n * @throws {Error} Logs thrown error if clearing the page content fails.\r\n */\r\nexport async function clearPage(page, hardReset = false) {\r\n  try {\r\n    if (page && !page.isClosed()) {\r\n      if (hardReset) {\r\n        // Navigate to about:blank\r\n        await page.goto('about:blank', { waitUntil: 'domcontentloaded' });\r\n\r\n        // Set the content and and scripts again\r\n        await setPageContent(page);\r\n      } else {\r\n        // Clear body content\r\n        await page.evaluate(() => {\r\n          document.body.innerHTML =\r\n            '<div id=\"chart-container\"><div id=\"container\"></div></div>';\r\n        });\r\n      }\r\n      return true;\r\n    }\r\n  } catch (error) {\r\n    logWithStack(\r\n      2,\r\n      error,\r\n      '[browser] Could not clear the content of the page.'\r\n    );\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Adds custom JS and CSS resources to a Puppeteer Page based on the specified\r\n * options.\r\n *\r\n * @param {Object} page - The Puppeteer Page object to which resources will be\r\n * added.\r\n * @param {Object} options - All options and configuration.\r\n *\r\n * @returns {Promise<Array<Object>>} - Promise resolving to an array of injected\r\n * resources.\r\n */\r\nexport async function addPageResources(page, options) {\r\n  // Injected resources array\r\n  const injectedResources = [];\r\n\r\n  // Use resources\r\n  const resources = options.customLogic.resources;\r\n  if (resources) {\r\n    const injectedJs = [];\r\n\r\n    // Load custom JS code\r\n    if (resources.js) {\r\n      injectedJs.push({\r\n        content: resources.js\r\n      });\r\n    }\r\n\r\n    // Load scripts from all custom files\r\n    if (resources.files) {\r\n      for (const file of resources.files) {\r\n        const isLocal = !file.startsWith('http') ? true : false;\r\n\r\n        // Add each custom script from resources' files\r\n        injectedJs.push(\r\n          isLocal\r\n            ? {\r\n                content: readFileSync(file, 'utf8')\r\n              }\r\n            : {\r\n                url: file\r\n              }\r\n        );\r\n      }\r\n    }\r\n\r\n    for (const jsResource of injectedJs) {\r\n      try {\r\n        injectedResources.push(await page.addScriptTag(jsResource));\r\n      } catch (error) {\r\n        logWithStack(2, error, `[export] The JS resource cannot be loaded.`);\r\n      }\r\n    }\r\n    injectedJs.length = 0;\r\n\r\n    // Load CSS\r\n    const injectedCss = [];\r\n    if (resources.css) {\r\n      let cssImports = resources.css.match(/@import\\s*([^;]*);/g);\r\n      if (cssImports) {\r\n        // Handle css section\r\n        for (let cssImportPath of cssImports) {\r\n          if (cssImportPath) {\r\n            cssImportPath = cssImportPath\r\n              .replace('url(', '')\r\n              .replace('@import', '')\r\n              .replace(/\"/g, '')\r\n              .replace(/'/g, '')\r\n              .replace(/;/, '')\r\n              .replace(/\\)/g, '')\r\n              .trim();\r\n\r\n            // Add each custom css from resources\r\n            if (cssImportPath.startsWith('http')) {\r\n              injectedCss.push({\r\n                url: cssImportPath\r\n              });\r\n            } else if (options.customLogic.allowFileResources) {\r\n              injectedCss.push({\r\n                path: path.join(__dirname, cssImportPath)\r\n              });\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // The rest of the CSS section will be content by now\r\n      injectedCss.push({\r\n        content: resources.css.replace(/@import\\s*([^;]*);/g, '') || ' '\r\n      });\r\n\r\n      for (const cssResource of injectedCss) {\r\n        try {\r\n          injectedResources.push(await page.addStyleTag(cssResource));\r\n        } catch (error) {\r\n          logWithStack(2, error, `[export] The CSS resource cannot be loaded.`);\r\n        }\r\n      }\r\n      injectedCss.length = 0;\r\n    }\r\n  }\r\n  return injectedResources;\r\n}\r\n\r\n/**\r\n * Clears out all state set on the page with addScriptTag/addStyleTag. Removes\r\n * injected resources and resets CSS and script tags on the page. Additionally,\r\n * it destroys previously existing charts.\r\n *\r\n * @param {Object} page - The Puppeteer Page object from which resources will\r\n * be cleared.\r\n * @param {Array<Object>} injectedResources - Array of injected resources\r\n * to be cleared.\r\n */\r\nexport async function clearPageResources(page, injectedResources) {\r\n  try {\r\n    for (const resource of injectedResources) {\r\n      await resource.dispose();\r\n    }\r\n\r\n    // Destroy old charts after export is done and reset all CSS and script tags\r\n    await page.evaluate(() => {\r\n      // We are not guaranteed that Highcharts is loaded, e,g, when doing SVG\r\n      // exports\r\n      if (typeof Highcharts !== 'undefined') {\r\n        // eslint-disable-next-line no-undef\r\n        const oldCharts = Highcharts.charts;\r\n\r\n        // Check in any already existing charts\r\n        if (Array.isArray(oldCharts) && oldCharts.length) {\r\n          // Destroy old charts\r\n          for (const oldChart of oldCharts) {\r\n            oldChart && oldChart.destroy();\r\n            // eslint-disable-next-line no-undef\r\n            Highcharts.charts.shift();\r\n          }\r\n        }\r\n      }\r\n\r\n      // eslint-disable-next-line no-undef\r\n      const [...scriptsToRemove] = document.getElementsByTagName('script');\r\n      // eslint-disable-next-line no-undef\r\n      const [, ...stylesToRemove] = document.getElementsByTagName('style');\r\n      // eslint-disable-next-line no-undef\r\n      const [...linksToRemove] = document.getElementsByTagName('link');\r\n\r\n      // Remove tags\r\n      for (const element of [\r\n        ...scriptsToRemove,\r\n        ...stylesToRemove,\r\n        ...linksToRemove\r\n      ]) {\r\n        element.remove();\r\n      }\r\n    });\r\n  } catch (error) {\r\n    logWithStack(2, error, `[browser] Could not clear page's resources.`);\r\n  }\r\n}\r\n\r\n/**\r\n * Sets the content for a Puppeteer Page using a predefined template\r\n * and additional scripts. Also, sets the pageerror in order to catch\r\n * and display errors from the window context.\r\n *\r\n * @param {Object} page - The Puppeteer Page object for which the content\r\n * is being set.\r\n */\r\nasync function setPageContent(page) {\r\n  await page.setContent(template, { waitUntil: 'domcontentloaded' });\r\n\r\n  // Add all registered Higcharts scripts, quite demanding\r\n  await page.addScriptTag({ path: `${getCachePath()}/sources.js` });\r\n\r\n  // Set the initial animObject\r\n  await page.evaluate(setupHighcharts);\r\n}\r\n\r\n/**\r\n * Set events for a Puppeteer Page.\r\n *\r\n * @param {Object} page - The Puppeteer Page object to set events to.\r\n */\r\nfunction setPageEvents(page) {\r\n  // Get debug options\r\n  const { debug } = getOptions();\r\n\r\n  // Set the console listener, if needed\r\n  if (debug.enable && debug.listenToConsole) {\r\n    page.on('console', (message) => {\r\n      console.log(`[debug] ${message.text()}`);\r\n    });\r\n  }\r\n\r\n  // Set the pageerror listener\r\n  page.on('pageerror', async (error) => {\r\n    // It would seem like this may fire at the same time or shortly before\r\n    // a page is closed.\r\n    if (page.isClosed()) {\r\n      return;\r\n    }\r\n\r\n    // TODO: Consider adding a switch here that turns on log(0) logging\r\n    // on page errors.\r\n    await page.$eval(\r\n      '#container',\r\n      (element, errorMessage) => {\r\n        // eslint-disable-next-line no-undef\r\n        if (window._displayErrors) {\r\n          element.innerHTML = errorMessage;\r\n        }\r\n      },\r\n      `<h1>Chart input data error: </h1>${error.toString()}`\r\n    );\r\n  });\r\n}\r\n\r\nexport default {\r\n  get,\r\n  create,\r\n  close,\r\n  newPage,\r\n  clearPage,\r\n  addPageResources,\r\n  clearPageResources\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { addPageResources, clearPageResources } from './browser.js';\r\nimport { getCache } from './cache.js';\r\nimport { triggerExport } from './highcharts.js';\r\nimport { log } from './logger.js';\r\n\r\nimport svgTemplate from './../templates/svg_export/svg_export.js';\r\n\r\nimport ExportError from './errors/ExportError.js';\r\n\r\n/**\r\n * Retrieves the clipping region coordinates of the specified page element with\r\n * the id 'chart-container'.\r\n *\r\n * @param {Object} page - Puppeteer page object.\r\n *\r\n * @returns {Promise<Object>} Promise resolving to an object containing\r\n * x, y, width, and height properties.\r\n */\r\nconst getClipRegion = (page) =>\r\n  page.$eval('#chart-container', (element) => {\r\n    const { x, y, width, height } = element.getBoundingClientRect();\r\n    return {\r\n      x,\r\n      y,\r\n      width,\r\n      height: Math.trunc(height > 1 ? height : 500)\r\n    };\r\n  });\r\n\r\n/**\r\n * Creates an image using Puppeteer's page screenshot functionality with\r\n * specified options.\r\n *\r\n * @param {Object} page - Puppeteer page object.\r\n * @param {string} type - Image type.\r\n * @param {string} encoding - Image encoding.\r\n * @param {Object} clip - Clipping region coordinates.\r\n * @param {number} rasterizationTimeout - Timeout for rasterization\r\n * in milliseconds.\r\n *\r\n * @returns {Promise<Buffer>} Promise resolving to the image buffer or rejecting\r\n * with an ExportError for timeout.\r\n */\r\nconst createImage = (page, type, encoding, clip, rasterizationTimeout) =>\r\n  Promise.race([\r\n    page.screenshot({\r\n      type,\r\n      encoding,\r\n      clip,\r\n      captureBeyondViewport: true,\r\n      fullPage: false,\r\n      optimizeForSpeed: true,\r\n      ...(type !== 'png' ? { quality: 80 } : {}),\r\n\r\n      // #447, #463 - always render on a transparent page if the expected type\r\n      // format is PNG\r\n      omitBackground: type == 'png'\r\n    }),\r\n    new Promise((_resolve, reject) =>\r\n      setTimeout(\r\n        () => reject(new ExportError('Rasterization timeout')),\r\n        rasterizationTimeout || 1500\r\n      )\r\n    )\r\n  ]);\r\n\r\n/**\r\n * Creates a PDF using Puppeteer's page pdf functionality with specified\r\n * options.\r\n *\r\n * @param {Object} page - Puppeteer page object.\r\n * @param {number} height - PDF height.\r\n * @param {number} width - PDF width.\r\n * @param {string} encoding - PDF encoding.\r\n *\r\n * @returns {Promise<Buffer>} Promise resolving to the PDF buffer.\r\n */\r\nconst createPDF = async (\r\n  page,\r\n  height,\r\n  width,\r\n  encoding,\r\n  rasterizationTimeout\r\n) => {\r\n  await page.emulateMediaType('screen');\r\n\r\n  return page.pdf({\r\n    // This will remove an extra empty page in PDF exports\r\n    height: height + 1,\r\n    width,\r\n    encoding,\r\n    timeout: rasterizationTimeout || 1500\r\n  });\r\n};\r\n\r\n/**\r\n * Creates an SVG string by evaluating the outerHTML of the first 'svg' element\r\n * inside an element with the id 'container'.\r\n *\r\n * @param {Object} page - Puppeteer page object.\r\n *\r\n * @returns {Promise<string>} Promise resolving to the SVG string.\r\n */\r\nconst createSVG = (page) =>\r\n  page.$eval('#container svg:first-of-type', (element) => element.outerHTML);\r\n\r\n/**\r\n * Sets the specified chart and options as configuration into the triggerExport\r\n * function within the window context using page.evaluate.\r\n *\r\n * @param {Object} page - Puppeteer page object.\r\n * @param {any} chart - The chart object to be configured.\r\n * @param {Object} options - Configuration options for the chart.\r\n *\r\n * @returns {Promise<void>} Promise resolving after the configuration is set.\r\n */\r\nconst setAsConfig = async (page, chart, options, displayErrors) => {\r\n  // Get rid of the redunant string data\r\n  options.export.instr = null;\r\n  options.export.infile = null;\r\n\r\n  // Get the size of the export input\r\n  const totalSize = Buffer.byteLength(\r\n    options.export?.strInj ? options.export?.strInj : JSON.stringify(chart),\r\n    'utf-8'\r\n  );\r\n\r\n  // Log the size in MB\r\n  log(\r\n    3,\r\n    `[export] The current total size of data passed to a page is around ${(\r\n      totalSize /\r\n      (1024 * 1024)\r\n    ).toFixed(2)} MB`\r\n  );\r\n\r\n  // Check the size of data passed to the page\r\n  if (totalSize >= 100 * 1024 * 1024) {\r\n    throw new ExportError(`[export] The data passed to a page exceeded 100MB.`);\r\n  }\r\n\r\n  // Trigger the Highcharts chart creation\r\n  return page.evaluate(triggerExport, chart, options, displayErrors);\r\n};\r\n\r\n/**\r\n * Exports to a chart from a page using Puppeteer.\r\n *\r\n * @param {Object} page - Puppeteer page object.\r\n * @param {any} chart - The chart object or SVG configuration to be exported.\r\n * @param {Object} options - Export options and configuration.\r\n *\r\n * @returns {Promise<string | Buffer | ExportError>} Promise resolving to\r\n * the exported data or rejecting with an ExportError.\r\n */\r\nexport default async (page, chart, options) => {\r\n  // Injected resources array (additional JS and CSS)\r\n  let injectedResources = [];\r\n\r\n  try {\r\n    log(4, '[export] Determining export path.');\r\n\r\n    const exportOptions = options.export;\r\n\r\n    // Decide whether display error or debbuger wrapper around it\r\n    const displayErrors =\r\n      exportOptions?.options?.chart?.displayErrors &&\r\n      getCache().activeManifest.modules.debugger;\r\n\r\n    let isSVG;\r\n    if (\r\n      chart.indexOf &&\r\n      (chart.indexOf('<svg') >= 0 || chart.indexOf('<?xml') >= 0)\r\n    ) {\r\n      // SVG input handling\r\n      log(4, '[export] Treating as SVG.');\r\n\r\n      // If input is also SVG, just return it\r\n      if (exportOptions.type === 'svg') {\r\n        return chart;\r\n      }\r\n\r\n      isSVG = true;\r\n      await page.setContent(svgTemplate(chart), {\r\n        waitUntil: 'domcontentloaded'\r\n      });\r\n    } else {\r\n      // JSON config handling\r\n      log(4, '[export] Treating as config.');\r\n\r\n      // Need to perform straight inject\r\n      if (exportOptions.strInj) {\r\n        // Injection based configuration export\r\n        await setAsConfig(\r\n          page,\r\n          {\r\n            chart: {\r\n              height: exportOptions.height,\r\n              width: exportOptions.width\r\n            }\r\n          },\r\n          options,\r\n          displayErrors\r\n        );\r\n      } else {\r\n        // Basic configuration export\r\n        chart.chart.height = exportOptions.height;\r\n        chart.chart.width = exportOptions.width;\r\n\r\n        await setAsConfig(page, chart, options, displayErrors);\r\n      }\r\n    }\r\n\r\n    // Keeps track of all resources added on the page with addXXXTag. etc\r\n    // It's VITAL that all added resources ends up here so we can clear things\r\n    // out when doing a new export in the same page!\r\n    injectedResources = await addPageResources(page, options);\r\n\r\n    // Get the real chart size and set the zoom accordingly\r\n    const size = isSVG\r\n      ? await page.evaluate((scale) => {\r\n          const svgElement = document.querySelector(\r\n            '#chart-container svg:first-of-type'\r\n          );\r\n\r\n          // Get the values correctly scaled\r\n          const chartHeight = svgElement.height.baseVal.value * scale;\r\n          const chartWidth = svgElement.width.baseVal.value * scale;\r\n\r\n          // In case of SVG the zoom must be set directly for body\r\n          // Set the zoom as scale\r\n          // eslint-disable-next-line no-undef\r\n          document.body.style.zoom = scale;\r\n\r\n          // Set the margin to 0px\r\n          // eslint-disable-next-line no-undef\r\n          document.body.style.margin = '0px';\r\n\r\n          return {\r\n            chartHeight,\r\n            chartWidth\r\n          };\r\n        }, parseFloat(exportOptions.scale))\r\n      : await page.evaluate(() => {\r\n          // eslint-disable-next-line no-undef\r\n          const { chartHeight, chartWidth } = window.Highcharts.charts[0];\r\n\r\n          // No need for such scale manipulation in case of other types of exports\r\n          // Reset the zoom for other exports than to SVGs\r\n          // eslint-disable-next-line no-undef\r\n          document.body.style.zoom = 1;\r\n\r\n          return {\r\n            chartHeight,\r\n            chartWidth\r\n          };\r\n        });\r\n\r\n    // Set final height and width for viewport\r\n    const viewportHeight = Math.abs(\r\n      Math.ceil(size.chartHeight || exportOptions.height)\r\n    );\r\n    const viewportWidth = Math.abs(\r\n      Math.ceil(size.chartWidth || exportOptions.width)\r\n    );\r\n\r\n    // Get the clip region for the page\r\n    const { x, y } = await getClipRegion(page);\r\n\r\n    // Set the final viewport now that we have the real height\r\n    await page.setViewport({\r\n      height: viewportHeight,\r\n      width: viewportWidth,\r\n      deviceScaleFactor: isSVG ? 1 : parseFloat(exportOptions.scale)\r\n    });\r\n\r\n    let data;\r\n    // Rasterization process\r\n    if (exportOptions.type === 'svg') {\r\n      // SVG\r\n      data = await createSVG(page);\r\n    } else if (['png', 'jpeg'].includes(exportOptions.type)) {\r\n      // PNG or JPEG\r\n      data = await createImage(\r\n        page,\r\n        exportOptions.type,\r\n        'base64',\r\n        {\r\n          width: viewportWidth,\r\n          height: viewportHeight,\r\n          x,\r\n          y\r\n        },\r\n        exportOptions.rasterizationTimeout\r\n      );\r\n    } else if (exportOptions.type === 'pdf') {\r\n      // PDF\r\n      data = await createPDF(\r\n        page,\r\n        viewportHeight,\r\n        viewportWidth,\r\n        'base64',\r\n        exportOptions.rasterizationTimeout\r\n      );\r\n    } else {\r\n      throw new ExportError(\r\n        `[export] Unsupported output format ${exportOptions.type}.`\r\n      );\r\n    }\r\n\r\n    // Clear previously injected JS and CSS resources\r\n    await clearPageResources(page, injectedResources);\r\n    return data;\r\n  } catch (error) {\r\n    await clearPageResources(page, injectedResources);\r\n    return error;\r\n  }\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport cssTemplate from './css.js';\r\n\r\nexport default (chart) => `\r\n<!DOCTYPE html>\r\n<html lang='en-US'>\r\n  <head>\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\r\n    <title>Highcharts Export</title>\r\n  </head>\r\n  <style>\r\n    ${cssTemplate()}\r\n  </style>\r\n  <body>\r\n    <div id=\"chart-container\">\r\n      ${chart}\r\n    </div>\r\n  </body>\r\n</html>\r\n\r\n`;\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { Pool } from 'tarn';\r\nimport { v4 as uuid } from 'uuid';\r\n\r\nimport {\r\n  create as createBrowser,\r\n  close as closeBrowser,\r\n  newPage,\r\n  clearPage\r\n} from './browser.js';\r\nimport puppeteerExport from './export.js';\r\nimport { log, logWithStack } from './logger.js';\r\nimport { measureTime } from './utils.js';\r\n\r\nimport ExportError from './errors/ExportError.js';\r\n\r\n// The pool instance\r\nlet pool = false;\r\n\r\n// Pool statistics\r\nexport const stats = {\r\n  performedExports: 0,\r\n  exportAttempts: 0,\r\n  exportFromSvgAttempts: 0,\r\n  timeSpent: 0,\r\n  droppedExports: 0,\r\n  spentAverage: 0\r\n};\r\n\r\nlet poolConfig = {};\r\n\r\nconst factory = {\r\n  /**\r\n   * Creates a new worker page for the export pool.\r\n   *\r\n   * @returns {Object} - An object containing the worker ID, a reference to the\r\n   * browser page, and initial work count.\r\n   *\r\n   * @throws {ExportError} - If there's an error during the creation of the new\r\n   * page.\r\n   */\r\n  create: async () => {\r\n    let page = false;\r\n\r\n    const id = uuid();\r\n    const startDate = new Date().getTime();\r\n\r\n    try {\r\n      page = await newPage();\r\n\r\n      if (!page || page.isClosed()) {\r\n        throw new ExportError('The page is invalid or closed.');\r\n      }\r\n\r\n      log(\r\n        3,\r\n        `[pool] Successfully created a worker ${id} - took ${\r\n          new Date().getTime() - startDate\r\n        } ms.`\r\n      );\r\n    } catch (error) {\r\n      throw new ExportError(\r\n        'Error encountered when creating a new page.'\r\n      ).setError(error);\r\n    }\r\n\r\n    return {\r\n      id,\r\n      page,\r\n      // Try to distribute the initial work count\r\n      workCount: Math.round(Math.random() * (poolConfig.workLimit / 2))\r\n    };\r\n  },\r\n\r\n  /**\r\n   * Validates a worker page in the export pool, checking if it has exceeded\r\n   * the work limit.\r\n   *\r\n   * @param {Object} workerHandle - The handle to the worker, containing the\r\n   * worker's ID, a reference to the browser page, and work count.\r\n   *\r\n   * @returns {boolean} - Returns true if the worker is valid and within\r\n   * the work limit; otherwise, returns false.\r\n   */\r\n  validate: async (workerHandle) => {\r\n    // NOTE: In certain cases acquiring throws a TargetCloseError, which may\r\n    //       be caused by two things:\r\n    //         - The page is closed and attempted to be reused.\r\n    //         - Lost contact with the browser\r\n    //       What we're seeing in logs is that successive exports typically\r\n    //       succeeds, and the server recovers, indicating that it's likely\r\n    //       the first case. This is an attempt at allievating the issue by\r\n    //       simply not validating the worker if the page is null or closed.\r\n    //\r\n    //       The actual result from when this happened, was that a worker would\r\n    //       be completely locked, stopping it from being acquired until\r\n    //       its work count reached the limit.\r\n    if (!workerHandle.page || workerHandle.page?.isClosed()) {\r\n      return false;\r\n    }\r\n\r\n    if (\r\n      poolConfig.workLimit &&\r\n      ++workerHandle.workCount > poolConfig.workLimit\r\n    ) {\r\n      log(\r\n        3,\r\n        `[pool] Worker failed validation: exceeded work limit (limit is ${poolConfig.workLimit}).`\r\n      );\r\n      return false;\r\n    }\r\n    return true;\r\n  },\r\n\r\n  /**\r\n   * Destroys a worker entry in the export pool, closing its associated page.\r\n   *\r\n   * @param {Object} workerHandle - The handle to the worker, containing\r\n   * the worker's ID and a reference to the browser page.\r\n   */\r\n  destroy: async (workerHandle) => {\r\n    log(3, `[pool] Destroying pool entry ${workerHandle.id}.`);\r\n\r\n    if (workerHandle.page && !workerHandle.page.isClosed()) {\r\n      await workerHandle.page.close();\r\n    }\r\n  }\r\n\r\n  // log: (message, level) => log(1, '[tarn] ' +  message)\r\n};\r\n\r\n/**\r\n * Initializes the export pool with the provided configuration, creating\r\n * a browser instance and setting up worker resources.\r\n *\r\n * @param {Object} config - Configuration options for the export pool along\r\n * with custom puppeteer arguments for the puppeteer.launch function.\r\n */\r\nexport const initPool = async (config) => {\r\n  // For the module scope usage\r\n  poolConfig = config && config.pool ? { ...config.pool } : {};\r\n\r\n  // Create a browser instance with the puppeteer arguments\r\n  await createBrowser(config.puppeteerArgs);\r\n\r\n  log(\r\n    3,\r\n    `[pool] Initializing pool with workers: min ${poolConfig.minWorkers}, max ${poolConfig.maxWorkers}.`\r\n  );\r\n\r\n  if (pool) {\r\n    return log(\r\n      4,\r\n      '[pool] Already initialized, please kill it before creating a new one.'\r\n    );\r\n  }\r\n\r\n  if (parseInt(poolConfig.minWorkers) > parseInt(poolConfig.maxWorkers)) {\r\n    poolConfig.minWorkers = poolConfig.maxWorkers;\r\n  }\r\n\r\n  try {\r\n    // Create a pool along with a minimal number of resources\r\n    pool = new Pool({\r\n      // Get the create/validate/destroy/log functions\r\n      ...factory,\r\n      min: parseInt(poolConfig.minWorkers),\r\n      max: parseInt(poolConfig.maxWorkers),\r\n      acquireTimeoutMillis: poolConfig.acquireTimeout,\r\n      createTimeoutMillis: poolConfig.createTimeout,\r\n      destroyTimeoutMillis: poolConfig.destroyTimeout,\r\n      idleTimeoutMillis: poolConfig.idleTimeout,\r\n      createRetryIntervalMillis: poolConfig.createRetryInterval,\r\n      reapIntervalMillis: poolConfig.reaperInterval,\r\n      propagateCreateError: false\r\n    });\r\n\r\n    // Set events\r\n    pool.on('release', async (resource) => {\r\n      // Clear page\r\n      const r = await clearPage(resource.page, false);\r\n      log(\r\n        4,\r\n        `[pool] Releasing a worker with ID ${resource.id}. Clear page status: ${r}.`\r\n      );\r\n    });\r\n\r\n    pool.on('destroySuccess', (eventId, resource) => {\r\n      log(4, `[pool] Destroyed a worker with ID ${resource.id}.`);\r\n      resource.page = null;\r\n    });\r\n\r\n    const initialResources = [];\r\n    // Create an initial number of resources\r\n    for (let i = 0; i < poolConfig.minWorkers; i++) {\r\n      try {\r\n        const resource = await pool.acquire().promise;\r\n        initialResources.push(resource);\r\n      } catch (error) {\r\n        logWithStack(2, error, '[pool] Could not create an initial resource.');\r\n      }\r\n    }\r\n\r\n    // Release the initial number of resources back to the pool\r\n    initialResources.forEach((resource) => {\r\n      pool.release(resource);\r\n    });\r\n\r\n    log(\r\n      3,\r\n      `[pool] The pool is ready${initialResources.length ? ` with ${initialResources.length} initial resources waiting.` : '.'}`\r\n    );\r\n  } catch (error) {\r\n    throw new ExportError(\r\n      '[pool] Could not create the pool of workers.'\r\n    ).setError(error);\r\n  }\r\n};\r\n\r\n/**\r\n * Kills all workers in the pool, destroys the pool, and closes the browser\r\n * instance.\r\n *\r\n * @returns {Promise<void>} A promise that resolves after the workers are\r\n * killed, the pool is destroyed, and the browser is closed.\r\n */\r\nexport async function killPool() {\r\n  log(3, '[pool] Killing pool with all workers and closing browser.');\r\n\r\n  // If still alive, destroy the pool of pages before closing a browser\r\n  if (pool) {\r\n    // Free up not released workers\r\n    for (const worker of pool.used) {\r\n      pool.release(worker.resource);\r\n    }\r\n\r\n    // Destroy the pool if it is still available\r\n    if (!pool.destroyed) {\r\n      await pool.destroy();\r\n      log(4, '[browser] Destroyed the pool of resources.');\r\n    }\r\n  }\r\n\r\n  // Close the browser instance\r\n  await closeBrowser();\r\n}\r\n\r\n/**\r\n * Processes the export work using a worker from the pool. Acquires a worker\r\n * handle from the pool, performs the export using puppeteer, and releases\r\n * the worker handle back to the pool.\r\n *\r\n * @param {string} chart - The chart data or configuration to be exported.\r\n * @param {Object} options - Export options and configuration.\r\n *\r\n * @returns {Promise<Object>} A promise that resolves with the export resultand\r\n * options.\r\n *\r\n * @throws {ExportError} If an error occurs during the export process.\r\n */\r\nexport const postWork = async (chart, options) => {\r\n  let workerHandle;\r\n\r\n  try {\r\n    log(4, '[pool] Work received, starting to process.');\r\n\r\n    ++stats.exportAttempts;\r\n    if (poolConfig.benchmarking) {\r\n      getPoolInfo();\r\n    }\r\n\r\n    if (!pool) {\r\n      throw new ExportError('Work received, but pool has not been started.');\r\n    }\r\n\r\n    // Acquire the worker along with the id of resource and work count\r\n    const acquireCounter = measureTime();\r\n    try {\r\n      log(4, '[pool] Acquiring a worker handle.');\r\n      workerHandle = await pool.acquire().promise;\r\n\r\n      // Check the page acquire time\r\n      if (options.server.benchmarking) {\r\n        log(\r\n          5,\r\n          options.payload?.requestId\r\n            ? `[benchmark] Request with ID ${options.payload?.requestId} -`\r\n            : '[benchmark]',\r\n          `Acquired a worker handle: ${acquireCounter()}ms.`\r\n        );\r\n      }\r\n    } catch (error) {\r\n      throw new ExportError(\r\n        (options.payload?.requestId\r\n          ? `For request with ID ${options.payload?.requestId} - `\r\n          : '') +\r\n          `Error encountered when acquiring an available entry: ${acquireCounter()}ms.`\r\n      ).setError(error);\r\n    }\r\n    log(4, '[pool] Acquired a worker handle.');\r\n\r\n    if (!workerHandle.page) {\r\n      throw new ExportError(\r\n        'Resolved worker page is invalid: the pool setup is wonky.'\r\n      );\r\n    }\r\n\r\n    // Save the start time\r\n    let workStart = new Date().getTime();\r\n\r\n    log(4, `[pool] Starting work on pool entry with ID ${workerHandle.id}.`);\r\n\r\n    // Perform an export on a puppeteer level\r\n    const exportCounter = measureTime();\r\n    const result = await puppeteerExport(workerHandle.page, chart, options);\r\n\r\n    // Check if it's an error\r\n    if (result instanceof Error) {\r\n      // NOTE: If there's a rasterization timeout, we want need to flush the page.\r\n      //       This is because the page may be in a state where it's waiting for\r\n      //       the screenshot to finish even though the timeout has occured.\r\n      //       Which of course causes a lot of issues with the event system,\r\n      //       and page consistency.\r\n      //\r\n      // NOTE: Only page.screenshot will throw this, timeouts for PDF's are\r\n      //       handled by the page.pdf function itself.\r\n      //\r\n      //       ...yes, this is ugly.\r\n      if (result.message === 'Rasterization timeout') {\r\n        workerHandle.workCount = poolConfig.workLimit + 1;\r\n        workerHandle.page = null;\r\n      }\r\n\r\n      if (\r\n        result.name === 'TimeoutError' ||\r\n        result.message === 'Rasterization timeout'\r\n      ) {\r\n        throw new ExportError(\r\n          'Rasterization timeout: your chart may be too complex or large, and failed to render within the allotted time.'\r\n        ).setError(result);\r\n      } else {\r\n        throw new ExportError(\r\n          (options.payload?.requestId\r\n            ? `For request with ID ${options.payload?.requestId} - `\r\n            : '') + `Error encountered during export: ${exportCounter()}ms.`\r\n        ).setError(result);\r\n      }\r\n    }\r\n\r\n    // Check the Puppeteer export time\r\n    if (options.server.benchmarking) {\r\n      log(\r\n        5,\r\n        options.payload?.requestId\r\n          ? `[benchmark] Request with ID ${options.payload?.requestId} -`\r\n          : '[benchmark]',\r\n        `Exported a chart sucessfully: ${exportCounter()}ms.`\r\n      );\r\n    }\r\n\r\n    // Release the resource back to the pool\r\n    pool.release(workerHandle);\r\n\r\n    // Used for statistics in averageTime and processedWorkCount, which\r\n    // in turn is used by the /health route.\r\n    const workEnd = new Date().getTime();\r\n    const exportTime = workEnd - workStart;\r\n    stats.timeSpent += exportTime;\r\n    stats.spentAverage = stats.timeSpent / ++stats.performedExports;\r\n\r\n    log(4, `[pool] Work completed in ${exportTime} ms.`);\r\n\r\n    // Otherwise return the result\r\n    return {\r\n      result,\r\n      options\r\n    };\r\n  } catch (error) {\r\n    ++stats.droppedExports;\r\n\r\n    if (workerHandle) {\r\n      pool.release(workerHandle);\r\n    }\r\n\r\n    throw new ExportError(`[pool] In pool.postWork: ${error.message}`).setError(\r\n      error\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Retrieves the current pool instance.\r\n *\r\n * @returns {Object|null} The current pool instance if initialized, or null\r\n * if the pool has not been created.\r\n */\r\nexport const getPool = () => pool;\r\n\r\n/**\r\n * Retrieves pool information in JSON format, including minimum and maximum\r\n * workers, available workers, workers in use, and pending acquire requests.\r\n *\r\n * @returns {Object} Pool information in JSON format.\r\n */\r\nexport const getPoolInfoJSON = () => ({\r\n  min: pool.min,\r\n  max: pool.max,\r\n  all: pool.numFree() + pool.numUsed(),\r\n  available: pool.numFree(),\r\n  used: pool.numUsed(),\r\n  pending: pool.numPendingAcquires()\r\n});\r\n\r\n/**\r\n * Logs information about the current state of the pool, including the minimum\r\n * and maximum workers, available workers, workers in use, and pending acquire\r\n * requests.\r\n */\r\nexport function getPoolInfo() {\r\n  const { min, max, all, available, used, pending } = getPoolInfoJSON();\r\n\r\n  log(5, `[pool] The minimum number of resources allowed by pool: ${min}.`);\r\n  log(5, `[pool] The maximum number of resources allowed by pool: ${max}.`);\r\n  log(5, `[pool] The number of all created resources: ${all}.`);\r\n  log(5, `[pool] The number of available resources: ${available}.`);\r\n  log(5, `[pool] The number of acquired resources: ${used}.`);\r\n  log(5, `[pool] The number of resources waiting to be acquired: ${pending}.`);\r\n}\r\n\r\nexport default {\r\n  initPool,\r\n  killPool,\r\n  postWork,\r\n  getPool,\r\n  getPoolInfo,\r\n  getPoolInfoJSON,\r\n  getStats: () => stats\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { readFileSync, writeFileSync } from 'fs';\r\n\r\nimport { getOptions, initExportSettings } from './config.js';\r\nimport { log, logWithStack } from './logger.js';\r\nimport { killPool, postWork, stats } from './pool.js';\r\nimport {\r\n  fixType,\r\n  handleResources,\r\n  isCorrectJSON,\r\n  optionsStringify,\r\n  roundNumber,\r\n  toBoolean,\r\n  wrapAround\r\n} from './utils.js';\r\nimport { sanitize } from './sanitize.js';\r\nimport ExportError from './errors/ExportError.js';\r\n\r\nlet allowCodeExecution = false;\r\n\r\n/**\r\n * Starts an export process. The `settings` contains final options gathered\r\n * from all possible sources (config, env, cli, json). The `endCallback` is\r\n * called when the export is completed, with an error object as the first\r\n * argument and the second containing the base64 respresentation of a chart.\r\n *\r\n * @param {Object} settings - The settings object containing export\r\n * configuration.\r\n * @param {function} endCallback - The callback function to be invoked upon\r\n * finalizing work or upon error occurance of the exporting process.\r\n *\r\n * @returns {void} This function does not return a value directly; instead,\r\n * it communicates results via the endCallback.\r\n */\r\nexport const startExport = async (settings, endCallback) => {\r\n  // Starting exporting process message\r\n  log(4, '[chart] Starting the exporting process.');\r\n\r\n  // Initialize options\r\n  const options = initExportSettings(settings, getOptions());\r\n\r\n  // Get the export options\r\n  const exportOptions = options.export;\r\n\r\n  // If SVG is an input (argument can be sent only by the request)\r\n  if (options.payload?.svg && options.payload.svg !== '') {\r\n    try {\r\n      log(4, '[chart] Attempting to export from a SVG input.');\r\n\r\n      const result = exportAsString(\r\n        sanitize(options.payload.svg), // #209\r\n        options,\r\n        endCallback\r\n      );\r\n\r\n      ++stats.exportFromSvgAttempts;\r\n      return result;\r\n    } catch (error) {\r\n      return endCallback(\r\n        new ExportError('[chart] Error loading SVG input.').setError(error)\r\n      );\r\n    }\r\n  }\r\n\r\n  // Export using options from the file\r\n  if (exportOptions.infile && exportOptions.infile.length) {\r\n    // Try to read the file to get the string representation\r\n    try {\r\n      log(4, '[chart] Attempting to export from an input file.');\r\n      options.export.instr = readFileSync(exportOptions.infile, 'utf8');\r\n      return exportAsString(options.export.instr.trim(), options, endCallback);\r\n    } catch (error) {\r\n      return endCallback(\r\n        new ExportError('[chart] Error loading input file.').setError(error)\r\n      );\r\n    }\r\n  }\r\n\r\n  // Export with options from the raw representation\r\n  if (\r\n    (exportOptions.instr && exportOptions.instr !== '') ||\r\n    (exportOptions.options && exportOptions.options !== '')\r\n  ) {\r\n    try {\r\n      log(4, '[chart] Attempting to export from a raw input.');\r\n\r\n      // Use whichever one is available\r\n      exportOptions.instr = exportOptions.instr || exportOptions.options;\r\n\r\n      // Perform a direct inject when forced\r\n      if (toBoolean(options.customLogic?.allowCodeExecution)) {\r\n        return doStraightInject(options, endCallback);\r\n      }\r\n\r\n      // Either try to parse to JSON first or do the direct export\r\n      return typeof exportOptions.instr === 'string'\r\n        ? exportAsString(exportOptions.instr.trim(), options, endCallback)\r\n        : doExport(\r\n            options,\r\n            exportOptions.instr || exportOptions.options,\r\n            endCallback\r\n          );\r\n    } catch (error) {\r\n      return endCallback(\r\n        new ExportError('[chart] Error loading raw input.').setError(error)\r\n      );\r\n    }\r\n  }\r\n\r\n  // No input specified, pass an error message to the callback\r\n  return endCallback(\r\n    new ExportError(\r\n      `[chart] No valid input specified. Check if at least one of the following parameters is correctly set: 'infile', 'instr', 'options', or 'svg'.`\r\n    )\r\n  );\r\n};\r\n\r\n/**\r\n * Starts a batch export process for multiple charts based on the information\r\n * in the batch option. The batch is a string in the following format:\r\n * \"infile1.json=outfile1.png;infile2.json=outfile2.png;...\"\r\n *\r\n * @param {Object} options - The options object containing configuration for\r\n * a batch export.\r\n *\r\n * @returns {Promise<void>} A Promise that resolves once the batch export\r\n * process is completed.\r\n *\r\n * @throws {ExportError} Throws an ExportError if an error occurs during\r\n * any of the batch export process.\r\n */\r\nexport const batchExport = async (options) => {\r\n  const batchFunctions = [];\r\n\r\n  // Split and pair the --batch arguments\r\n  for (let pair of options.export.batch.split(';')) {\r\n    pair = pair.split('=');\r\n    if (pair.length === 2) {\r\n      batchFunctions.push(\r\n        startExport(\r\n          {\r\n            ...options,\r\n            export: {\r\n              ...options.export,\r\n              infile: pair[0],\r\n              outfile: pair[1]\r\n            }\r\n          },\r\n          (error, info) => {\r\n            // Throw an error\r\n            if (error) {\r\n              throw error;\r\n            }\r\n\r\n            // Save the base64 from a buffer to a correct image file\r\n            writeFileSync(\r\n              info.options.export.outfile,\r\n              info.options.export.type !== 'svg'\r\n                ? Buffer.from(info.result, 'base64')\r\n                : info.result\r\n            );\r\n          }\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  try {\r\n    // Await all exports are done\r\n    await Promise.all(batchFunctions);\r\n\r\n    // Kill pool and close browser after finishing batch export\r\n    await killPool();\r\n  } catch (error) {\r\n    throw new ExportError(\r\n      '[chart] Error encountered during batch export.'\r\n    ).setError(error);\r\n  }\r\n};\r\n\r\n/**\r\n * Starts a single export process based on the specified options.\r\n *\r\n * @param {Object} options - The options object containing configuration for\r\n * a single export.\r\n *\r\n * @returns {Promise<void>} A Promise that resolves once the single export\r\n * process is completed.\r\n *\r\n * @throws {ExportError} Throws an ExportError if an error occurs during\r\n * the single export process.\r\n */\r\nexport const singleExport = async (options) => {\r\n  // Use instr or its alias, options\r\n  options.export.instr = options.export.instr || options.export.options;\r\n\r\n  // Perform an export\r\n  await startExport(options, async (error, info) => {\r\n    // Exit process when error\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    const { outfile, type } = info.options.export;\r\n\r\n    // Save the base64 from a buffer to a correct image file\r\n    writeFileSync(\r\n      outfile || `chart.${type}`,\r\n      type !== 'svg' ? Buffer.from(info.result, 'base64') : info.result\r\n    );\r\n\r\n    // Kill pool and close browser after finishing single export\r\n    await killPool();\r\n  });\r\n};\r\n\r\n/**\r\n * Determines the size and scale for chart export based on the provided options.\r\n *\r\n * @param {Object} options - The options object containing configuration for\r\n * chart export.\r\n *\r\n * @returns {Object} An object containing the calculated height, width,\r\n * and scale for the chart export.\r\n */\r\nexport const findChartSize = (options) => {\r\n  const { chart, exporting } =\r\n    options.export?.options || isCorrectJSON(options.export?.instr);\r\n\r\n  // See if globalOptions holds chart or exporting size\r\n  const globalOptions = isCorrectJSON(options.export?.globalOptions);\r\n\r\n  // Secure scale value\r\n  let scale =\r\n    options.export?.scale ||\r\n    exporting?.scale ||\r\n    globalOptions?.exporting?.scale ||\r\n    options.export?.defaultScale ||\r\n    1;\r\n\r\n  // the scale cannot be lower than 0.1 and cannot be higher than 5.0\r\n  scale = Math.max(0.1, Math.min(scale, 5.0));\r\n\r\n  // we want to round the numbers like 0.23234 -> 0.23\r\n  scale = roundNumber(scale, 2);\r\n\r\n  // Find chart size and scale\r\n  const size = {\r\n    height:\r\n      options.export?.height ||\r\n      exporting?.sourceHeight ||\r\n      chart?.height ||\r\n      globalOptions?.exporting?.sourceHeight ||\r\n      globalOptions?.chart?.height ||\r\n      options.export?.defaultHeight ||\r\n      400,\r\n    width:\r\n      options.export?.width ||\r\n      exporting?.sourceWidth ||\r\n      chart?.width ||\r\n      globalOptions?.exporting?.sourceWidth ||\r\n      globalOptions?.chart?.width ||\r\n      options.export?.defaultWidth ||\r\n      600,\r\n    scale\r\n  };\r\n\r\n  // Get rid of potential px and %\r\n  for (let [param, value] of Object.entries(size)) {\r\n    size[param] =\r\n      typeof value === 'string' ? +value.replace(/px|%/gi, '') : value;\r\n  }\r\n  return size;\r\n};\r\n\r\n/**\r\n * Function for finalizing options before export.\r\n *\r\n * @param {Object} options - The options object containing configuration for\r\n * the export process.\r\n * @param {Object} chartJson - The JSON representation of the chart.\r\n * @param {Function} endCallback - The callback function to be called upon\r\n * completion or error.\r\n * @param {string} svg - The SVG representation of the chart.\r\n *\r\n * @returns {Promise<void>} A Promise that resolves once the export process\r\n * is completed.\r\n */\r\nconst doExport = async (options, chartJson, endCallback, svg) => {\r\n  let { export: exportOptions, customLogic: customLogicOptions } = options;\r\n\r\n  const allowCodeExecutionScoped =\r\n    typeof customLogicOptions.allowCodeExecution === 'boolean'\r\n      ? customLogicOptions.allowCodeExecution\r\n      : allowCodeExecution;\r\n\r\n  if (!customLogicOptions) {\r\n    customLogicOptions = options.customLogic = {};\r\n  } else if (allowCodeExecutionScoped) {\r\n    if (typeof options.customLogic.resources === 'string') {\r\n      // Process resources\r\n      options.customLogic.resources = handleResources(\r\n        options.customLogic.resources,\r\n        toBoolean(options.customLogic.allowFileResources)\r\n      );\r\n    } else if (!options.customLogic.resources) {\r\n      try {\r\n        const resources = readFileSync('resources.json', 'utf8');\r\n        options.customLogic.resources = handleResources(\r\n          resources,\r\n          toBoolean(options.customLogic.allowFileResources)\r\n        );\r\n      } catch (error) {\r\n        log(2, `[chart] Unable to load the default resources.json file.`);\r\n      }\r\n    }\r\n  }\r\n\r\n  // If the allowCodeExecution flag isn't set, we should refuse the usage\r\n  // of callback, resources, and custom code. Additionally, the worker will\r\n  // refuse to run arbitrary JavaScript. Prioritized should be the scoped\r\n  // option, then we should take a look at the overall pool option.\r\n  if (!allowCodeExecutionScoped && customLogicOptions) {\r\n    if (\r\n      customLogicOptions.callback ||\r\n      customLogicOptions.resources ||\r\n      customLogicOptions.customCode\r\n    ) {\r\n      // Send back a friendly message saying that the exporter does not support\r\n      // these settings.\r\n      return endCallback(\r\n        new ExportError(\r\n          `[chart] The 'callback', 'resources' and 'customCode' options have been disabled for this server.`\r\n        )\r\n      );\r\n    }\r\n\r\n    // Reset all additional custom code\r\n    customLogicOptions.callback = false;\r\n    customLogicOptions.resources = false;\r\n    customLogicOptions.customCode = false;\r\n  }\r\n\r\n  // Clean properties to keep it lean and mean\r\n  if (chartJson) {\r\n    chartJson.chart = chartJson.chart || {};\r\n    chartJson.exporting = chartJson.exporting || {};\r\n    chartJson.exporting.enabled = false;\r\n  }\r\n\r\n  exportOptions.constr = exportOptions.constr || 'chart';\r\n  exportOptions.type = fixType(exportOptions.type, exportOptions.outfile);\r\n  if (exportOptions.type === 'svg') {\r\n    exportOptions.width = false;\r\n  }\r\n\r\n  // Prepare global and theme options\r\n  ['globalOptions', 'themeOptions'].forEach((optionsName) => {\r\n    try {\r\n      if (exportOptions && exportOptions[optionsName]) {\r\n        if (\r\n          typeof exportOptions[optionsName] === 'string' &&\r\n          exportOptions[optionsName].endsWith('.json')\r\n        ) {\r\n          exportOptions[optionsName] = isCorrectJSON(\r\n            readFileSync(exportOptions[optionsName], 'utf8'),\r\n            true\r\n          );\r\n        } else {\r\n          exportOptions[optionsName] = isCorrectJSON(\r\n            exportOptions[optionsName],\r\n            true\r\n          );\r\n        }\r\n      }\r\n    } catch (error) {\r\n      exportOptions[optionsName] = {};\r\n      logWithStack(2, error, `[chart] The '${optionsName}' cannot be loaded.`);\r\n    }\r\n  });\r\n\r\n  // Prepare the customCode\r\n  if (customLogicOptions.allowCodeExecution) {\r\n    try {\r\n      customLogicOptions.customCode = wrapAround(\r\n        customLogicOptions.customCode,\r\n        customLogicOptions.allowFileResources\r\n      );\r\n    } catch (error) {\r\n      logWithStack(2, error, `[chart] The 'customCode' cannot be loaded.`);\r\n    }\r\n  }\r\n\r\n  // Get the callback\r\n  if (\r\n    customLogicOptions &&\r\n    customLogicOptions.callback &&\r\n    customLogicOptions.callback?.indexOf('{') < 0\r\n  ) {\r\n    // The allowFileResources is always set to false for HTTP requests to avoid\r\n    // injecting arbitrary files from the fs\r\n    if (customLogicOptions.allowFileResources) {\r\n      try {\r\n        customLogicOptions.callback = readFileSync(\r\n          customLogicOptions.callback,\r\n          'utf8'\r\n        );\r\n      } catch (error) {\r\n        customLogicOptions.callback = false;\r\n        logWithStack(2, error, `[chart] The 'callback' cannot be loaded.`);\r\n      }\r\n    } else {\r\n      customLogicOptions.callback = false;\r\n    }\r\n  }\r\n\r\n  // Size search\r\n  options.export = {\r\n    ...options.export,\r\n    ...findChartSize(options)\r\n  };\r\n\r\n  // Post the work to the pool\r\n  try {\r\n    const result = await postWork(\r\n      exportOptions.strInj || chartJson || svg,\r\n      options\r\n    );\r\n    return endCallback(false, result);\r\n  } catch (error) {\r\n    return endCallback(error);\r\n  }\r\n};\r\n\r\n/**\r\n * Performs a direct inject of options before export. The function attempts\r\n * to stringify the provided options and removes unnecessary characters,\r\n * ensuring a clean and formatted input. The resulting string is saved as\r\n * a \"stright inject\" string in the export options. It then invokes the\r\n * doExport function with the updated options.\r\n *\r\n * IMPORTANT: Dangerous and must be used deliberately by someone who sets up\r\n * a server (see the  --allowCodeExecution option).\r\n *\r\n * @param {Object} options - The export options containing the input\r\n * to be injected.\r\n * @param {function} endCallback - The callback function to be invoked\r\n * at the end of the process.\r\n *\r\n * @returns {Promise} A Promise that resolves with the result of the export\r\n * operation or rejects with an error if any issues occur during the process.\r\n */\r\nconst doStraightInject = (options, endCallback) => {\r\n  try {\r\n    let strInj;\r\n    let instr = options.export.instr || options.export.options;\r\n\r\n    if (typeof instr !== 'string') {\r\n      // Try to stringify options\r\n      strInj = instr = optionsStringify(\r\n        instr,\r\n        options.customLogic?.allowCodeExecution\r\n      );\r\n    }\r\n    strInj = instr.replaceAll(/\\t|\\n|\\r/g, '').trim();\r\n\r\n    // Get rid of the ;\r\n    if (strInj[strInj.length - 1] === ';') {\r\n      strInj = strInj.substring(0, strInj.length - 1);\r\n    }\r\n\r\n    // Save as stright inject string\r\n    options.export.strInj = strInj;\r\n    return doExport(options, false, endCallback);\r\n  } catch (error) {\r\n    return endCallback(\r\n      new ExportError(\r\n        `[chart] Malformed input detected for ${options.export?.requestId || '?'}. Please make sure that your JSON/JavaScript options are sent using the \"options\" attribute, and that if you're using SVG, it is unescaped.`\r\n      ).setError(error)\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Exports a string based on the provided options and invokes an end callback.\r\n *\r\n * @param {string} stringToExport - The string content to be exported.\r\n * @param {Object} options - Export options, including customLogic with\r\n * allowCodeExecution flag.\r\n * @param {Function} endCallback - Callback function to be invoked at the end\r\n * of the export process.\r\n *\r\n * @returns {any} Result of the export process or an error if encountered.\r\n */\r\nconst exportAsString = (stringToExport, options, endCallback) => {\r\n  const { allowCodeExecution } = options.customLogic;\r\n\r\n  // Check if it is SVG\r\n  if (\r\n    stringToExport.indexOf('<svg') >= 0 ||\r\n    stringToExport.indexOf('<?xml') >= 0\r\n  ) {\r\n    log(4, '[chart] Parsing input as SVG.');\r\n    return doExport(options, false, endCallback, stringToExport);\r\n  }\r\n\r\n  try {\r\n    // Try to parse to JSON and call the doExport function\r\n    const chartJSON = JSON.parse(stringToExport.replaceAll(/\\t|\\n|\\r/g, ' '));\r\n\r\n    // If a correct JSON, do the export\r\n    return doExport(options, chartJSON, endCallback);\r\n  } catch (error) {\r\n    // Not a valid JSON\r\n    if (toBoolean(allowCodeExecution)) {\r\n      return doStraightInject(options, endCallback);\r\n    } else {\r\n      // Do not allow straight injection without the allowCodeExecution flag\r\n      return endCallback(\r\n        new ExportError(\r\n          '[chart] Only JSON configurations and SVG are allowed for this server. If this is your server, JavaScript custom code can be enabled by starting the server with the --allowCodeExecution flag.'\r\n        ).setError(error)\r\n      );\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Retrieves and returns the current status of code execution permission.\r\n *\r\n * @returns {any} The value of allowCodeExecution.\r\n */\r\nexport const getAllowCodeExecution = () => allowCodeExecution;\r\n\r\n/**\r\n * Sets the code execution permission based on the provided boolean value.\r\n *\r\n * @param {any} value - The value to be converted and assigned\r\n * to allowCodeExecution.\r\n */\r\nexport const setAllowCodeExecution = (value) => {\r\n  allowCodeExecution = toBoolean(value);\r\n};\r\n\r\nexport default {\r\n  batchExport,\r\n  singleExport,\r\n  getAllowCodeExecution,\r\n  setAllowCodeExecution,\r\n  startExport,\r\n  findChartSize\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n/**\r\n * @overview Used to sanitize the strings coming from the exporting module\r\n * to prevent XSS attacks (with the DOMPurify library).\r\n **/\r\n\r\nimport { JSDOM } from 'jsdom';\r\nimport DOMPurify from 'dompurify';\r\n\r\n/**\r\n * Sanitizes a given HTML string by removing <script> tags.\r\n * This function uses a regular expression to find and remove all\r\n * occurrences of <script>...</script> tags and any content within them.\r\n *\r\n * @param {string} input The HTML string to be sanitized.\r\n * @returns {string} The sanitized HTML string.\r\n */\r\nexport function sanitize(input) {\r\n  const window = new JSDOM('').window;\r\n  const purify = DOMPurify(window);\r\n  return purify.sanitize(input, {\r\n    ADD_TAGS: ['foreignObject'],\r\n    // Disallow all xlinks in incoming SVG\r\n    FORBID_ATTR: ['xlink:href']\r\n  });\r\n}\r\n\r\nexport default sanitize;\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { log } from './logger.js';\r\n\r\n// Array that contains ids of all ongoing intervals\r\nconst intervalIds = [];\r\n\r\n/**\r\n * Adds id of a setInterval to the intervalIds array.\r\n *\r\n * @param {NodeJS.Timeout} id - Id of an interval.\r\n */\r\nexport const addInterval = (id) => {\r\n  intervalIds.push(id);\r\n};\r\n\r\n/**\r\n * Clears all of ongoing intervals by ids gathered in the intervalIds array.\r\n */\r\nexport const clearAllIntervals = () => {\r\n  log(4, `[server] Clearing all registered intervals.`);\r\n  for (const id of intervalIds) {\r\n    clearInterval(id);\r\n  }\r\n};\r\n\r\nexport default {\r\n  addInterval,\r\n  clearAllIntervals\r\n};\r\n","import { envs } from '../envs.js';\r\nimport { logWithStack } from '../logger.js';\r\n\r\n/**\r\n * Middleware for logging errors with stack trace and handling error response.\r\n *\r\n * @param {Error} error - The error object.\r\n * @param {Express.Request} req - The Express request object.\r\n * @param {Express.Response} res - The Express response object.\r\n * @param {Function} next - The next middleware function.\r\n */\r\nconst logErrorMiddleware = (error, req, res, next) => {\r\n  // Display the error with stack in a correct format\r\n  logWithStack(1, error);\r\n\r\n  // Delete the stack for the environment other than the development\r\n  if (envs.OTHER_NODE_ENV !== 'development') {\r\n    delete error.stack;\r\n  }\r\n\r\n  // Call the returnErrorMiddleware\r\n  next(error);\r\n};\r\n\r\n/**\r\n * Middleware for returning error response.\r\n *\r\n * @param {Error} error - The error object.\r\n * @param {Express.Request} req - The Express request object.\r\n * @param {Express.Response} res - The Express response object.\r\n * @param {Function} next - The next middleware function.\r\n */\r\nconst returnErrorMiddleware = (error, req, res, next) => {\r\n  // Gather all requied information for the response\r\n  const { statusCode: stCode, status, message, stack } = error;\r\n  const statusCode = stCode || status || 400;\r\n\r\n  // Set and return response\r\n  res.status(statusCode).json({ statusCode, message, stack });\r\n};\r\n\r\nexport default (app) => {\r\n  // Add log error middleware\r\n  app.use(logErrorMiddleware);\r\n\r\n  // Add set status and return error middleware\r\n  app.use(returnErrorMiddleware);\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nimport { log } from '../logger.js';\r\n\r\n/**\r\n * Middleware for enabling rate limiting on the specified Express app.\r\n *\r\n * @param {Express} app - The Express app instance.\r\n * @param {Object} limitConfig - Configuration options for rate limiting.\r\n */\r\nexport default (app, limitConfig) => {\r\n  const msg =\r\n    'Too many requests, you have been rate limited. Please try again later.';\r\n\r\n  // Options for the rate limiter\r\n  const rateOptions = {\r\n    max: limitConfig.maxRequests || 30,\r\n    window: limitConfig.window || 1,\r\n    delay: limitConfig.delay || 0,\r\n    trustProxy: limitConfig.trustProxy || false,\r\n    skipKey: limitConfig.skipKey || false,\r\n    skipToken: limitConfig.skipToken || false\r\n  };\r\n\r\n  // Set if behind a proxy\r\n  if (rateOptions.trustProxy) {\r\n    app.enable('trust proxy');\r\n  }\r\n\r\n  // Create a limiter\r\n  const limiter = rateLimit({\r\n    windowMs: rateOptions.window * 60 * 1000,\r\n    // Limit each IP to 100 requests per windowMs\r\n    max: rateOptions.max,\r\n    // Disable delaying, full speed until the max limit is reached\r\n    delayMs: rateOptions.delay,\r\n    handler: (request, response) => {\r\n      response.format({\r\n        json: () => {\r\n          response.status(429).send({ message: msg });\r\n        },\r\n        default: () => {\r\n          response.status(429).send(msg);\r\n        }\r\n      });\r\n    },\r\n    skip: (request) => {\r\n      // Allow bypassing the limiter if a valid key/token has been sent\r\n      if (\r\n        rateOptions.skipKey !== false &&\r\n        rateOptions.skipToken !== false &&\r\n        request.query.key === rateOptions.skipKey &&\r\n        request.query.access_token === rateOptions.skipToken\r\n      ) {\r\n        log(4, '[rate limiting] Skipping rate limiter.');\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n  });\r\n\r\n  // Use a limiter as a middleware\r\n  app.use(limiter);\r\n\r\n  log(\r\n    3,\r\n    `[rate limiting] Enabled rate limiting with ${rateOptions.max} requests per ${rateOptions.window} minute for each IP, trusting proxy: ${rateOptions.trustProxy}.`\r\n  );\r\n};\r\n","import ExportError from './ExportError.js';\r\n\r\nclass HttpError extends ExportError {\r\n  constructor(message, status) {\r\n    super(message);\r\n    this.status = this.statusCode = status;\r\n  }\r\n\r\n  setStatus(status) {\r\n    this.status = status;\r\n    return this;\r\n  }\r\n}\r\n\r\nexport default HttpError;\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { updateVersion, version } from '../../cache.js';\r\nimport { envs } from '../../envs.js';\r\n\r\nimport HttpError from '../../errors/HttpError.js';\r\n\r\n/**\r\n * Adds the POST /change_hc_version/:newVersion route that can be utilized to modify\r\n * the Highcharts version on the server.\r\n *\r\n * TODO: Add auth token and connect to API\r\n */\r\nexport default (app) =>\r\n  !app\r\n    ? false\r\n    : app.post(\r\n        '/version/change/:newVersion',\r\n        async (request, response, next) => {\r\n          try {\r\n            const adminToken = envs.HIGHCHARTS_ADMIN_TOKEN;\r\n\r\n            // Check the existence of the token\r\n            if (!adminToken || !adminToken.length) {\r\n              throw new HttpError(\r\n                'The server is not configured to perform run-time version changes: HIGHCHARTS_ADMIN_TOKEN is not set.',\r\n                401\r\n              );\r\n            }\r\n\r\n            // Check if the hc-auth header contain a correct token\r\n            const token = request.get('hc-auth');\r\n            if (!token || token !== adminToken) {\r\n              throw new HttpError(\r\n                'Invalid or missing token: Set the token in the hc-auth header.',\r\n                401\r\n              );\r\n            }\r\n\r\n            // Compare versions\r\n            const newVersion = request.params.newVersion;\r\n            if (newVersion) {\r\n              try {\r\n                // eslint-disable-next-line import/no-named-as-default-member\r\n                await updateVersion(newVersion);\r\n              } catch (error) {\r\n                throw new HttpError(\r\n                  `Version change: ${error.message}`,\r\n                  error.statusCode\r\n                ).setError(error);\r\n              }\r\n\r\n              // Success\r\n              response.status(200).send({\r\n                statusCode: 200,\r\n                version: version(),\r\n                message: `Successfully updated Highcharts to version: ${newVersion}.`\r\n              });\r\n            } else {\r\n              // No version specified\r\n              throw new HttpError('No new version supplied.', 400);\r\n            }\r\n          } catch (error) {\r\n            next(error);\r\n          }\r\n        }\r\n      );\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { v4 as uuid } from 'uuid';\r\n\r\nimport { getAllowCodeExecution, startExport } from '../../chart.js';\r\nimport { getOptions, mergeConfigOptions } from '../../config.js';\r\nimport { log } from '../../logger.js';\r\nimport {\r\n  fixType,\r\n  isCorrectJSON,\r\n  isObjectEmpty,\r\n  isPrivateRangeUrlFound,\r\n  optionsStringify,\r\n  measureTime\r\n} from '../../utils.js';\r\n\r\nimport HttpError from '../../errors/HttpError.js';\r\n\r\n// Reversed MIME types\r\nconst reversedMime = {\r\n  png: 'image/png',\r\n  jpeg: 'image/jpeg',\r\n  gif: 'image/gif',\r\n  pdf: 'application/pdf',\r\n  svg: 'image/svg+xml'\r\n};\r\n\r\n// The requests counter\r\nlet requestsCounter = 0;\r\n\r\n// The array of callbacks to call before a request\r\nconst beforeRequest = [];\r\n\r\n// The array of callbacks to call after a request\r\nconst afterRequest = [];\r\n\r\n/**\r\n * Invokes an array of callback functions with specified parameters, allowing\r\n * customization of request handling.\r\n *\r\n * @param {Function[]} callbacks - An array of callback functions\r\n * to be executed.\r\n * @param {Express.Request} request - The Express request object.\r\n * @param {Express.Response} response - The Express response object.\r\n * @param {Object} data - An object containing parameters like id, uniqueId,\r\n * type, and body.\r\n *\r\n * @returns {boolean} - Returns a boolean indicating the overall result\r\n * of the callback invocations.\r\n */\r\nconst doCallbacks = (callbacks, request, response, data) => {\r\n  let result = true;\r\n  const { id, uniqueId, type, body } = data;\r\n\r\n  callbacks.some((callback) => {\r\n    if (callback) {\r\n      let callResponse = callback(request, response, id, uniqueId, type, body);\r\n\r\n      if (callResponse !== undefined && callResponse !== true) {\r\n        result = callResponse;\r\n      }\r\n\r\n      return true;\r\n    }\r\n  });\r\n\r\n  return result;\r\n};\r\n\r\n/**\r\n * Handles the export requests from the client.\r\n *\r\n * @param {Express.Request} request - The Express request object.\r\n * @param {Express.Response} response - The Express response object.\r\n * @param {Function} next - The next middleware function.\r\n *\r\n * @returns {Promise<void>} - A promise that resolves once the export process\r\n * is complete.\r\n */\r\nconst exportHandler = async (request, response, next) => {\r\n  try {\r\n    // Start counting time\r\n    const stopCounter = measureTime();\r\n\r\n    // Create a unique ID for a request\r\n    const uniqueId = uuid().replace(/-/g, '');\r\n\r\n    // Get the current server's general options\r\n    const defaultOptions = getOptions();\r\n\r\n    const body = request.body;\r\n    const id = ++requestsCounter;\r\n\r\n    let type = fixType(body.type);\r\n\r\n    // Throw 'Bad Request' if there's no body\r\n    if (!body || isObjectEmpty(body)) {\r\n      throw new HttpError(\r\n        'The request body is required. Please ensure that your Content-Type header is correct (accepted types are application/json and multipart/form-data).',\r\n        400\r\n      );\r\n    }\r\n\r\n    // All of the below can be used\r\n    let instr = isCorrectJSON(body.infile || body.options || body.data);\r\n\r\n    // Throw 'Bad Request' if there's no JSON or SVG to export\r\n    if (!instr && !body.svg) {\r\n      log(\r\n        2,\r\n        `The request with ID ${uniqueId} from ${\r\n          request.headers['x-forwarded-for'] || request.connection.remoteAddress\r\n        } was incorrect:\r\n  Content-Type: ${request.headers['content-type']}. \r\n  Chart constructor: ${body.constr}.\r\n  Dimensions: ${body.width}x${body.height} @ ${body.scale} scale.\r\n  Type: ${type}.\r\n  Is SVG set? ${typeof body.svg !== 'undefined'}.\r\n  B64? ${typeof body.b64 !== 'undefined'}.\r\n  No download? ${typeof body.noDownload !== 'undefined'}.\r\n\r\n  Payload received: ${JSON.stringify(body.infile || body.options || body.data || body.svg)}\r\n\r\n  `\r\n      );\r\n\r\n      throw new HttpError(\r\n        \"No correct chart data found. Ensure that you are using either application/json or multipart/form-data headers. If sending JSON, make sure the chart data is in the 'infile', 'options', or 'data' attribute. If sending SVG, ensure it is in the 'svg' attribute.\",\r\n        400\r\n      );\r\n    }\r\n\r\n    let callResponse = false;\r\n\r\n    // Call the before request functions\r\n    callResponse = doCallbacks(beforeRequest, request, response, {\r\n      id,\r\n      uniqueId,\r\n      type,\r\n      body\r\n    });\r\n\r\n    // Block the request if one of a callbacks failed\r\n    if (callResponse !== true) {\r\n      return response.send(callResponse);\r\n    }\r\n\r\n    let connectionAborted = false;\r\n\r\n    // In case the connection is closed, force to abort further actions\r\n    request.socket.on('close', (hadErrors) => {\r\n      if (hadErrors) {\r\n        connectionAborted = true;\r\n      }\r\n    });\r\n\r\n    log(4, `[export] Got an incoming HTTP request with ID ${uniqueId}.`);\r\n\r\n    body.constr = (typeof body.constr === 'string' && body.constr) || 'chart';\r\n\r\n    // Gather and organize options from the payload\r\n    const requestOptions = {\r\n      export: {\r\n        instr,\r\n        type,\r\n        constr: body.constr[0].toLowerCase() + body.constr.substr(1),\r\n        height: body.height,\r\n        width: body.width,\r\n        scale: body.scale || defaultOptions.export.scale,\r\n        globalOptions: isCorrectJSON(body.globalOptions, true),\r\n        themeOptions: isCorrectJSON(body.themeOptions, true)\r\n      },\r\n      customLogic: {\r\n        allowCodeExecution: getAllowCodeExecution(),\r\n        allowFileResources: false,\r\n        resources: isCorrectJSON(body.resources, true),\r\n        callback: body.callback,\r\n        customCode: body.customCode\r\n      }\r\n    };\r\n\r\n    if (instr) {\r\n      // Stringify JSON with options\r\n      requestOptions.export.instr = optionsStringify(\r\n        instr,\r\n        requestOptions.customLogic.allowCodeExecution\r\n      );\r\n    }\r\n\r\n    // Merge the request options into default ones\r\n    const options = mergeConfigOptions(defaultOptions, requestOptions);\r\n\r\n    // Save the JSON if exists\r\n    options.export.options = instr;\r\n\r\n    // Lastly, add the server specific arguments into options as payload\r\n    options.payload = {\r\n      svg: body.svg || false,\r\n      b64: body.b64 || false,\r\n      noDownload: body.noDownload || false,\r\n      requestId: uniqueId\r\n    };\r\n\r\n    // Test xlink:href elements from payload's SVG\r\n    if (body.svg && isPrivateRangeUrlFound(options.payload.svg)) {\r\n      throw new HttpError(\r\n        'SVG potentially contain at least one forbidden URL in xlink:href element. Please review the SVG content and ensure that all referenced URLs comply with security policies.',\r\n        400\r\n      );\r\n    }\r\n\r\n    // Start the export process\r\n    await startExport(options, (error, info) => {\r\n      // Remove the close event from the socket\r\n      request.socket.removeAllListeners('close');\r\n\r\n      // After the whole exporting process\r\n      if (defaultOptions.server.benchmarking) {\r\n        log(\r\n          5,\r\n          `[benchmark] Request with ID ${uniqueId} - After the whole exporting process: ${stopCounter()}ms.`\r\n        );\r\n      }\r\n\r\n      // If the connection was closed, do nothing\r\n      if (connectionAborted) {\r\n        return log(\r\n          3,\r\n          `[export] The client closed the connection before the chart finished processing.`\r\n        );\r\n      }\r\n\r\n      // If error, log it and send it to the error middleware\r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      // If data is missing, log the message and send it to the error middleware\r\n      if (!info || !info.result) {\r\n        throw new HttpError(\r\n          `Unexpected return from chart generation. Please check your request data. For the request with ID ${uniqueId}, the result is ${info.result}.`,\r\n          400\r\n        );\r\n      }\r\n\r\n      // Get the type from options\r\n      type = info.options.export.type;\r\n\r\n      // The after request callbacks\r\n      doCallbacks(afterRequest, request, response, { id, body: info.result });\r\n\r\n      if (info.result) {\r\n        // If only base64 is required, return it\r\n        if (body.b64) {\r\n          // SVG Exception for the Highcharts 11.3.0 version\r\n          if (type === 'pdf' || type == 'svg') {\r\n            return response.send(\r\n              Buffer.from(info.result, 'utf8').toString('base64')\r\n            );\r\n          }\r\n\r\n          return response.send(info.result);\r\n        }\r\n\r\n        // Set correct content type\r\n        response.header('Content-Type', reversedMime[type] || 'image/png');\r\n\r\n        // Decide whether to download or not chart file\r\n        if (!body.noDownload) {\r\n          response.attachment(\r\n            `${request.params.filename || request.body.filename || 'chart'}.${\r\n              type || 'png'\r\n            }`\r\n          );\r\n        }\r\n\r\n        // If SVG, return plain content\r\n        return type === 'svg'\r\n          ? response.send(info.result)\r\n          : response.send(Buffer.from(info.result, 'base64'));\r\n      }\r\n    });\r\n  } catch (error) {\r\n    next(error);\r\n  }\r\n};\r\n\r\nexport default (app) => {\r\n  /**\r\n   * Adds the POST / a route for handling POST requests at the root endpoint.\r\n   */\r\n  app.post('/', exportHandler);\r\n\r\n  /**\r\n   * Adds the POST /:filename a route for handling POST requests with\r\n   * a specified filename parameter.\r\n   */\r\n  app.post('/:filename', exportHandler);\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { readFileSync } from 'fs';\r\nimport { join as pather } from 'path';\r\nimport { log } from '../../logger.js';\r\n\r\nimport { version } from '../../cache.js';\r\nimport { addInterval } from '../../intervals.js';\r\nimport pool from '../../pool.js';\r\nimport { __dirname } from '../../utils.js';\r\n\r\nconst pkgFile = JSON.parse(readFileSync(pather(__dirname, 'package.json')));\r\n\r\nconst serverStartTime = new Date();\r\n\r\nconst successRates = [];\r\nconst recordInterval = 60 * 1000; // record every minute\r\nconst windowSize = 30; // 30 minutes\r\n\r\n/**\r\n * Calculates moving average indicator based on the data from the successRates\r\n * array.\r\n *\r\n * @returns {number} - A moving average for success ratio of the server exports.\r\n */\r\nfunction calculateMovingAverage() {\r\n  const sum = successRates.reduce((a, b) => a + b, 0);\r\n  return sum / successRates.length;\r\n}\r\n\r\n/**\r\n * Starts the interval responsible for calculating current success rate ratio\r\n * and gathers\r\n *\r\n * @returns {NodeJS.Timeout} id - Id of an interval.\r\n */\r\nexport const startSuccessRate = () =>\r\n  setInterval(() => {\r\n    const stats = pool.getStats();\r\n    const successRatio =\r\n      stats.exportAttempts === 0\r\n        ? 1\r\n        : (stats.performedExports / stats.exportAttempts) * 100;\r\n\r\n    successRates.push(successRatio);\r\n    if (successRates.length > windowSize) {\r\n      successRates.shift();\r\n    }\r\n  }, recordInterval);\r\n\r\n/**\r\n * Adds the /health and /success-moving-average routes\r\n * which output basic stats for the server.\r\n */\r\nexport default function addHealthRoutes(app) {\r\n  if (!app) {\r\n    return false;\r\n  }\r\n\r\n  // Start processing success rate ratio interval and save its id to the array\r\n  // for the graceful clearing on shutdown with injected addInterval funtion\r\n  addInterval(startSuccessRate());\r\n\r\n  app.get('/health', (_, res) => {\r\n    const stats = pool.getStats();\r\n    const period = successRates.length;\r\n    const movingAverage = calculateMovingAverage();\r\n\r\n    log(4, '[health.js] GET /health [200] - returning server health.');\r\n\r\n    res.send({\r\n      status: 'OK',\r\n      bootTime: serverStartTime,\r\n      uptime:\r\n        Math.floor(\r\n          (new Date().getTime() - serverStartTime.getTime()) / 1000 / 60\r\n        ) + ' minutes',\r\n      version: pkgFile.version,\r\n      highchartsVersion: version(),\r\n      averageProcessingTime: stats.spentAverage,\r\n      performedExports: stats.performedExports,\r\n      failedExports: stats.droppedExports,\r\n      exportAttempts: stats.exportAttempts,\r\n      sucessRatio: (stats.performedExports / stats.exportAttempts) * 100,\r\n      // eslint-disable-next-line import/no-named-as-default-member\r\n      pool: pool.getPoolInfoJSON(),\r\n\r\n      // Moving average\r\n      period,\r\n      movingAverage,\r\n      message:\r\n        isNaN(movingAverage) || !successRates.length\r\n          ? 'Too early to report. No exports made yet. Please check back soon.'\r\n          : `Last ${period} minutes had a success rate of ${movingAverage.toFixed(2)}%.`,\r\n\r\n      // SVG/JSON attempts\r\n      svgExportAttempts: stats.exportFromSvgAttempts,\r\n      jsonExportAttempts: stats.performedExports - stats.exportFromSvgAttempts\r\n    });\r\n  });\r\n}\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { promises as fsPromises } from 'fs';\r\nimport { posix } from 'path';\r\n\r\nimport cors from 'cors';\r\nimport express from 'express';\r\nimport http from 'http';\r\nimport https from 'https';\r\nimport multer from 'multer';\r\n\r\nimport errorHandler from './error.js';\r\nimport rateLimit from './rate_limit.js';\r\nimport { log, logWithStack } from '../logger.js';\r\nimport { __dirname } from '../utils.js';\r\n\r\nimport vSwitchRoute from './routes/change_hc_version.js';\r\nimport exportRoutes from './routes/export.js';\r\nimport healthRoute from './routes/health.js';\r\nimport uiRoute from './routes/ui.js';\r\n\r\nimport ExportError from '../errors/ExportError.js';\r\n\r\n// Array of an active servers\r\nconst activeServers = new Map();\r\n\r\n// Create express app\r\nconst app = express();\r\n\r\n// Disable the X-Powered-By header\r\napp.disable('x-powered-by');\r\n\r\n// Enable CORS support\r\napp.use(cors());\r\n\r\n// Getting a lot of RangeNotSatisfiableError exception.\r\n// Even though this is a deprecated options, let's try to set it to false.\r\napp.use((_req, res, next) => {\r\n  res.set('Accept-Ranges', 'none');\r\n  next();\r\n});\r\n\r\n/**\r\n * Attach error handlers to the server.\r\n *\r\n * @param {http.Server} server - The HTTP/HTTPS server instance.\r\n */\r\nconst attachServerErrorHandlers = (server) => {\r\n  server.on('clientError', (error, socket) => {\r\n    logWithStack(\r\n      1,\r\n      error,\r\n      `[server] Client error: ${error.message}, destroying socket.`\r\n    );\r\n    socket.destroy();\r\n  });\r\n\r\n  server.on('error', (error) => {\r\n    logWithStack(1, error, `[server] Server error: ${error.message}`);\r\n  });\r\n\r\n  server.on('connection', (socket) => {\r\n    socket.on('error', (error) => {\r\n      logWithStack(1, error, `[server] Socket error: ${error.message}`);\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * Starts an HTTP server based on the provided configuration. The `serverConfig`\r\n * object contains all server related properties (see the `server` section\r\n * in the `lib/schemas/config.js` file for a reference).\r\n *\r\n * @param {Object} serverConfig - The server configuration object.\r\n *\r\n * @throws {ExportError} - Throws an error if the server cannot be configured\r\n * and started.\r\n */\r\nexport const startServer = async (serverConfig) => {\r\n  try {\r\n    // TODO: Read from config/env\r\n    // NOTE:\r\n    // Too big limits lead to timeouts in the export process when the\r\n    // rasterization timeout is set too low.\r\n    const uploadLimitMiB = serverConfig.maxUploadSize || 3;\r\n    const uploadLimitBytes = uploadLimitMiB * 1024 * 1024;\r\n\r\n    // Enable parsing of form data (files) with Multer package\r\n    const storage = multer.memoryStorage();\r\n    const upload = multer({\r\n      storage,\r\n      limits: {\r\n        fieldSize: uploadLimitBytes\r\n      }\r\n    });\r\n\r\n    // Enable body parser\r\n    app.use(express.json({ limit: uploadLimitBytes }));\r\n    app.use(express.urlencoded({ extended: true, limit: uploadLimitBytes }));\r\n\r\n    // Use only non-file multipart form fields\r\n    app.use(upload.none());\r\n\r\n    // Stop if not enabled\r\n    if (!serverConfig.enable) {\r\n      return false;\r\n    }\r\n\r\n    // Listen HTTP server\r\n    if (!serverConfig.ssl.force) {\r\n      // Main server instance (HTTP)\r\n      const httpServer = http.createServer(app);\r\n\r\n      // Attach error handlers and listen to the server\r\n      attachServerErrorHandlers(httpServer);\r\n\r\n      // Listen\r\n      httpServer.listen(serverConfig.port, serverConfig.host);\r\n\r\n      // Save the reference to HTTP server\r\n      activeServers.set(serverConfig.port, httpServer);\r\n\r\n      log(\r\n        3,\r\n        `[server] Started HTTP server on ${serverConfig.host}:${serverConfig.port}.`\r\n      );\r\n    }\r\n\r\n    // Listen HTTPS server\r\n    if (serverConfig.ssl.enable) {\r\n      // Set up an SSL server also\r\n      let key, cert;\r\n\r\n      try {\r\n        // Get the SSL key\r\n        key = await fsPromises.readFile(\r\n          posix.join(serverConfig.ssl.certPath, 'server.key'),\r\n          'utf8'\r\n        );\r\n\r\n        // Get the SSL certificate\r\n        cert = await fsPromises.readFile(\r\n          posix.join(serverConfig.ssl.certPath, 'server.crt'),\r\n          'utf8'\r\n        );\r\n      } catch (error) {\r\n        log(\r\n          2,\r\n          `[server] Unable to load key/certificate from the '${serverConfig.ssl.certPath}' path. Could not run secured layer server.`\r\n        );\r\n      }\r\n\r\n      if (key && cert) {\r\n        // Main server instance (HTTPS)\r\n        const httpsServer = https.createServer({ key, cert }, app);\r\n\r\n        // Attach error handlers and listen to the server\r\n        attachServerErrorHandlers(httpsServer);\r\n\r\n        // Listen\r\n        httpsServer.listen(serverConfig.ssl.port, serverConfig.host);\r\n\r\n        // Save the reference to HTTPS server\r\n        activeServers.set(serverConfig.ssl.port, httpsServer);\r\n\r\n        log(\r\n          3,\r\n          `[server] Started HTTPS server on ${serverConfig.host}:${serverConfig.ssl.port}.`\r\n        );\r\n      }\r\n    }\r\n\r\n    // Enable the rate limiter if config says so\r\n    if (\r\n      serverConfig.rateLimiting &&\r\n      serverConfig.rateLimiting.enable &&\r\n      ![0, NaN].includes(serverConfig.rateLimiting.maxRequests)\r\n    ) {\r\n      rateLimit(app, serverConfig.rateLimiting);\r\n    }\r\n\r\n    // Set up static folder's route\r\n    app.use(express.static(posix.join(__dirname, 'public')));\r\n\r\n    // Set up routes\r\n    healthRoute(app);\r\n    exportRoutes(app);\r\n    uiRoute(app);\r\n    vSwitchRoute(app);\r\n\r\n    // Set up centralized error handler\r\n    errorHandler(app);\r\n  } catch (error) {\r\n    throw new ExportError(\r\n      '[server] Could not configure and start the server.'\r\n    ).setError(error);\r\n  }\r\n};\r\n\r\n/**\r\n * Closes all servers associated with Express app instance.\r\n */\r\nexport const closeServers = () => {\r\n  log(4, `[server] Closing all servers.`);\r\n  for (const [port, server] of activeServers) {\r\n    server.close(() => {\r\n      activeServers.delete(port);\r\n      log(4, `[server] Closed server on port: ${port}.`);\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Get all servers associated with Express app instance.\r\n *\r\n * @returns {Array} - Servers associated with Express app instance.\r\n */\r\nexport const getServers = () => activeServers;\r\n\r\n/**\r\n * Enable rate limiting for the server.\r\n *\r\n * @param {Object} limitConfig - Configuration object for rate limiting.\r\n */\r\nexport const enableRateLimiting = (limitConfig) => rateLimit(app, limitConfig);\r\n\r\n/**\r\n * Get the Express instance.\r\n *\r\n * @returns {Object} - The Express instance.\r\n */\r\nexport const getExpress = () => express;\r\n\r\n/**\r\n * Get the Express app instance.\r\n *\r\n * @returns {Object} - The Express app instance.\r\n */\r\nexport const getApp = () => app;\r\n\r\n/**\r\n * Apply middleware(s) to a specific path.\r\n *\r\n * @param {string} path - The path to which the middleware(s) should be applied.\r\n * @param {...Function} middlewares - The middleware functions to be applied.\r\n */\r\nexport const use = (path, ...middlewares) => {\r\n  app.use(path, ...middlewares);\r\n};\r\n\r\n/**\r\n * Set up a route with GET method and apply middleware(s).\r\n *\r\n * @param {string} path - The route path.\r\n * @param {...Function} middlewares - The middleware functions to be applied.\r\n */\r\nexport const get = (path, ...middlewares) => {\r\n  app.get(path, ...middlewares);\r\n};\r\n\r\n/**\r\n * Set up a route with POST method and apply middleware(s).\r\n *\r\n * @param {string} path - The route path.\r\n * @param {...Function} middlewares - The middleware functions to be applied.\r\n */\r\nexport const post = (path, ...middlewares) => {\r\n  app.post(path, ...middlewares);\r\n};\r\n\r\nexport default {\r\n  startServer,\r\n  closeServers,\r\n  getServers,\r\n  enableRateLimiting,\r\n  getExpress,\r\n  getApp,\r\n  use,\r\n  get,\r\n  post\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { join } from 'path';\r\n\r\nimport { __dirname } from '../../utils.js';\r\n\r\n/**\r\n * Adds the GET / route for a UI when enabled on the export server.\r\n */\r\nexport default (app) =>\r\n  !app\r\n    ? false\r\n    : app.get('/', (_request, response) => {\r\n        response.sendFile(join(__dirname, 'public', 'index.html'), {\r\n          acceptRanges: false\r\n        });\r\n      });\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { clearAllIntervals } from './intervals.js';\r\nimport { killPool } from './pool.js';\r\nimport { closeServers } from './server/server.js';\r\n\r\n/**\r\n * Clean up function to trigger before ending process for the graceful shutdown.\r\n *\r\n * @param {number} exitCode - An exit code for the process.exit() function.\r\n */\r\nexport const shutdownCleanUp = async (exitCode) => {\r\n  // Await freeing all resources\r\n  await Promise.allSettled([\r\n    // Clear all ongoing intervals\r\n    clearAllIntervals(),\r\n\r\n    // Get available server instances (HTTP/HTTPS) and close them\r\n    closeServers(),\r\n\r\n    // Close pool along with its workers and the browser instance, if exists\r\n    killPool()\r\n  ]);\r\n\r\n  // Exit process with a correct code\r\n  process.exit(exitCode);\r\n};\r\n\r\nexport default {\r\n  shutdownCleanUp\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2024, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport 'colors';\r\n\r\nimport { checkAndUpdateCache } from './cache.js';\r\nimport {\r\n  batchExport,\r\n  setAllowCodeExecution,\r\n  singleExport,\r\n  startExport\r\n} from './chart.js';\r\nimport { mapToNewConfig, manualConfig, setOptions } from './config.js';\r\nimport {\r\n  initLogging,\r\n  log,\r\n  logWithStack,\r\n  setLogLevel,\r\n  enableFileLogging\r\n} from './logger.js';\r\nimport { initPool, killPool } from './pool.js';\r\nimport { shutdownCleanUp } from './resource_release.js';\r\nimport server, { startServer } from './server/server.js';\r\nimport { printLogo, printUsage } from './utils.js';\r\n\r\n/**\r\n * Attaches exit listeners to the process, ensuring proper cleanup of resources\r\n * and termination on exit signals. Handles 'exit', 'SIGINT', 'SIGTERM', and\r\n * 'uncaughtException' events.\r\n */\r\nconst attachProcessExitListeners = () => {\r\n  log(3, '[process] Attaching exit listeners to the process.');\r\n\r\n  // Handler for the 'exit'\r\n  process.on('exit', (code) => {\r\n    log(4, `Process exited with code ${code}.`);\r\n  });\r\n\r\n  // Handler for the 'SIGINT'\r\n  process.on('SIGINT', async (name, code) => {\r\n    log(4, `The ${name} event with code: ${code}.`);\r\n    await shutdownCleanUp(0);\r\n  });\r\n\r\n  // Handler for the 'SIGTERM'\r\n  process.on('SIGTERM', async (name, code) => {\r\n    log(4, `The ${name} event with code: ${code}.`);\r\n    await shutdownCleanUp(0);\r\n  });\r\n\r\n  // Handler for the 'SIGHUP'\r\n  process.on('SIGHUP', async (name, code) => {\r\n    log(4, `The ${name} event with code: ${code}.`);\r\n    await shutdownCleanUp(0);\r\n  });\r\n\r\n  // Handler for the 'uncaughtException'\r\n  process.on('uncaughtException', async (error, name) => {\r\n    logWithStack(1, error, `The ${name} error.`);\r\n    await shutdownCleanUp(1);\r\n  });\r\n};\r\n\r\n/**\r\n * Initializes the export process. Tasks such as configuring logging, checking\r\n * cache and sources, and initializing the pool of resources happen during\r\n * this stage. Function that is required to be called before trying to export charts or setting a server. The `options` is an object that contains all options.\r\n *\r\n * @param {Object} options - All export options.\r\n *\r\n * @returns {Promise<Object>} Promise resolving to the updated export options.\r\n */\r\nconst initExport = async (options) => {\r\n  // Set the allowCodeExecution per export module scope\r\n  setAllowCodeExecution(\r\n    options.customLogic && options.customLogic.allowCodeExecution\r\n  );\r\n\r\n  // Init the logging\r\n  initLogging(options.logging);\r\n\r\n  // Attach process' exit listeners\r\n  if (options.other.listenToProcessExits) {\r\n    attachProcessExitListeners();\r\n  }\r\n\r\n  // Check if cache needs to be updated\r\n  await checkAndUpdateCache(options);\r\n\r\n  // Init the pool\r\n  await initPool({\r\n    pool: options.pool || {\r\n      minWorkers: 1,\r\n      maxWorkers: 1\r\n    },\r\n    puppeteerArgs: options.puppeteer.args || []\r\n  });\r\n\r\n  // Return updated options\r\n  return options;\r\n};\r\n\r\nexport default {\r\n  // Server\r\n  server,\r\n  startServer,\r\n\r\n  // Exporting\r\n  initExport,\r\n  singleExport,\r\n  batchExport,\r\n  startExport,\r\n\r\n  // Pool\r\n  initPool,\r\n  killPool,\r\n\r\n  // Other\r\n  setOptions,\r\n  shutdownCleanUp,\r\n\r\n  // Logs\r\n  log,\r\n  logWithStack,\r\n  setLogLevel,\r\n  enableFileLogging,\r\n\r\n  // Utils\r\n  mapToNewConfig,\r\n  manualConfig,\r\n  printLogo,\r\n  printUsage\r\n};\r\n"],"names":["scriptsNames","core","modules","indicators","custom","defaultConfig","puppeteer","args","value","type","description","tempDir","envLink","highcharts","version","cdnURL","coreScripts","moduleScripts","indicatorScripts","customScripts","forceFetch","cachePath","export","infile","instr","options","outfile","constr","defaultHeight","defaultWidth","defaultScale","height","width","scale","globalOptions","themeOptions","batch","rasterizationTimeout","customLogic","allowCodeExecution","allowFileResources","customCode","callback","resources","loadConfig","legacyName","createConfig","server","maxUploadSize","enable","cliName","host","port","benchmarking","proxy","username","password","timeout","rateLimiting","maxRequests","window","delay","trustProxy","skipKey","skipToken","ssl","force","certPath","pool","minWorkers","maxWorkers","workLimit","acquireTimeout","createTimeout","destroyTimeout","idleTimeout","createRetryInterval","reaperInterval","logging","level","file","dest","toConsole","toFile","ui","route","other","nodeEnv","listenToProcessExits","noLogo","hardResetPage","browserShellMode","debug","headless","devtools","listenToConsole","dumpio","slowMo","debuggingPort","promptsConfig","name","message","initial","join","separator","instructions","choices","hint","min","max","round","absoluteProps","nestedArgs","createNestedArgs","obj","propChain","Object","keys","forEach","k","includes","entry","substring","undefined","dotenv","config","v","filterArray","z","string","transform","split","map","trim","filter","length","enum","values","refine","test","isNaN","parseFloat","envs","object","PUPPETEER_TEMP_DIR","HIGHCHARTS_VERSION","HIGHCHARTS_CDN_URL","startsWith","HIGHCHARTS_CORE_SCRIPTS","HIGHCHARTS_MODULE_SCRIPTS","HIGHCHARTS_INDICATOR_SCRIPTS","HIGHCHARTS_FORCE_FETCH","HIGHCHARTS_CACHE_PATH","HIGHCHARTS_ADMIN_TOKEN","EXPORT_TYPE","EXPORT_CONSTR","EXPORT_DEFAULT_HEIGHT","EXPORT_DEFAULT_WIDTH","EXPORT_DEFAULT_SCALE","EXPORT_RASTERIZATION_TIMEOUT","CUSTOM_LOGIC_ALLOW_CODE_EXECUTION","CUSTOM_LOGIC_ALLOW_FILE_RESOURCES","SERVER_ENABLE","SERVER_HOST","SERVER_PORT","SERVER_MAX_UPLOAD_SIZE","SERVER_BENCHMARKING","SERVER_PROXY_HOST","SERVER_PROXY_PORT","SERVER_PROXY_USERNAME","SERVER_PROXY_PASSWORD","SERVER_PROXY_TIMEOUT","SERVER_RATE_LIMITING_ENABLE","SERVER_RATE_LIMITING_MAX_REQUESTS","SERVER_RATE_LIMITING_WINDOW","SERVER_RATE_LIMITING_DELAY","SERVER_RATE_LIMITING_TRUST_PROXY","SERVER_RATE_LIMITING_SKIP_KEY","SERVER_RATE_LIMITING_SKIP_TOKEN","SERVER_SSL_ENABLE","SERVER_SSL_FORCE","SERVER_SSL_PORT","SERVER_SSL_CERT_PATH","POOL_MIN_WORKERS","POOL_MAX_WORKERS","POOL_WORK_LIMIT","POOL_ACQUIRE_TIMEOUT","POOL_CREATE_TIMEOUT","POOL_DESTROY_TIMEOUT","POOL_IDLE_TIMEOUT","POOL_CREATE_RETRY_INTERVAL","POOL_REAPER_INTERVAL","POOL_BENCHMARKING","LOGGING_LEVEL","LOGGING_FILE","LOGGING_DEST","LOGGING_TO_CONSOLE","LOGGING_TO_FILE","UI_ENABLE","UI_ROUTE","OTHER_NODE_ENV","OTHER_LISTEN_TO_PROCESS_EXITS","OTHER_NO_LOGO","OTHER_HARD_RESET_PAGE","OTHER_BROWSER_SHELL_MODE","DEBUG_ENABLE","DEBUG_HEADLESS","DEBUG_DEVTOOLS","DEBUG_LISTEN_TO_CONSOLE","DEBUG_DUMPIO","DEBUG_SLOW_MO","DEBUG_DEBUGGING_PORT","partial","parse","process","env","colors","pathCreated","levelsDesc","title","color","listeners","logToFile","texts","prefix","existsSync","mkdirSync","appendFile","concat","error","console","log","newLevel","Date","toString","fn","apply","logWithStack","customMessage","mainMessage","stackMessage","stack","slice","setLogLevel","enableFileLogging","logDest","logFile","endsWith","__dirname","fileURLToPath","URL","url","fixType","formats","outType","pop","find","t","handleResources","allowedProps","handledResources","correctResources","isCorrectJSON","readFileSync","files","propName","item","data","parsedData","JSON","stringify","deepCopy","copy","Array","isArray","key","prototype","hasOwnProperty","call","optionsStringify","allowFunctions","replaceAll","printUsage","bold","yellow","cycleCategories","option","entries","descName","green","i","blue","category","toUpperCase","red","toBoolean","wrapAround","replace","measureTime","start","hrtime","bigint","Number","generalOptions","getOptions","mergeConfigOptions","newOptions","mergedOptions","updateDefaultConfig","configObj","customObj","customValue","initOptions","items","recursiveProps","objectToUpdate","nestedNames","shift","assign","async","fetch","requestOptions","Promise","resolve","reject","protocol","https","http","getProtocol","get","headers","Referer","res","on","chunk","text","ExportError","Error","constructor","super","this","setError","statusCode","cache","activeManifest","sources","hcVersion","extractVersion","indexOf","fetchAndProcessScript","script","fetchedModules","shouldThrowError","response","updateCache","highchartsOptions","proxyOptions","sourcePath","proxyAgent","HttpsProxyAgent","agent","allFetchPromises","all","fetchScripts","c","m","writeFileSync","checkAndUpdateCache","manifestPath","requestUpdate","manifest","moduleMap","numberOfModules","some","moduleName","newManifest","saveConfigToManifest","getCachePath","setupHighcharts","Highcharts","animObject","duration","triggerExport","chartOptions","displayErrors","_displayErrors","merge","setOptions","wrap","setOptionsObj","chart","animation","strInj","isRenderComplete","Chart","proceed","userOptions","cb","exporting","enabled","plotOptions","series","label","tooltip","onHighchartsRender","addEvent","Series","Function","finalOptions","finalCallback","defaultOptions","prop","template","browser","newPage","page","setCacheEnabled","setPageContent","isClosed","$eval","element","errorMessage","innerHTML","setPageEvents","clearPageResources","injectedResources","resource","dispose","evaluate","oldCharts","charts","oldChart","destroy","scriptsToRemove","document","getElementsByTagName","stylesToRemove","linksToRemove","remove","setContent","waitUntil","addScriptTag","path","setAsConfig","totalSize","Buffer","byteLength","toFixed","puppeteerExport","exportOptions","debugger","isSVG","svgTemplate","injectedJs","js","push","content","isLocal","jsResource","injectedCss","css","cssImports","match","cssImportPath","cssResource","addStyleTag","addPageResources","size","svgElement","querySelector","chartHeight","baseVal","chartWidth","body","style","zoom","margin","viewportHeight","Math","abs","ceil","viewportWidth","x","y","getBoundingClientRect","trunc","getClipRegion","setViewport","deviceScaleFactor","outerHTML","createSVG","encoding","clip","race","screenshot","captureBeyondViewport","fullPage","optimizeForSpeed","quality","omitBackground","_resolve","setTimeout","createImage","emulateMediaType","pdf","createPDF","stats","performedExports","exportAttempts","exportFromSvgAttempts","timeSpent","droppedExports","spentAverage","poolConfig","factory","create","id","uuid","startDate","getTime","workCount","random","validate","workerHandle","close","initPool","puppeteerArgs","puppeteerOptions","enabledDebug","debugOptions","launchOptions","userDataDir","handleSIGINT","handleSIGTERM","handleSIGHUP","waitForInitialPage","defaultViewport","tryCount","open","launch","createBrowser","parseInt","Pool","acquireTimeoutMillis","createTimeoutMillis","destroyTimeoutMillis","idleTimeoutMillis","createRetryIntervalMillis","reapIntervalMillis","propagateCreateError","r","hardReset","goto","clearPage","eventId","initialResources","acquire","promise","release","killPool","worker","used","destroyed","connected","closeBrowser","postWork","getPoolInfo","acquireCounter","payload","requestId","workStart","exportCounter","result","exportTime","getPoolInfoJSON","numFree","numUsed","available","pending","numPendingAcquires","pool$1","startExport","settings","endCallback","svg","initExportSettings","exportAsString","input","JSDOM","DOMPurify","sanitize","ADD_TAGS","FORBID_ATTR","doStraightInject","doExport","findChartSize","precision","multiplier","pow","roundNumber","sourceHeight","sourceWidth","param","chartJson","customLogicOptions","allowCodeExecutionScoped","optionsName","stringToExport","chartJSON","intervalIds","clearAllIntervals","clearInterval","logErrorMiddleware","req","next","returnErrorMiddleware","stCode","status","json","rateLimit","app","limitConfig","msg","rateOptions","limiter","windowMs","delayMs","handler","request","format","send","default","skip","query","access_token","use","HttpError","setStatus","vSwitchRoute","post","adminToken","token","newVersion","params","updateVersion","reversedMime","png","jpeg","gif","requestsCounter","beforeRequest","afterRequest","doCallbacks","callbacks","uniqueId","callResponse","exportHandler","stopCounter","connection","remoteAddress","b64","noDownload","connectionAborted","socket","hadErrors","toLowerCase","substr","pattern","isPrivateRangeUrlFound","info","removeAllListeners","from","header","attachment","filename","pkgFile","pather","serverStartTime","successRates","addHealthRoutes","setInterval","successRatio","_","period","movingAverage","reduce","a","b","bootTime","uptime","floor","highchartsVersion","averageProcessingTime","failedExports","sucessRatio","svgExportAttempts","jsonExportAttempts","activeServers","Map","express","disable","cors","_req","set","attachServerErrorHandlers","startServer","serverConfig","uploadLimitBytes","storage","multer","memoryStorage","upload","limits","fieldSize","limit","urlencoded","extended","none","httpServer","createServer","listen","cert","fsPromises","readFile","posix","httpsServer","NaN","static","healthRoute","exportRoutes","_request","sendFile","acceptRanges","uiRoute","errorHandler","closeServers","delete","getServers","enableRateLimiting","getExpress","getApp","middlewares","shutdownCleanUp","exitCode","allSettled","exit","index","initExport","loggingOptions","initLogging","code","singleExport","batchExport","batchFunctions","pair","configIndex","findIndex","arg","fileName","loadConfigFile","showUsage","propertiesChain","argumentType","pairArgumentValue","mapToNewConfig","oldOptions","manualConfig","configFileName","configFile","choice","prompts","onSubmit","p","categories","questionsCounter","allQuestions","section","prompt","answer","module","writeFile","printLogo","packageVersion"],"mappings":"0lBAeO,MAAMA,EAAe,CAC1BC,KAAM,CAAC,aAAc,kBAAmB,iBACxCC,QAAS,CACP,QACA,MACA,QACA,YACA,uBACA,gBAEA,eACA,QACA,OACA,aACA,mBACA,eACA,cACA,UACA,UACA,cACA,WACA,UACA,YACA,cACA,YACA,sBACA,SACA,SACA,WACA,aACA,YACA,eACA,yBACA,SACA,eACA,YACA,kBACA,SACA,cACA,mBACA,eACA,kBACA,cACA,eAEA,cACA,WACA,eACA,WACA,SACA,OACA,WACA,YACA,SACA,qBACA,aACA,WACA,WACA,WACA,WACA,eACA,UACA,kBACA,oBACA,aACA,UACA,cACA,YACA,YAEFC,WAAY,CAAC,kBACbC,OAAQ,CACN,wEACA,mGAMSC,EAAgB,CAC3BC,UAAW,CACTC,KAAM,CACJC,MAAO,CACL,mCACA,kBACA,0CACA,2BACA,kCACA,kCACA,wCACA,2CACA,qBACA,4BACA,2CACA,uDACA,6BACA,yBACA,0BACA,+BACA,uBACA,uFACA,yBACA,oCACA,oBACA,0BACA,8CACA,2BACA,0BACA,6BACA,mCACA,wCACA,mCACA,2BACA,kCACA,uBACA,iBACA,yBACA,8BACA,oBACA,2BACA,eACA,6BACA,iBACA,aACA,eACA,sBACA,cACA,yBACA,oBACA,uBAEFC,KAAM,WACNC,YAAa,yCAEfC,QAAS,CACPH,MAAO,SACPC,KAAM,SACNG,QAAS,qBACTF,YAAa,0DAGjBG,WAAY,CACVC,QAAS,CACPN,MAAO,SACPC,KAAM,SACNG,QAAS,qBACTF,YAAa,sCAEfK,OAAQ,CACNP,MAAO,+BACPC,KAAM,SACNG,QAAS,qBACTF,YAAa,kDAEfM,YAAa,CACXR,MAAOR,EAAaC,KACpBQ,KAAM,WACNG,QAAS,0BACTF,YAAa,yCAEfO,cAAe,CACbT,MAAOR,EAAaE,QACpBO,KAAM,WACNG,QAAS,4BACTF,YAAa,uCAEfQ,iBAAkB,CAChBV,MAAOR,EAAaG,WACpBM,KAAM,WACNG,QAAS,+BACTF,YAAa,0CAEfS,cAAe,CACbX,MAAOR,EAAaI,OACpBK,KAAM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"}